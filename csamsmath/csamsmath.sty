%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csamsmath.sty
%
% Author:  Agni Datta
% Version: 2.2 (2026/01/28)
% License: LaTeX Project Public License v1.3c or later
%
% --- PHILOSOPHY ---
% The "cs" in csamsmath stands for "Comprehensive STEM," or "Computer Science,"
% or maybe just "Can't Stop" (adding more packages to this preamble).
% Let's be honest: why call it csamsmath when amsmath is already perfect?
% Because we wanted a name so redundant it makes "PIN number" or "ATM machine"
% look like efficient communication. It's the "Department of Redundancy
% Department" of LaTeX packages.
%
% In all seriousness, csamsmath is a "batteries-included" wrapper designed to
% eliminate the "preamble-bloat" of modern STEM documents. It handles fonts,
% theorems, colored annotations, and cross-referencing so you can get back to
% proving P != NP (or finding where you missed a curly brace).
%
% --- USAGE ---
% \usepackage[<options>]{csamsmath}
%
% Options:
%   [Font Selection]
%     latinmodern (default) : Standard LaTeX look, engine-aware.
%     libertine             : Modern, highly readable serif/sans/math.
%     gfsdidot              : For that classy, old-school math vibe.
%     concrete              : Knuth's Concrete Roman (heavy and beautiful).
%     palatino              : The reliable classic (Palatino + Biolinum).
%
%   [Annotation Control]
%     printcoms (default)   : Show marginalia and author comments.
%     noprintcoms           : Shhhhh... final version (hides all comments).
%
% Theorem-like environments:
%   Provides 50+ predefined environments (theorem, lemma, definition, remark,
%   example, etc.) with consistent numbering and styling.
%
% Annotation Workflow:
%   Custom markers via \newguymarker{<cmd>}{<label>}{<color>}
%   Utility: \TODO, \fixme, \notes, \query, \changed, \added, \removed
%
% --- UNDER THE HOOD ---
% 1. The amsthm Reset:
%    Loading 'thmtools' after other packages often results in "Command \proof
%    already defined" errors. We violently \relax these commands (lines 125+)
%    to ensure csamsmath's custom logic takes precedence.
% 2. Engine Switching:
%    Uses 'iftex' to branch logic between pdfLaTeX (T1 encoding) and
%    LuaLaTeX (unicode-math/fontspec).
% 3. The Annotation Factory:
%    \newguymarker creates macros that inject color-coded text and
%    marginal stars (the "Gold Star for Effort" system).
% 4. Sectional Patching:
%    We patch \@settitle and \section via titlesec/xpatch to maintain a
%    unified aesthetic without requiring manual styling in the main document.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[2020/10/01]
\ProvidesPackage{csamsmath}[2026/01/28 v2.2 Refactored STEM package with annotations]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% OPTION PROCESSING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifcsam@latinmodern
\newif\ifcsam@libertine
\newif\ifcsam@gfsdidot
\newif\ifcsam@concrete
\newif\ifcsam@palatino
\newif\ifcsam@printcoms

%% Default: latinmodern, printcoms enabled
\csam@latinmoderntrue
\csam@printcomstrue

\DeclareOption{latinmodern}{%
    \csam@latinmoderntrue
    \csam@libertinefalse
    \csam@gfsdidotfalse
    \csam@concretefalse
    \csam@palatinofalse
}
\DeclareOption{libertine}{%
    \csam@latinmodernfalse
    \csam@libertinetrue
    \csam@gfsdidotfalse
    \csam@concretefalse
    \csam@palatinofalse
}
\DeclareOption{gfsdidot}{%
    \csam@latinmodernfalse
    \csam@libertinefalse
    \csam@gfsdidottrue
    \csam@concretefalse
    \csam@palatinofalse
}
\DeclareOption{concrete}{%
    \csam@latinmodernfalse
    \csam@libertinefalse
    \csam@gfsdidotfalse
    \csam@concretetrue
    \csam@palatinofalse
}
\DeclareOption{palatino}{%
    \csam@latinmodernfalse
    \csam@libertinefalse
    \csam@gfsdidotfalse
    \csam@concretefalse
    \csam@palatinotrue
}
\DeclareOption{printcoms}{%
    \csam@printcomstrue
}
\DeclareOption{noprintcoms}{%
    \csam@printcomsfalse
}

\ProcessOptions\relax

\makeatletter

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RESET AMSTHM TO AVOID CONFLICTS
% Clears any prior amsthm definitions before loading thmtools
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\expandafter\let\csname ver@amsthm.sty\endcsname\relax
\let\theoremstyle\relax
\let\newtheoremstyle\relax
\let\pushQED\relax
\let\popQED\relax
\let\qedhere\relax
\let\mathqed\relax
\let\openbox\relax
\let\proof\relax
\let\endproof\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% UTILITY PACKAGES
% Core infrastructure for package functionality
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{calc}
\RequirePackage{comment}
\RequirePackage{etoolbox}
\RequirePackage{ifpdf}
\RequirePackage{iftex}
\RequirePackage{xkeyval}
\RequirePackage{xparse}
\RequirePackage{xpatch}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% COLOR MANAGEMENT
% Extended color support for all document elements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[dvipsnames,table,x11names]{xcolor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PDF AND LAYOUT
% PDF versioning, compression, geometry, and page management
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[2.0,objcompress,compress]{bxpdfver}
\RequirePackage[margin=1in]{geometry}
\RequirePackage{pdfpages}
\RequirePackage{refcount}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TYPOGRAPHY AND ENCODING
% Language, encoding, micro-typography, and text enhancements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[T1]{fontenc}
\RequirePackage[USenglish]{babel}
\RequirePackage[autostyle=true,csdisplay=true]{csquotes}
\RequirePackage[final]{microtype}
\RequirePackage[full]{textcomp}
\RequirePackage{emptypage}
\RequirePackage{moresize}
\RequirePackage{paralist}
\RequirePackage{pifont}
\RequirePackage{soul}
\RequirePackage[normalem]{ulem}
\RequirePackage{xspace}
\RequirePackage{xurl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MATHEMATICS CORE
% Foundation for mathematical typesetting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{mathtools}
\RequirePackage{nicefrac}
\RequirePackage{siunitx}
\RequirePackage{mathrsfs}
\RequirePackage{amsthm}
\RequirePackage{thmtools}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FONT CONFIGURATION
% Modular font setup based on user option
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifLuaTeX
    %% LuaLaTeX branch
    \RequirePackage{lmodern}
    \RequirePackage{sansmath}
    \RequirePackage{fontspec}
    \RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
    \ifcsam@latinmodern
        %% Latin Modern (LuaLaTeX)
        \setmainfont{Latin Modern Roman}[
            Ligatures=TeX,
            SmallCapsFont=Latin Modern Roman Caps,
            RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+pnum}
        ]
        \setsansfont{Latin Modern Sans}[Scale=MatchUppercase,Ligatures=TeX]
        \setmonofont{Latin Modern Mono}[Scale=MatchLowercase,Ligatures=TeX]
        \setmathfont{Latin Modern Math}
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@libertine
        %% Libertinus (LuaLaTeX)
        \setmainfont{Libertinus Serif}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmathfont{Libertinus Math}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setsansfont{Libertinus Sans}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmonofont{Latin Modern Mono}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@gfsdidot
        %% GFS Didot + Libertinus Sans (LuaLaTeX)
        \RequirePackage[gfsdidot]{fontsetup}
        \setsansfont{Libertinus Sans}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@concrete
        %% Concrete (LuaLaTeX)
        \RequirePackage[concrete]{fontsetup}
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@palatino
        %% Palatino + Biolinum (LuaLaTeX)
        \setmainfont{TeX Gyre Pagella}[Ligatures=TeX]
        \setsansfont{Libertinus Sans}[Scale=MatchUppercase,Ligatures=TeX]
        \setmonofont{Latin Modern Mono}[Scale=MatchLowercase,Ligatures=TeX]
        \setmathfont{TeX Gyre Pagella Math}
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
\else
    %% pdfLaTeX branch
    \ifcsam@latinmodern
        %% Latin Modern (pdfLaTeX)
        \RequirePackage{lmodern}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@libertine
        %% Libertinus (pdfLaTeX)
        \RequirePackage{lmodern}
        \RequirePackage{libertineRoman}
        \RequirePackage[libertine,varbb]{newtxmath}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@gfsdidot
        %% GFS Didot + Libertinus Sans (pdfLaTeX)
        \RequirePackage{lmodern}
        \RequirePackage{libertinust1math}
        \RequirePackage[default]{gfsdidot}
        \RequirePackage{biolinum}
        \renewcommand{\sfdefault}{LinuxBiolinumT-TLF}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@concrete
        %% Concrete (pdfLaTeX)
        \RequirePackage{ccfonts}
        \RequirePackage{concmath}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
    \ifcsam@palatino
        %% Palatino + Biolinum (pdfLaTeX)
        \RequirePackage{biolinum}
        \RequirePackage{tgpagella}
        \RequirePackage[sc]{mathpazo}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GRAPHICS AND FLOATS
% Comprehensive float and graphics support
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{graphicx}
\RequirePackage{floatrow}
\RequirePackage{placeins}
\RequirePackage{rotating}
\RequirePackage{pdflscape}
\RequirePackage{caption}
\RequirePackage{subcaption}
\RequirePackage{wrapfig}
\RequirePackage{adjustbox}
\RequirePackage{dashbox}
\RequirePackage{fancybox}
\RequirePackage{framed}

%% Caption styling applied at document start
\AtBeginDocument{%
    \captionsetup{%
        font={sf,small},
        labelfont={color=black,sc,small},
        labelsep=period,
        skip=5pt,
        justification=justified
    }%
    \captionsetup[table]{position=bottom,skip=5pt}%
    \captionsetup[figure]{position=bottom,skip=5pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TABLE PACKAGES
% Comprehensive table construction and styling
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{array}
\RequirePackage{tabularx}
\RequirePackage{tabularray}
\RequirePackage{longtable}
\RequirePackage{xtab}
\RequirePackage{booktabs}
\RequirePackage{hhline}
\RequirePackage{colortbl}
\RequirePackage{makecell}
\RequirePackage{multirow}
\RequirePackage{diagbox}
\RequirePackage{threeparttable}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TEXT LAYOUT
% Multi-column layouts, alignment, verbatim, rules
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{multicol}
\RequirePackage{ragged2e}
\RequirePackage{verbatim}
\RequirePackage{xhfill}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LIST ENVIRONMENTS
% Customized enumerate and itemize with enumitem
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{enumitem}
\setlist{nosep}
\setlist[enumerate,1]{label=(\arabic*)}
\setlist[enumerate,2]{label=(\alph*)}
\setlist[enumerate,3]{label=(\Roman*)}
\setlist[itemize,1]{label=\ensuremath{\text{-}}}
\setlist[itemize,2]{label=\ensuremath{\bullet}}
\setlist[itemize,3]{label=\ensuremath{\circ}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HYPERLINKS AND CROSS-REFERENCES
% Hyperref configuration and cleveref integration
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{nameref}
\RequirePackage[
    bookmarksnumbered=true,
    breaklinks=true,
    citecolor=MidnightBlue,
    colorlinks=true,
    linkcolor=MidnightBlue,
    pagebackref,
    pdfencoding=auto,
    pdfpagelabels=true,
    pdfpagelayout=SinglePage,
    pdfstartview=FitH,
    pdfusetitle,
    unicode=true,
    urlcolor=MidnightBlue
]{hyperref}
\RequirePackage[nameinlink,capitalise,noabbrev]{cleveref}
\RequirePackage{xr}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TITLE PATCH
% Adjust title formatting to small caps; apply line spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*\csamsmath@patchtitle{%
    \@ifundefined{@settitle}{}{%
        \xpatchcmd{\@settitle}{\uppercasenonmath\@title}{\normalfont\scshape\Large}{}{}%
    }%
    \RequirePackage{setspace}\setstretch{1.10}%
}
\csamsmath@patchtitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BIBLIOGRAPHY BACKREF FORMATTING
% Customizes page back-references in bibliography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
    \ifcase #1\or (Cited on p.~#2).%
    \else (Cited on pp.~#2).%
    \fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% THEOREM SYSTEM CONFIGURATION
% Declares theorem styles and environments via thmtools
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Number equations within sections
\numberwithin{equation}{section}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% STYLE DEFINITIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Theorem-like style: bold head, normal body
\declaretheoremstyle[%
    headfont=\bfseries,
    notefont=\normalfont\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@theoremlike}

%% Definition-like style: bold head, normal body
\declaretheoremstyle[%
    headfont=\bfseries,
    notefont=\normalfont\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@definitionlike}

%% Remark-like style: small caps head, normal body
\declaretheoremstyle[%
    headfont=\normalfont\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@remarklike}

%% Highlight-like style: sans-serif bold head, normal body
\declaretheoremstyle[%
    headfont=\normalfont\sffamily,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@highlightlike}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% BASE THEOREM ENVIRONMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\declaretheorem[%
    name=Theorem,
    style=csam@theoremlike,
    numberwithin=section
]{theorem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HELPER: DECLARE SIBLING ENVIRONMENTS
%% \csam@declaretheoremfamily{style}{csv-list}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand\csam@declaretheoremfamily[2]{%
    \forcsvlist{\declaretheorem[sibling=theorem,style=#1]}{#2}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% THEOREM-LIKE ENVIRONMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@declaretheoremfamily{csam@theoremlike}{%
    assertion,assumption,axiom,claim,conclusion,conjecture,corollary,%
    criterion,fact,folklore,hypothesis,lemma,observation,postulate,%
    property,proposition%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DEFINITION-LIKE ENVIRONMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@declaretheoremfamily{csam@definitionlike}{%
    application,construction,convention,definition,example,experiment,%
    problem,protocol,result,solution,step,notation%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% REMARK-LIKE ENVIRONMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@declaretheoremfamily{csam@remarklike}{%
    commentary,discussion,exercise,motivation,notationabuse,note,%
    openproblem,question,remark,syntax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HIGHLIGHT-LIKE ENVIRONMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@declaretheoremfamily{csam@highlightlike}{%
    guideline,highlight,important,insight,keypoint,recall,summary,%
    takeaway,tip,warning%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% UNNUMBERED REPRESENTATIVE ENVIRONMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\declaretheorem[name=Theorem,style=csam@theoremlike,numbered=no]{theorem*}
\declaretheorem[name=Lemma,style=csam@theoremlike,numbered=no]{lemma*}
\declaretheorem[name=Corollary,style=csam@theoremlike,numbered=no]{corollary*}
\declaretheorem[name=Hypothesis,style=csam@theoremlike,numbered=no]{hypothesis*}
\declaretheorem[name=Claim,style=csam@theoremlike,numbered=no]{claim*}
\declaretheorem[name=Conjecture,style=csam@theoremlike,numbered=no]{conjecture*}
\declaretheorem[name=Open Problem,style=csam@remarklike,numbered=no]{openproblem*}
\declaretheorem[name=Syntax,style=csam@remarklike,numbered=no]{syntax*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PROOF ENVIRONMENT
%% Custom proof with QED symbol
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\let\proof\relax
\let\endproof\relax

\declaretheoremstyle[%
    headfont=\itshape,
    bodyfont=\normalfont,
    spaceabove=5pt,
    spacebelow=5pt,
    headpunct={.},
    postheadspace=0.5em,
    qed=\ensuremath{\scriptstyle\square}
]{csam@proofstyle}

\declaretheorem[name=Proof,style=csam@proofstyle,numbered=no]{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% CLEVEREF NAMES
% Assigns readable cross-reference labels via loop
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Sectional units
\crefname{section}{\textsection}{\textsection\textsection}
\Crefname{section}{\textsection}{\textsection\textsection}
\crefname{subsection}{\textsection}{\textsection\textsection}
\Crefname{subsection}{\textsection}{\textsection\textsection}
\crefname{subsubsection}{\textsection}{\textsection\textsection}
\Crefname{subsubsection}{\textsection}{\textsection\textsection}
\crefname{paragraph}{paragraph}{paragraphs}
\Crefname{paragraph}{Paragraph}{Paragraphs}
\crefname{subparagraph}{subparagraph}{subparagraphs}
\Crefname{subparagraph}{Subparagraph}{Subparagraphs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HELPER: BULK CREF ASSIGNMENT
%% \csam@setcrefnames{envname/singular/plural, ...}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand\csam@setcrefnames[1]{%
    \forcsvlist{\csam@setcrefname@single}{#1}%
}
\def\csam@setcrefname@single#1{%
    \csam@setcrefname@parse#1\csam@nil
}
\def\csam@setcrefname@parse#1/#2/#3\csam@nil{%
    \crefname{#1}{#2}{#3}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% THEOREM-LIKE CREF NAMES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@setcrefnames{%
    theorem/Theorem/Theorems,%
    assertion/Assertion/Assertions,%
    assumption/Assumption/Assumptions,%
    axiom/Axiom/Axioms,%
    claim/Claim/Claims,%
    conclusion/Conclusion/Conclusions,%
    conjecture/Conjecture/Conjectures,%
    corollary/Corollary/Corollaries,%
    criterion/Criterion/Criteria,%
    fact/Fact/Facts,%
    folklore/Folklore/Folklore,%
    hypothesis/Hypothesis/Hypotheses,%
    lemma/Lemma/Lemmas,%
    observation/Observation/Observations,%
    postulate/Postulate/Postulates,%
    property/Property/Properties,%
    proposition/Proposition/Propositions%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DEFINITION-LIKE CREF NAMES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@setcrefnames{%
    application/Application/Applications,%
    construction/Construction/Constructions,%
    convention/Convention/Conventions,%
    definition/Definition/Definitions,%
    example/Example/Examples,%
    experiment/Experiment/Experiments,%
    problem/Problem/Problems,%
    protocol/Protocol/Protocols,%
    result/Result/Results,%
    solution/Solution/Solutions,%
    step/Step/Steps,%
    notation/Notation/Notations%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% REMARK-LIKE CREF NAMES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@setcrefnames{%
    commentary/Commentary/Commentaries,%
    discussion/Discussion/Discussions,%
    exercise/Exercise/Exercises,%
    motivation/Motivation/Motivations,%
    notationabuse/Notation abuse/Notation abuses,%
    note/Note/Notes,%
    openproblem/Open problem/Open problems,%
    question/Question/Questions,%
    remark/Remark/Remarks,%
    syntax/Syntax/Syntaxes%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HIGHLIGHT-LIKE CREF NAMES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@setcrefnames{%
    guideline/Guideline/Guidelines,%
    highlight/Highlight/Highlights,%
    important/Important point/Important points,%
    insight/Insight/Insights,%
    keypoint/Key point/Key points,%
    recall/Recall/Recalls,%
    summary/Summary/Summaries,%
    takeaway/Takeaway/Takeaways,%
    tip/Tip/Tips,%
    warning/Warning/Warnings%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PROOF CREF NAME
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\csam@setcrefnames{proof/Proof/Proofs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% SECTION FORMATTING
% Customizes the appearance of sectional units
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{titlesec}

%% Section: bold, large
\titleformat{\section}
{\normalfont\bfseries\Large}
{\thesection\ }{5pt}{}

%% Subsection: bold, large
\titleformat{\subsection}
{\bfseries\large}
{\thesubsection\ }{7.5pt}{}

%% Subsubsection: bold, run-in
\titleformat{\subsubsection}[runin]
{\bfseries\normalsize}
{\thesubsubsection.\ }{0.75em}{}[.\ ]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TITLE PAGE CONFIGURATION
% Applies hep-title styling for author and title blocks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{hep-title}
\titlefont{\bfseries\Large}
\subtitlefont{\bfseries\large}
\seriesfont{\itshape}
\authorfont{\normalsize}
\affiliationfont{\small\scshape}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PARAGRAPH HEADINGS WITH AUTO-PUNCTUATION
% Provides \parhead{text} that appends period if missing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Internal flag for punctuation detection
\newif\ifcsam@haspunctuation

%% Check if second argument is empty
\def\csam@checkpunctuation#1{%
    \ifx\csam@checkpunctuation#1\csam@checkpunctuation
    \else
        \csam@haspunctuationtrue
    \fi
}

%% Punctuation testers for '.', '?', '!', ':'
\def\csam@checkdot#1.\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}
\def\csam@checkquestion#1?\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}
\def\csam@checkexclam#1!\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}
\def\csam@checkcolon#1:\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}

%% Main interface: appends period unless argument ends with '.', '?', '!', ':'
\def\csam@appendpunctuationifneeded#1{%
    \csam@haspunctuationfalse
    \csam@checkdot#1\csam@delim.\csam@delim\csam@stop
    \csam@checkquestion#1\csam@delim?\csam@delim\csam@stop
    \csam@checkexclam#1\csam@delim!\csam@delim\csam@stop
    \csam@checkcolon#1\csam@delim:\csam@delim\csam@stop
    #1\ifcsam@haspunctuation \else.\fi%
}

%% Skip spaces and implicit paragraph breaks
\def\csam@ignorewhitespaceandimplicitpars{%
\begingroup
\catcode13=10 %
\@ifnextchar\relax
    {\endgroup}
    {\endgroup}}%

    %% Skip spaces, implicit paragraphs, and explicit \par
    \def\csam@ignoreallpars{%
    \begingroup
    \catcode13=10 %
    \@ifnextchar\par
        {\endgroup\expandafter\csam@ignoreallpars\@gobble}
        {\endgroup}}%

        %% Section-style paragraph heading with auto-punctuation and spacing
        \NewDocumentCommand{\csam@paragraphhead}{m}{%
            \smallskip
            \noindent
            \textbf{\boldmath\ignorespaces\csam@appendpunctuationifneeded{#1}}%
            \hskip 0.9em plus 0.3em minus 0.3em
            \csam@ignorewhitespaceandimplicitpars
        }

        %% User command
        \NewDocumentCommand{\parhead}{m}{\csam@paragraphhead{#1}}

        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        % BROKEN REFERENCE MARKERS
        % Visually flags undefined citations and references with margin notes
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

        %% Requires marginnote package
        \RequirePackage{marginnote}

        %% Define color for markers (if \csam@colorize undefined, use red)
        \providecommand{\csam@colorize}{\color{Firebrick2}}

        %% Internal marker command
        \newcommand{\csam@brokenrefmark}[1]{%
            \marginnote[%
                {\csam@colorize\normalfont\smash{\LARGE$\star$}\ \tiny\sffamily#1}%
            ]{%
                {\csam@colorize\normalfont\smash{\LARGE$\star$}\ \tiny\sffamily#1}%
            }%
        }

        %% Toggle for marking undefined references
        \newbool{csam@markundef}
        \booltrue{csam@markundef}

        %% Hook into undefined citation flag
        \xpretocmd{\G@refundefinedtrue}{%
            \ifbool{csam@markundef}{%
                \csam@brokenrefmark{\@ifundefined{@citeb}{}{\@citeb}}%
            }{}%
        }{}{}

        %% Patch \@setref to mark broken references
        \let\csam@old@setref=\@setref
        \renewcommand{\@setref}[3]{%
            \ifx#1\relax \csam@brokenrefmark{#3}\fi%
            \csam@markundeffalse%
            \csam@old@setref{#1}{#2}{#3}%
            \csam@markundeftrue%
        }

        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        % ANNOTATION AND COLLABORATION SYSTEM
        % Generic command framework for multi-author annotations with color markers
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

        % REQUIRED PACKAGES FOR ANNOTATION SYSTEM
        \RequirePackage[most]{tcolorbox}
        \RequirePackage[%
            skipabove=10pt,
            skipbelow=10pt,
            ntheorem,
            framemethod=TikZ
        ]{mdframed}

        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        % CORE ANNOTATION COMMAND GENERATOR
        % Syntax: \newguymarker{commandname}{displayname}{color}
        % Always uses large star in margin, no bold, small caps preferred
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        \NewDocumentCommand{\newguymarker}{m m m}{%
            \ifcsam@printcoms
                \expandafter\newcommand\csname #1\endcsname[1]{%
                    \textcolor{#3}{##1\ \textsc{#2}}%
                    \marginnote{\textcolor{#3}{\LARGE$\star$}}%
                }%
            \else
                \expandafter\newcommand\csname #1\endcsname[1]{}%
            \fi
        }

        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        % CONTENT AND WORKFLOW ANNOTATIONS
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        \ifcsam@printcoms
            \providecommand{\missing}[1]{%
                \textcolor{Crimson}{#1}%
                \marginnote{\textcolor{Crimson}{\LARGE$\star$}}%
            }
        \else
            \providecommand{\missing}[1]{}
        \fi

        % Workflow markers
        \providecommand{\todo}[1]{%
            \textcolor{Red}{[\textsc{To-do}: #1]}%
            \marginnote{\textcolor{Red}{\LARGE$\star$}}%
        }
        \providecommand{\fixme}[1]{%
            \textcolor{OrangeRed}{[\textsc{Fix-me}: #1]}%
            \marginnote{\textcolor{OrangeRed}{\LARGE$\star$}}%
        }
        \providecommand{\notes}[1]{%
            \textcolor{ForestGreen}{[\textsc{Do-note}: #1]}%
            \marginnote{\textcolor{ForestGreen}{\LARGE$\star$}}%
        }
        \providecommand{\query}[1]{%
            \textcolor{Purple}{[\textsc{q}: #1]}%
            \marginnote{\textcolor{Purple}{\LARGE$\star$}}%
        }
    \else
        \providecommand{\todo}[1]{}
        \providecommand{\fixme}[1]{}
        \providecommand{\notes}[1]{}
        \providecommand{\query}[1]{}
    \fi

    % Revision tracking
    \providecommand{\changed}[1]{%
        \textcolor{blue}{#1}%
        \marginnote{\textcolor{blue}{\LARGE$\star$}}%
    }
    \providecommand{\added}[1]{%
        \textcolor{OliveGreen}{#1}%
        \marginnote{\textcolor{OliveGreen}{\LARGE$\star$}}%
    }
    \providecommand{\removed}[1]{%
        \textcolor{Gray}{\sout{#1}}%
        \marginnote{\textcolor{Gray}{\LARGE$\star$}}%
    }
\else
    \providecommand{\changed}[1]{#1}
    \providecommand{\added}[1]{#1}
    \providecommand{\removed}[1]{}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DOCUMENT FORMATTING OVERRIDES
% Customized sectioning and emphasis commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AtBeginDocument{%
    \renewcommand{\paragraph}[1]{\parhead{#1}}%
    \renewcommand{\subparagraph}[1]{\noindent\textsc{#1}}%
    \renewcommand{\Pr}{\mathop{\mathsf{Pr}}}%
}

\makeatother
\endinput