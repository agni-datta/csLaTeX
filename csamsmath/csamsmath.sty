% csamsmath.sty
% Comprehensive STEM Mathematics Package
% 
% Copyright (c) 2026 Agni Datta
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3c
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2005/12/01 or later.

\NeedsTeXFormat{LaTeX2e}[2020/10/01]
\ProvidesPackage{csamsmath}[2026/01/29 v2.3 Comprehensive STEM package with annotations]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PACKAGE OVERVIEW
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csamsmath provides a unified framework for STEM document preparation,
% integrating typography, mathematics, theorem environments, and collaborative
% annotation tools. The package eliminates preamble bloat by bundling
% commonly-used packages with sensible defaults.
%
% KEY FEATURES:
%   - Engine-aware font configuration (pdfLaTeX/LuaLaTeX)
%   - 50+ predefined theorem-like environments
%   - Collaborative annotation system with visual markers
%   - Automatic broken reference detection
%   - Consistent cross-referencing with cleveref
%   - Professional typography with microtype
%
% USAGE:
%   \usepackage[<options>]{csamsmath}
%
% OPTIONS:
%   Font Selection (mutually exclusive):
%     latinmodern (default) - Computer Modern successor, excellent rendering
%     libertine             - Modern Libertinus family with superior readability
%     gfsdidot              - Classical Greek Font Society Didot
%     concrete              - Knuth's Concrete Roman, distinctive appearance
%     palatino              - Palatino with harmonious sans-serif pairing
%
%   Annotation Control:
%     printcoms (default)   - Display all collaboration annotations
%     noprintcoms           - Suppress annotations for final documents
%
% THEOREM ENVIRONMENTS:
%   Numbered (within section): theorem, lemma, corollary, proposition,
%   definition, example, remark, and 40+ additional environments
%
%   Unnumbered variants: theorem*, lemma*, corollary*, etc.
%
% ANNOTATION COMMANDS:
%   \newguymarker{cmd}{label}{color} - Define custom annotation commands
%   \todo{text}      - Mark incomplete sections
%   \fixme{text}     - Flag corrections needed
%   \notes{text}     - Add editorial notes
%   \query{text}     - Pose questions to collaborators
%   \changed{text}   - Highlight modifications
%   \added{text}     - Mark new content
%   \removed{text}   - Strike through deleted content
%
% DEPENDENCIES:
%   Core: amsmath, amsthm, thmtools, xcolor, hyperref, cleveref
%   Typography: microtype, fontenc/fontspec (engine-dependent)
%   Graphics: graphicx, caption, subcaption
%   Tables: booktabs, array, tabularx
%
% TECHNICAL NOTES:
%   1. Package loads amsthm via thmtools to avoid command conflicts
%   2. Font loading branches on \ifLuaTeX for optimal engine support
%   3. Hyperref loaded late with conservative settings
%   4. Caption formatting deferred to \AtBeginDocument for compatibility
%
% AUTHOR: Agni Datta
% VERSION: 2.3 (2026/01/29)
% LICENSE: LPPL v1.3c or later
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{etoolbox}
\RequirePackage{iftex}
\RequirePackage{xkeyval}
\RequirePackage{xparse}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% OPTION PROCESSING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Implements mutually exclusive font options and annotation toggle.
% Default configuration: latinmodern font, annotations enabled.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifcsam@latinmodern
\newif\ifcsam@libertine
\newif\ifcsam@gfsdidot
\newif\ifcsam@concrete
\newif\ifcsam@palatino
\newif\ifcsam@printcoms

% Set defaults
\csam@latinmoderntrue
\csam@printcomstrue

% Font option declarations
\DeclareOption{latinmodern}{%
    \csam@latinmoderntrue
    \csam@libertinefalse
    \csam@gfsdidotfalse
    \csam@concretefalse
    \csam@palatinofalse
}
\DeclareOption{libertine}{%
    \csam@latinmodernfalse
    \csam@libertinetrue
    \csam@gfsdidotfalse
    \csam@concretefalse
    \csam@palatinofalse
}
\DeclareOption{gfsdidot}{%
    \csam@latinmodernfalse
    \csam@libertinefalse
    \csam@gfsdidottrue
    \csam@concretefalse
    \csam@palatinofalse
}
\DeclareOption{concrete}{%
    \csam@latinmodernfalse
    \csam@libertinefalse
    \csam@gfsdidotfalse
    \csam@concretetrue
    \csam@palatinofalse
}
\DeclareOption{palatino}{%
    \csam@latinmodernfalse
    \csam@libertinefalse
    \csam@gfsdidotfalse
    \csam@concretefalse
    \csam@palatinotrue
}

% Annotation control
\DeclareOption{printcoms}{\csam@printcomstrue}
\DeclareOption{noprintcoms}{\csam@printcomsfalse}

\ProcessOptions\relax

\makeatletter

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% THEOREM SYSTEM RESET
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Clears amsthm definitions to prevent conflicts with thmtools.
% This allows clean redefinition of theorem styles and proof environment.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\expandafter\let\csname ver@amsthm.sty\endcsname\relax
\let\theoremstyle\relax
\let\newtheoremstyle\relax
\let\pushQED\relax
\let\popQED\relax
\let\qedhere\relax
\let\mathqed\relax
\let\openbox\relax
\let\proof\relax
\let\endproof\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% UTILITY PACKAGES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core infrastructure packages for programming, conditionals, and utilities.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{calc}
\RequirePackage{comment}
\RequirePackage{ifpdf}
\RequirePackage{xpatch}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% COLOR SUPPORT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Loads xcolor with comprehensive color name collections for annotations
% and theorem highlighting.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[dvipsnames,table,x11names]{xcolor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PDF CONFIGURATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Sets PDF version, enables compression, and configures page layout.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[2.0,objcompress,compress]{bxpdfver}
\RequirePackage[margin=1in]{geometry}
\RequirePackage{pdfpages}
\RequirePackage{refcount}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TYPOGRAPHY CORE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fundamental typography packages for encoding, language support,
% microtypography, and text enhancements.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[T1]{fontenc}
\RequirePackage[USenglish]{babel}
\RequirePackage[autostyle=true,csdisplay=true]{csquotes}
\RequirePackage[final]{microtype}
\RequirePackage[full]{textcomp}
\RequirePackage[normalem]{ulem}
\RequirePackage{emptypage}
\RequirePackage{moresize}
\RequirePackage{paralist}
\RequirePackage{pifont}
\RequirePackage{soul}
\RequirePackage{xspace}
\RequirePackage{xurl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MATHEMATICS FOUNDATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core mathematical typesetting packages. Order matters: amsmath before
% mathtools, amsthm loaded via thmtools.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{mathrsfs}
\RequirePackage{mathtools}
\RequirePackage{nicefrac}
\RequirePackage{siunitx}
\RequirePackage{thmtools}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FONT CONFIGURATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Engine-aware font loading with feature-rich OpenType setup for LuaLaTeX
% and package-based configuration for pdfLaTeX.
%
% Font selection affects:
%   - Text fonts (roman, sans, mono)
%   - Math fonts and alphabets
%   - OpenType features (ligatures, numerals, kerning)
%
% Design rationale:
%   - LuaLaTeX: Native Unicode support via fontspec/unicode-math
%   - pdfLaTeX: Traditional NFSS with specialized math packages
%   - All configurations include mathalpha for consistent script/calligraphic
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifLuaTeX
    % LuaLaTeX font configuration
    \RequirePackage{lmodern}
    \RequirePackage{sansmath}
    \RequirePackage{fontspec}
    \RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}

    \ifcsam@latinmodern
        \setmainfont{Latin Modern Roman}[
            Ligatures=TeX,
            SmallCapsFont=Latin Modern Roman Caps,
            RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+pnum}
        ]
        \setsansfont{Latin Modern Sans}[Scale=MatchUppercase,Ligatures=TeX]
        \setmonofont{Latin Modern Mono}[Scale=MatchLowercase,Ligatures=TeX]
        \setmathfont{Latin Modern Math}[AutoFakeBold,AutoFakeSlant]
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@libertine
        \setmainfont{Libertinus Serif}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmathfont{Libertinus Math}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setsansfont{Libertinus Sans}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmonofont{Noto Sans Mono}[
            Scale=MatchLowercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@gfsdidot
        \RequirePackage[gfsdidot]{fontsetup}
        \setsansfont{Libertinus Sans}[
            Scale=MatchUppercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmonofont{Noto Sans Mono}[
            Scale=MatchLowercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@concrete
        \RequirePackage[concrete]{fontsetup}
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@palatino
        \setmainfont{TeX Gyre Pagella}[Ligatures=TeX]
        \setsansfont{Libertinus Sans}[Scale=MatchUppercase,Ligatures=TeX]
        \setmonofont{Noto Sans Mono}[Scale=MatchLowercase,Ligatures=TeX]
        \setmathfont{TeX Gyre Pagella Math}[AutoFakeBold,AutoFakeSlant]
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
\else
    % pdfLaTeX font configuration
    \ifcsam@latinmodern
        \RequirePackage{lmodern}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@libertine
        \RequirePackage{lmodern}
        \RequirePackage{biolinum}
        \RequirePackage{libertineRoman}
        \RequirePackage[libertine,varbb]{newtxmath}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@gfsdidot
        \RequirePackage{lmodern}
        \RequirePackage{libertinust1math}
        \RequirePackage{gfsdidot}
        \RequirePackage{biolinum}
        \renewcommand{\sfdefault}{LinuxBiolinumT-TLF}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@concrete
        \RequirePackage{ccfonts}
        \RequirePackage{concmath}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi

    \ifcsam@palatino
        \RequirePackage{biolinum}
        \RequirePackage{tgpagella}
        \RequirePackage[sc]{mathpazo}
        \RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}
    \fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GRAPHICS AND FLOAT MANAGEMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Comprehensive float handling with caption customization, subfigure support,
% and rotation capabilities.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{adjustbox}
\RequirePackage{caption}
\RequirePackage{dashbox}
\RequirePackage{fancybox}
\RequirePackage{floatrow}
\RequirePackage{framed}
\RequirePackage{graphicx}
\RequirePackage{pdflscape}
\RequirePackage{placeins}
\RequirePackage{rotating}
\RequirePackage{subcaption}
\RequirePackage{wrapfig}

% Caption styling deferred to document start for package compatibility
\AtBeginDocument{%
    \captionsetup{%
        font={sf,small},
        labelfont={color=black,sc,small},
        labelsep=period,
        skip=5pt,
        justification=justified
    }%
    \captionsetup[table]{position=bottom,skip=5pt}%
    \captionsetup[figure]{position=bottom,skip=5pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TABLE SUPPORT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Comprehensive table construction packages with professional styling via
% booktabs and advanced layout control.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{array}
\RequirePackage{booktabs}
\RequirePackage{colortbl}
\RequirePackage{diagbox}
\RequirePackage{hhline}
\RequirePackage{longtable}
\RequirePackage{makecell}
\RequirePackage{multirow}
\RequirePackage{tabularray}
\RequirePackage{tabularx}
\RequirePackage{threeparttable}
\RequirePackage{xtab}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TEXT LAYOUT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Multi-column environments, alignment control, and verbatim text handling.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{multicol}
\RequirePackage{ragged2e}
\RequirePackage{verbatim}
\RequirePackage{xhfill}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LIST CUSTOMIZATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Configures enumerate and itemize environments with compact spacing and
% hierarchical label schemes.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{enumitem}
\setlist{nosep}
\setlist[enumerate,1]{label=(\arabic*)}
\setlist[enumerate,2]{label=(\alph*)}
\setlist[enumerate,3]{label=(\Roman*)}
\setlist[itemize,1]{label=\ensuremath{\text{-}}}
\setlist[itemize,2]{label=\ensuremath{\bullet}}
\setlist[itemize,3]{label=\ensuremath{\circ}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HYPERLINKS AND CROSS-REFERENCING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Configures hyperref with conservative settings and integrates cleveref
% for intelligent cross-reference formatting.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{nameref}
\RequirePackage[
    bookmarksnumbered=true,
    breaklinks=true,
    citecolor=MidnightBlue,
    colorlinks=true,
    linkcolor=MidnightBlue,
    pagebackref,
    pdfencoding=auto,
    pdfpagelabels=true,
    pdfpagelayout=SinglePage,
    pdfstartview=FitH,
    pdfusetitle,
    unicode=true,
    urlcolor=MidnightBlue
]{hyperref}
\RequirePackage[nameinlink,capitalise,noabbrev]{cleveref}
\RequirePackage{xr}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TITLE FORMATTING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Patches title command to use small caps and sets document line spacing.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand*\csamsmath@patchtitle{%
    \@ifundefined{@settitle}{}{%
        \xpatchcmd{\@settitle}{\uppercasenonmath\@title}{\normalfont\scshape\Large}{}{}%
    }%
    \RequirePackage{setspace}\setstretch{1.10}%
}
\csamsmath@patchtitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BIBLIOGRAPHY BACKREFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Customizes bibliography back-references to show citation locations.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
    \ifcase #1\or (Cited on p.~#2).%
    \else (Cited on pp.~#2).%
    \fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% THEOREM SYSTEM
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Declares theorem styles and environments using thmtools.
%
% Organizational structure:
%   - Base theorem environment numbered within sections
%   - Related environments share numbering via sibling mechanism
%   - Four distinct visual styles for semantic grouping
%   - Unnumbered starred variants for named results
%
% Style hierarchy:
%   1. theoremlike: Bold head for statements requiring proof
%   2. definitionlike: Bold head for introducing concepts
%   3. remarklike: Small caps for observations and notes
%   4. highlightlike: Sans-serif for pedagogical emphasis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Number equations within sections
\numberwithin{equation}{section}

% Theorem style definitions
\declaretheoremstyle[%
    headfont=\bfseries,
    notefont=\normalfont\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@theoremlike}

\declaretheoremstyle[%
    headfont=\bfseries,
    notefont=\normalfont\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@definitionlike}

\declaretheoremstyle[%
    headfont=\normalfont\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@remarklike}

\declaretheoremstyle[%
    headfont=\normalfont\sffamily,
    bodyfont=\normalfont,
    spaceabove=3pt,
    spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@highlightlike}

% Base theorem environment
\declaretheorem[%
    name=Theorem,
    style=csam@theoremlike,
    numberwithin=section
]{theorem}

% Helper macro for declaring sibling environments
\newcommand\csam@declaretheoremfamily[2]{%
    \forcsvlist{\declaretheorem[sibling=theorem,style=#1]}{#2}%
}

% Theorem-like environments (require proof)
\csam@declaretheoremfamily{csam@theoremlike}{%
    assertion,assumption,axiom,claim,conclusion,conjecture,corollary,%
    criterion,fact,folklore,hypothesis,lemma,observation,postulate,%
    property,proposition%
}

% Definition-like environments (introduce concepts)
\csam@declaretheoremfamily{csam@definitionlike}{%
    application,construction,convention,definition,example,experiment,%
    problem,protocol,result,solution,step,notation%
}

% Remark-like environments (observations and commentary)
\csam@declaretheoremfamily{csam@remarklike}{%
    commentary,discussion,exercise,motivation,notationabuse,note,%
    openproblem,question,remark,syntax%
}

% Highlight-like environments (pedagogical emphasis)
\csam@declaretheoremfamily{csam@highlightlike}{%
    guideline,highlight,important,insight,keypoint,recall,summary,%
    takeaway,tip,warning%
}

% Unnumbered theorem variants
\declaretheorem[name=Theorem,style=csam@theoremlike,numbered=no]{theorem*}
\declaretheorem[name=Lemma,style=csam@theoremlike,numbered=no]{lemma*}
\declaretheorem[name=Corollary,style=csam@theoremlike,numbered=no]{corollary*}
\declaretheorem[name=Hypothesis,style=csam@theoremlike,numbered=no]{hypothesis*}
\declaretheorem[name=Claim,style=csam@theoremlike,numbered=no]{claim*}
\declaretheorem[name=Conjecture,style=csam@theoremlike,numbered=no]{conjecture*}
\declaretheorem[name=Open Problem,style=csam@remarklike,numbered=no]{openproblem*}
\declaretheorem[name=Syntax,style=csam@remarklike,numbered=no]{syntax*}

% Proof environment with QED symbol
\let\proof\relax
\let\endproof\relax

\declaretheoremstyle[%
    headfont=\itshape,
    bodyfont=\normalfont,
    spaceabove=5pt,
    spacebelow=5pt,
    headpunct={.},
    postheadspace=0.5em,
    qed=\ensuremath{\scriptstyle\square}
]{csam@proofstyle}

\declaretheorem[name=Proof,style=csam@proofstyle,numbered=no]{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% CLEVEREF CONFIGURATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Assigns human-readable names to all cross-reference types.
% Uses loop macro for efficient bulk assignment.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Sectional units
\crefname{section}{\textsection}{\textsection\textsection}
\Crefname{section}{\textsection}{\textsection\textsection}
\crefname{subsection}{\textsection}{\textsection\textsection}
\Crefname{subsection}{\textsection}{\textsection\textsection}
\crefname{subsubsection}{\textsection}{\textsection\textsection}
\Crefname{subsubsection}{\textsection}{\textsection\textsection}
\crefname{paragraph}{paragraph}{paragraphs}
\Crefname{paragraph}{Paragraph}{Paragraphs}
\crefname{subparagraph}{subparagraph}{subparagraphs}
\Crefname{subparagraph}{Subparagraph}{Subparagraphs}

% Bulk cref name assignment helper
\newcommand\csam@setcrefnames[1]{%
    \forcsvlist{\csam@setcrefname@single}{#1}%
}
\def\csam@setcrefname@single#1{%
    \csam@setcrefname@parse#1\csam@nil
}
\def\csam@setcrefname@parse#1/#2/#3\csam@nil{%
    \crefname{#1}{#2}{#3}%
}

% Theorem environment names
\csam@setcrefnames{%
    application/Application/Applications,%
    assertion/Assertion/Assertions,%
    assumption/Assumption/Assumptions,%
    axiom/Axiom/Axioms,%
    claim/Claim/Claims,%
    commentary/Commentary/Commentaries,%
    conclusion/Conclusion/Conclusions,%
    conjecture/Conjecture/Conjectures,%
    construction/Construction/Constructions,%
    convention/Convention/Conventions,%
    corollary/Corollary/Corollaries,%
    criterion/Criterion/Criteria,%
    definition/Definition/Definitions,%
    discussion/Discussion/Discussions,%
    example/Example/Examples,%
    exercise/Exercise/Exercises,%
    experiment/Experiment/Experiments,%
    fact/Fact/Facts,%
    folklore/Folklore/Folklore,%
    guideline/Guideline/Guidelines,%
    highlight/Highlight/Highlights,%
    hypothesis/Hypothesis/Hypotheses,%
    important/Important point/Important points,%
    insight/Insight/Insights,%
    keypoint/Key point/Key points,%
    lemma/Lemma/Lemmas,%
    motivation/Motivation/Motivations,%
    notation/Notation/Notations,%
    notationabuse/Notation abuse/Notation abuses,%
    note/Note/Notes,%
    observation/Observation/Observations,%
    openproblem/Open problem/Open problems,%
    postulate/Postulate/Postulates,%
    problem/Problem/Problems,%
    proof/Proof/Proofs
    property/Property/Properties,%
    proposition/Proposition/Propositions,%
    protocol/Protocol/Protocols,%
    question/Question/Questions,%
    recall/Recall/Recalls,%
    remark/Remark/Remarks,%
    result/Result/Results,%
    solution/Solution/Solutions,%
    step/Step/Steps,%
    summary/Summary/Summaries,%
    syntax/Syntax/Syntaxes,%
    takeaway/Takeaway/Takeaways,%
    theorem/Theorem/Theorems,%
    tip/Tip/Tips,%
    warning/Warning/Warnings,%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% SECTION FORMATTING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Customizes sectional unit appearance via titlesec package.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{titlesec}

\titleformat{\section}
{\normalfont\bfseries\Large}
{\thesection\ }{5pt}{}

\titleformat{\subsection}
{\bfseries\large}
{\thesubsection\ }{7.5pt}{}

\titleformat{\subsubsection}[runin]
{\bfseries\normalsize}
{\thesubsubsection.\ }{0.75em}{}[.\ ]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TITLE PAGE STYLING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Applies professional title page formatting via hep-title package.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{hep-title}
\titlefont{\bfseries\Large}
\subtitlefont{\bfseries\large}
\seriesfont{\itshape}
\authorfont{\normalsize}
\affiliationfont{\small\scshape}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PARAGRAPH HEADINGS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Provides \parhead command for inline paragraph headings with automatic
% punctuation. Appends period if text doesn't end with . ? ! :
%
% Implementation uses delimiter-based parsing to detect trailing punctuation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifcsam@haspunctuation

\def\csam@checkpunctuation#1{%
    \ifx\csam@checkpunctuation#1\csam@checkpunctuation
    \else
        \csam@haspunctuationtrue
    \fi
}

\def\csam@checkdot#1.\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}
\def\csam@checkquestion#1?\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}
\def\csam@checkexclam#1!\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}
\def\csam@checkcolon#1:\csam@delim#2\csam@stop{\csam@checkpunctuation{#2}}

\def\csam@appendpunctuationifneeded#1{%
    \csam@haspunctuationfalse
    \csam@checkdot#1\csam@delim.\csam@delim\csam@stop
    \csam@checkquestion#1\csam@delim?\csam@delim\csam@stop
    \csam@checkexclam#1\csam@delim!\csam@delim\csam@stop
    \csam@checkcolon#1\csam@delim:\csam@delim\csam@stop
    #1\ifcsam@haspunctuation \else.\fi%
}

\def\csam@ignorewhitespaceandimplicitpars{%
    \begingroup
    \catcode13=10 %
    \@ifnextchar\relax
    {\endgroup}
    {\endgroup}%
}

\NewDocumentCommand{\csam@paragraphhead}{m}{%
    \smallskip
    \noindent
    \textbf{\boldmath\ignorespaces\csam@appendpunctuationifneeded{#1}}%
    \hskip 0.9em plus 0.3em minus 0.3em
    \csam@ignorewhitespaceandimplicitpars
}

\NewDocumentCommand{\csam@subparagraphhead}{m}{%
    \smallskip
    \noindent
    \textsc{\ignorespaces\csam@appendpunctuationifneeded{#1}}%
    \hskip 0.9em plus 0.3em minus 0.3em
    \csam@ignorewhitespaceandimplicitpars
}

\NewDocumentCommand{\parhead}{m}{\csam@paragraphhead{#1}}
\NewDocumentCommand{\subparhead}{m}{\csam@subparagraphhead{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BROKEN REFERENCE DETECTION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Adds visual margin markers (colored stars) for undefined citations and
% references. Aids in document proofreading and debugging.
%
% Markers appear in document margins with label text indicating the
% undefined reference key.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{marginnote}

\providecommand{\csam@colorize}{\color{Firebrick2}}

\newcommand{\csam@brokenrefmark}[1]{%
    \marginnote[%
        {\csam@colorize\normalfont\smash{\LARGE$\star$}\ \tiny\sffamily#1}%
    ]{%
        {\csam@colorize\normalfont\smash{\LARGE$\star$}\ \tiny\sffamily#1}%
    }%
}

\newbool{csam@markundef}
\booltrue{csam@markundef}

\xpretocmd{\G@refundefinedtrue}{%
    \ifbool{csam@markundef}{%
        \csam@brokenrefmark{\@ifundefined{@citeb}{}{\@citeb}}%
    }{}%
}{}{}

\let\csam@old@setref=\@setref
\renewcommand{\@setref}[3]{%
    \ifx#1\relax \csam@brokenrefmark{#3}\fi%
    \csam@markundeffalse%
    \csam@old@setref{#1}{#2}{#3}%
    \csam@markundeftrue%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ANNOTATION SYSTEM
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Provides collaborative annotation framework with visual markers.
%
% Core functionality:
%   - \newguymarker: Creates custom annotation commands
%   - Predefined workflow commands: \todo, \fixme, \notes, \query
%   - Revision tracking: \changed, \added, \removed
%   - Toggle via printcoms/noprintcoms package options
%
% Visual design:
%   - Colored text distinguishes annotation types
%   - Large star (â˜…) in margin marks annotation locations
%   - Small caps labels maintain professional appearance
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[most]{tcolorbox}
\RequirePackage[%
    skipabove=10pt,
    skipbelow=10pt,
    ntheorem,
    framemethod=TikZ
]{mdframed}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ANNOTATION COMMAND GENERATOR
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Syntax: \newguymarker{cmdname}{displaylabel}{color}
%
% Creates a new annotation command that:
%   1. Typesets argument text in specified color
%   2. Adds small caps label
%   3. Places large star in margin
%
% Example:
%   \newguymarker{alice}{Alice}{Purple}
%   \alice{Check this citation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NewDocumentCommand{\newguymarker}{m m m}{%
    \ifcsam@printcoms
        \expandafter\newcommand\csname #1\endcsname[1]{%
            \textcolor{#3}{##1\ \textsc{#2}}%
            \marginnote{\textcolor{#3}{\LARGE$\star$}}%
        }%
    \else
        \expandafter\newcommand\csname #1\endcsname[1]{}%
    \fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% WORKFLOW ANNOTATIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Predefined commands for common document workflow tasks.
% Active only when printcoms option is enabled.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifcsam@printcoms
    \providecommand{\todo}[1]{%
        \textcolor{Red}{[\textsc{To-do}: #1]}%
        \marginnote{\textcolor{Red}{\LARGE$\star$}}%
    }
    \providecommand{\fixme}[1]{%
        \textcolor{OrangeRed}{[\textsc{Fix-me}: #1]}%
        \marginnote{\textcolor{OrangeRed}{\LARGE$\star$}}%
    }
    \providecommand{\missing}[1]{%
        \textcolor{Crimson}{#1}%
        \marginnote{\textcolor{Crimson}{\LARGE$\star$}}%
    }
    \providecommand{\notes}[1]{%
        \textcolor{ForestGreen}{[\textsc{Note}: #1]}%
        \marginnote{\textcolor{ForestGreen}{\LARGE$\star$}}%
    }
    \providecommand{\query}[1]{%
        \textcolor{Purple}{[\textsc{Q}: #1]}%
        \marginnote{\textcolor{Purple}{\LARGE$\star$}}%
    }
\else
    \providecommand{\fixme}[1]{}
    \providecommand{\missing}[1]{}
    \providecommand{\notes}[1]{}
    \providecommand{\query}[1]{}
    \providecommand{\todo}[1]{}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% REVISION TRACKING
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Visual indicators for document modifications during collaborative editing.
% Provides change tracking without external diff tools.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifcsam@printcoms
    \providecommand{\changed}[1]{%
        \textcolor{blue}{#1}%
        \marginnote{\textcolor{blue}{\LARGE$\star$}}%
    }
    \providecommand{\added}[1]{%
        \textcolor{OliveGreen}{#1}%
        \marginnote{\textcolor{OliveGreen}{\LARGE$\star$}}%
    }
    \providecommand{\removed}[1]{%
        \textcolor{Gray}{\sout{#1}}%
        \marginnote{\textcolor{Gray}{\LARGE$\star$}}%
    }
\else
    \providecommand{\changed}[1]{#1}
    \providecommand{\added}[1]{#1}
    \providecommand{\removed}[1]{}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DOCUMENT-LEVEL CUSTOMIZATIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Redefines standard LaTeX commands at document start to integrate with
% package functionality.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\AtBeginDocument{%
    \renewcommand{\paragraph}[1]{\parhead{#1}}%
    \renewcommand{\subparagraph}[1]{\noindent\textsc{#1}}%
    \renewcommand{\Pr}{\mathop{\mathsf{Pr}}}%
}

\makeatother
\endinput

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END OF PACKAGE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%