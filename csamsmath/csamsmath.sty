%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csamsmath.sty — Comprehensive Academic Math Support Package
% Author: Agni Datta
% Version: 1.2
% Date: 2025-09-22
% License: LaTeX Project Public License v1.3c or later
%
% OVERVIEW
%   All-in-one setup for academic STEM documents. Ships professional
%   typography, robust math, figures/tables, links, captions, and 50+ coherent
%   theorem-like environments. Uses thmtools (modern amsthm front-end) for
%   theorem management and cleveref integration.
%
% PHILOSOPHY
%   Load once, write immediately, avoid boilerplate. Defaults are sensible and
%   overridable.
%
% ENGINES
%   pdfLaTeX and LuaLaTeX supported. XeLaTeX not required.
%
% FONT OPTIONS
%   Package options:
%     [libertine]   — Linux Libertine/Libertinus text + math (default)
%     [latinmodern] — Latin Modern text; math follows engine (LM Math on LuaLaTeX,
%                     Computer Modern math on pdfLaTeX)
%
% USAGE
%   \usepackage[libertine]{csamsmath}
%   \usepackage[latinmodern]{csamsmath}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[2020/10/01]
\ProvidesPackage{csamsmath}[2025/09/22 v1.2 STEM setup (thmtools, font switch)]

% -----------------------------------------------------------------------------
% OPTIONS
% -----------------------------------------------------------------------------
\newif\ifcsam@libertine
\csam@libertinetrue % default
\DeclareOption{libertine}{\csam@libertinetrue}
\DeclareOption{latinmodern}{\csam@libertinefalse}
\ProcessOptions\relax

% -----------------------------------------------------------------------------
% INTERNALS
% -----------------------------------------------------------------------------
\makeatletter

% Avoid accidental prior amsthm customizations (similar to amsbook undo)
\expandafter\let\csname ver@amsthm.sty\endcsname\relax
\let\theoremstyle\relax
\let\newtheoremstyle\relax
\let\pushQED\relax
\let\popQED\relax
\let\qedhere\relax
\let\mathqed\relax
\let\openbox\relax
\let\proof\relax
\let\endproof\relax

% -----------------------------------------------------------------------------
% CORE UTILITY PACKAGES
% -----------------------------------------------------------------------------
\RequirePackage{calc}
\RequirePackage{comment}
\RequirePackage{etoolbox}
\RequirePackage{ifpdf}
\RequirePackage{iftex}
\RequirePackage{xkeyval}
\RequirePackage{xparse}
\RequirePackage{xpatch}

% -----------------------------------------------------------------------------
% COLOR MANAGEMENT
% -----------------------------------------------------------------------------
\RequirePackage[dvipsnames,svgnames,table,x11names]{xcolor}

% -----------------------------------------------------------------------------
% PDF VERSIONING AND LAYOUT PRIMITIVES
% -----------------------------------------------------------------------------
\RequirePackage[2.0,objcompress,compress]{bxpdfver}
\RequirePackage{fullpage}
\RequirePackage{pdfpages}
\RequirePackage{refcount}

% -----------------------------------------------------------------------------
% LANGUAGE, ENCODING, MICROTYPE
% -----------------------------------------------------------------------------
\RequirePackage[T1]{fontenc}
\RequirePackage[USenglish]{babel}
\RequirePackage[autostyle=true,csdisplay=true]{csquotes}
\RequirePackage[final]{microtype}
\RequirePackage[full]{textcomp}
\RequirePackage{emptypage}
\RequirePackage{moresize}
\RequirePackage{paralist}
\RequirePackage{pifont}
\RequirePackage{soul}
\RequirePackage{xspace}
\RequirePackage{xurl}

% -----------------------------------------------------------------------------
% MATH CORE
% -----------------------------------------------------------------------------
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{mathtools}
\RequirePackage{nicefrac}
\RequirePackage{siunitx}
\RequirePackage{mathrsfs}
\RequirePackage{amsthm}
\RequirePackage{thmtools}

% -----------------------------------------------------------------------------
% FONTS PER ENGINE WITH OPTION SWITCH
% -----------------------------------------------------------------------------
\ifLuaTeX
    \RequirePackage{fontspec}
    \RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
    \ifcsam@libertine
        % Libertine/Libertinus stack (LuaLaTeX)
        \setmainfont{Libertinus Serif}[
            SmallCapsFeatures = {RawFeature=+smcp},
            RawFeature = {+calt,+case,+cpsp,+kern,+liga,+lnum,+pnum},
        ]
        \setsansfont{Libertinus Sans}[
            Scale=MatchLowercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmonofont{Latin Modern Mono}[
            Scale=MatchLowercase,
            RawFeature={+calt,+liga,+lnum,+pnum}
        ]
        \setmathfont{Libertinus Math}
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=pxtx,bb=esstix,scr=esstix]{mathalpha}
    \else
        % Latin Modern stack (LuaLaTeX)
        \setmainfont{Latin Modern Roman}[
            Ligatures=TeX,
            SmallCapsFont = Latin Modern Roman Caps,
            RawFeature   = {+calt,+case,+cpsp,+kern,+liga,+lnum,+pnum}
        ]
        \setsansfont{Latin Modern Sans}[Scale=MatchUppercase,Ligatures=TeX]
        \setmonofont{Latin Modern Mono}[Scale=MatchLowercase,Ligatures=TeX]
        \setmathfont{Latin Modern Math}
        \let\mathbfcal\relax\let\mathbfscr\relax
        \RequirePackage[cal=cm,bb=esstix,scr=esstix]{mathalpha}
    \fi
\else
    % pdfLaTeX
    \ifcsam@libertine
        \RequirePackage{libertineRoman}
        \RequirePackage{biolinum}
        \RequirePackage[libertine,varbb]{newtxmath}
        \RequirePackage[cal=pxtx,bb=esstix,scr=esstix]{mathalpha}
    \else
        \RequirePackage{lmodern}
        % Use Computer Modern math with ams packages
        \RequirePackage[cal=pxtx,bb=esstix,scr=esstix]{mathalpha}
    \fi
\fi

% -----------------------------------------------------------------------------
% GRAPHICS, FLOATS, CAPTIONS
% -----------------------------------------------------------------------------
\RequirePackage{graphicx}
\RequirePackage{floatrow}
\RequirePackage{placeins}
\RequirePackage{rotating}
\RequirePackage{pdflscape}
\RequirePackage{caption}
\RequirePackage{subcaption}
\RequirePackage{wrapfig}
\RequirePackage{adjustbox}
\RequirePackage{dashbox}
\RequirePackage{fancybox}
\RequirePackage{framed}

\AtBeginDocument{%
    \captionsetup{%
        font={sf,small},
        labelfont={color=black,sc,small},
        labelsep=period,
        skip=5pt,
        justification=justified
    }%
    \captionsetup[table]{position=bottom, skip=5pt}
    \captionsetup[figure]{position=bottom, skip=5pt}
}

% -----------------------------------------------------------------------------
% TABLE SUITE
% -----------------------------------------------------------------------------
\RequirePackage{array}
\RequirePackage{tabularx}
\RequirePackage{tabularray}
\RequirePackage{longtable}
\RequirePackage{xtab}
\RequirePackage{booktabs}
\RequirePackage{hhline}
\RequirePackage{colortbl}
\RequirePackage{makecell}
\RequirePackage{multirow}
\RequirePackage{diagbox}
\RequirePackage{threeparttable}

% -----------------------------------------------------------------------------
% TEXT LAYOUT AND RULES
% -----------------------------------------------------------------------------
\RequirePackage{multicol}
\RequirePackage{ragged2e}
\RequirePackage{verbatim}
\RequirePackage{xhfill}

% -----------------------------------------------------------------------------
% LISTS
% -----------------------------------------------------------------------------
\RequirePackage{enumitem}
\setlist{nosep}
\setlist[enumerate,1]{label=(\arabic*)}
\setlist[enumerate,2]{label=(\alph*)}
\setlist[enumerate,3]{label=(\Roman*)}
\setlist[itemize,1]{label=\ensuremath{\text{-}}}
\setlist[itemize,2]{label=\ensuremath{\bullet}}
\setlist[itemize,3]{label=\ensuremath{\circ}}

% -----------------------------------------------------------------------------
% HYPERLINKS AND XREF
% -----------------------------------------------------------------------------
\RequirePackage{nameref}
\RequirePackage[
    bookmarksnumbered=true,
    breaklinks=true,
    citecolor=DodgerBlue3,
    colorlinks=true,
    linkcolor=RoyalBlue3,
    pagebackref,
    pdfencoding=auto,
    pdfpagelabels=true,
    pdfpagelayout=SinglePage,
    pdfstartview=FitH,
    pdfusetitle,
    unicode=true,
    urlcolor=Turquoise4
]{hyperref}

\RequirePackage[capitalize,nameinlink,noabbrev]{cleveref}
\RequirePackage{xr}

% -----------------------------------------------------------------------------
% TITLE PATCH — small caps, large; guard if \@settitle undefined
% -----------------------------------------------------------------------------
\newcommand*\csamsmath@patchtitle{%
    \@ifundefined{@settitle}{}{%
        \xpatchcmd{\@settitle}{\uppercasenonmath\@title}{\normalfont\scshape\Large}{}{}%
    }%
    \RequirePackage{setspace}\setstretch{1.15}%
}
\csamsmath@patchtitle

% -----------------------------------------------------------------------------
% BIBLIOGRAPHY BACK-REF TEXT
% -----------------------------------------------------------------------------
\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
    \ifcase #1\or (Cited on p.~#2).%
    \else (Cited on pp.~#2).%
    \fi
}

% =============================================================================
% THEOREM SYSTEM — thmtools + cleveref
% =============================================================================

\numberwithin{equation}{section}

% Styles
\declaretheoremstyle[
    headfont=\bfseries,
    bodyfont=\itshape,
    spaceabove=3pt, spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@theoremlike}

\declaretheoremstyle[
    headfont=\bfseries,
    bodyfont=\normalfont,
    spaceabove=3pt, spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@definitionlike}

\declaretheoremstyle[
    headfont=\scshape,
    bodyfont=\normalfont,
    spaceabove=3pt, spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@remarklike}

\declaretheoremstyle[
    headfont=\sffamily\bfseries,
    bodyfont=\normalfont,
    spaceabove=3pt, spacebelow=3pt,
    headpunct=.,
    postheadspace=.5em
]{csam@highlightlike}

% Base counter
\declaretheorem[name=Theorem,style=csam@theoremlike,numberwithin=section]{theorem}

% Sibling declaration helper
\newcommand\csam@declaretheoremfamily[2]{%
    \forcsvlist{\declaretheorem[sibling=theorem,style=#1]}{#2}%
}

% Theorem-like
\csam@declaretheoremfamily{csam@theoremlike}{%
    assertion,assumption,axiom,claim,conclusion,conjecture,corollary,criterion,
    fact,folklore,hypothesis,lemma,observation,postulate,property,proposition
}

% Definition-like
\csam@declaretheoremfamily{csam@definitionlike}{%
    application,construction,convention,definition,example,experiment,problem,
    protocol,result,solution,step,notation
}

% Remark-like
\csam@declaretheoremfamily{csam@remarklike}{%
    commentary,discussion,exercise,motivation,notationabuse,note,openproblem,
    question,remark,syntax
}

% Highlight-like
\csam@declaretheoremfamily{csam@highlightlike}{%
    guideline,highlight,important,insight,keypoint,recall,summary,takeaway,tip,warning
}

% Unnumbered representatives
\declaretheorem[name=Theorem,style=csam@theoremlike,numbered=no]{theorem*}
\declaretheorem[name=Lemma,style=csam@theoremlike,numbered=no]{lemma*}
\declaretheorem[name=Corollary,style=csam@theoremlike,numbered=no]{corollary*}
\declaretheorem[name=Hypothesis,style=csam@theoremlike,numbered=no]{hypothesis*}
\declaretheorem[name=Claim,style=csam@theoremlike,numbered=no]{claim*}
\declaretheorem[name=Conjecture,style=csam@theoremlike,numbered=no]{conjecture*}
\declaretheorem[name=Open Problem,style=csam@remarklike,numbered=no]{openproblem*}
\declaretheorem[name=Syntax,style=csam@remarklike,numbered=no]{syntax*}

% -----------------------------------------------------------------------------
% CUSTOM PROOF ENVIRONMENT
% -----------------------------------------------------------------------------
\let\proof\relax
\let\endproof\relax

\declaretheoremstyle[
    headfont=\itshape,
    bodyfont=\normalfont,
    spaceabove=5pt, spacebelow=5pt,
    headpunct={.},
    postheadspace=0.5em,
    qed=\ensuremath{\square}
]{csam@proofstyle}

\declaretheorem[name=Proof,style=csam@proofstyle,numbered=no]{proof}

% -----------------------------------------------------------------------------
% cleveref names
% -----------------------------------------------------------------------------
\crefname{section}{\textsection}{\textsection\textsection}
\Crefname{section}{\textsection}{\textsection\textsection}
\crefname{subsection}{\textsection}{\textsection\textsection}
\Crefname{subsection}{\textsection}{\textsection\textsection}
\crefname{subsubsection}{\textsection}{\textsection\textsection}
\Crefname{subsubsection}{\textsection}{\textsection\textsection}
\crefname{paragraph}{paragraph}{paragraphs}
\Crefname{paragraph}{Paragraph}{Paragraphs}
\crefname{subparagraph}{subparagraph}{subparagraphs}
\Crefname{subparagraph}{Subparagraph}{Subparagraphs}

% Helper to bulk-assign names (no automatic uppercasing)
\newcommand\csam@crefset[3]{%
    \crefname{#1}{#2}{#3}%
}

% Theorem-like block
\csam@crefset{theorem}{theorem}{theorems}
\csam@crefset{assertion}{assertion}{assertions}
\csam@crefset{assumption}{assumption}{assumptions}
\csam@crefset{axiom}{axiom}{axioms}
\csam@crefset{claim}{claim}{claims}
\csam@crefset{conclusion}{conclusion}{conclusions}
\csam@crefset{conjecture}{conjecture}{conjectures}
\csam@crefset{corollary}{corollary}{corollaries}
\csam@crefset{criterion}{criterion}{criteria}
\csam@crefset{fact}{fact}{facts}
\csam@crefset{folklore}{folklore}{folklore}
\csam@crefset{hypothesis}{hypothesis}{hypotheses}
\csam@crefset{lemma}{lemma}{lemmas}
\csam@crefset{observation}{observation}{observations}
\csam@crefset{postulate}{postulate}{postulates}
\csam@crefset{property}{property}{properties}
\csam@crefset{proposition}{proposition}{propositions}

% Definition-like block
\csam@crefset{application}{application}{applications}
\csam@crefset{construction}{construction}{constructions}
\csam@crefset{convention}{convention}{conventions}
\csam@crefset{definition}{definition}{definitions}
\csam@crefset{example}{example}{examples}
\csam@crefset{experiment}{experiment}{experiments}
\csam@crefset{problem}{problem}{problems}
\csam@crefset{protocol}{protocol}{protocols}
\csam@crefset{result}{result}{results}
\csam@crefset{solution}{solution}{solutions}
\csam@crefset{step}{step}{steps}
\csam@crefset{notation}{notation}{notations}

% Remark-like block
\csam@crefset{commentary}{commentary}{commentaries}
\csam@crefset{discussion}{discussion}{discussions}
\csam@crefset{exercise}{exercise}{exercises}
\csam@crefset{motivation}{motivation}{motivations}
\csam@crefset{notationabuse}{notation abuse}{notation abuses}
\csam@crefset{note}{note}{notes}
\csam@crefset{openproblem}{open problem}{open problems}
\csam@crefset{question}{question}{questions}
\csam@crefset{remark}{remark}{remarks}
\csam@crefset{syntax}{syntax}{syntaxes}

% Highlight-like block
\csam@crefset{guideline}{guideline}{guidelines}
\csam@crefset{highlight}{highlight}{highlights}
\csam@crefset{important}{important point}{important points}
\csam@crefset{insight}{insight}{insights}
\csam@crefset{keypoint}{key point}{key points}
\csam@crefset{recall}{recall}{recalls}
\csam@crefset{summary}{summary}{summaries}
\csam@crefset{takeaway}{takeaway}{takeaways}
\csam@crefset{tip}{tip}{tips}
\csam@crefset{warning}{warning}{warnings}

% Proof
\csam@crefset{proof}{proof}{proofs}

% =============================================================================
% FINALS
% =============================================================================
\makeatother
\endinput
