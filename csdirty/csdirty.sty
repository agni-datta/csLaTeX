%% csdirty.sty
%% Copyright 2025 Agni Datta
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Agni Datta.
%
% This work consists of the file csdirty.sty

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{csdirty}[2025/02/01 v2.0 Modern academic document package]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Package Description
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csdirty: A comprehensive package for academic writing with support for
% multiple font systems, theorems, cryptography notation, and document 
% formatting. Features include:
%   - Multiple professional font options (Latin Modern, Libertinus, Concrete, Garamond)
%   - Integrated theorem environments via csthm
%   - Cryptography notation support via tcscrypto
%   - TikZ integration for diagrams
%   - Customizable document structure and formatting
%   - Version control for full/short document variants
%   - ORCID integration for academic publishing

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Internal Commands and Utilities
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{etoolbox}                     % Programming utilities
\RequirePackage{iftex}                        % Engine detection

%% Internal conditionals (using \newif pattern)
\newif\if@csd@comments
\newif\if@csd@fullversion
\newif\if@csd@shortversion
\newif\if@csd@loadappendix
\newif\if@csd@loadcrypto
\newif\if@csd@loadepigraph
\newif\if@csd@loadfull
\newif\if@csd@loadfullpage
\newif\if@csd@loadnicespacing
\newif\if@csd@loadnicodemus
\newif\if@csd@loadnomath
\newif\if@csd@loadoldsection
\newif\if@csd@loadorcid
\newif\if@csd@loadtheorems
\newif\if@csd@loadtikz
\newif\if@csd@loaduseful
\newif\if@csd@modgreek

%% Set defaults
\@csd@commentsfalse
\@csd@fullversionfalse
\@csd@shortversionfalse
\@csd@loadappendixfalse
\@csd@loadcryptofalse
\@csd@loadepigraphfalse
\@csd@loadfulltrue
\@csd@loadfullpagefalse
\@csd@loadnicespacingfalse
\@csd@loadnicodemusfalse
\@csd@loadnomathfalse
\@csd@loadoldsectionfalse
\@csd@loadorcidfalse
\@csd@loadtheoremsfalse
\@csd@loadtikzfalse
\@csd@loadusefultrue
\@csd@modgreekfalse

%% Default values for string options
\def\csd@font{lmodern}
\def\csd@margin{3.5cm}
\def\csd@spacing{1.0}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Package Options - Traditional Interface
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Font selection options
\DeclareOption{lmodern}{\def\csd@font{lmodern}}
\DeclareOption{latinmodern}{\def\csd@font{lmodern}}
\DeclareOption{libertinus}{\def\csd@font{libertinus}}
\DeclareOption{concrete}{\def\csd@font{concrete}}
\DeclareOption{garamond}{\def\csd@font{garamond}}
\DeclareOption{gfsdidot}{\def\csd@font{gfsdidot}}
\DeclareOption{palatino}{\def\csd@font{palatino}}

%% Version control options
\DeclareOption{fullversion}{\@csd@fullversiontrue\@csd@shortversionfalse}
\DeclareOption{shortversion}{\@csd@shortversiontrue\@csd@fullversionfalse}
\DeclareOption{preprint}{\@csd@fullversiontrue\@csd@shortversionfalse}

%% Feature loading options
\DeclareOption{appendix}{\@csd@loadappendixtrue}
\DeclareOption{comments}{\@csd@commentstrue}
\DeclareOption{crypto}{\@csd@loadcryptotrue}
\DeclareOption{epigraph}{\@csd@loadepigraphtrue}
\DeclareOption{full}{\@csd@loadfulltrue}
\DeclareOption{fullpage}{\@csd@loadfullpagetrue}
\DeclareOption{nicespacing}{\@csd@loadnicespacingtrue}
\DeclareOption{nicodemus}{\@csd@loadnicodemustrue}
\DeclareOption{nomath}{\@csd@loadnomathtrue}
\DeclareOption{oldsection}{\@csd@loadoldsectiontrue}
\DeclareOption{orcidlink}{\@csd@loadorcidtrue}
\DeclareOption{theorems}{\@csd@loadtheoremstrue}
\DeclareOption{tikz}{\@csd@loadtikztrue}
\DeclareOption{usefulcommands}{\@csd@loadusefultrue}
\DeclareOption{modgreeksymbs}{\@csd@modgreektrue}

%% Negation options
\DeclareOption{noappendix}{\@csd@loadappendixfalse}
\DeclareOption{nocomments}{\@csd@commentsfalse}
\DeclareOption{nocrypto}{\@csd@loadcryptofalse}
\DeclareOption{noepigraph}{\@csd@loadepigraphfalse}
\DeclareOption{nofullpage}{\@csd@loadfullpagefalse}
\DeclareOption{noorcidlink}{\@csd@loadorcidfalse}
\DeclareOption{notheorems}{\@csd@loadtheoremsfalse}
\DeclareOption{notikz}{\@csd@loadtikzfalse}
\DeclareOption{nousefulcommands}{\@csd@loadusefulfalse}

%% Handle 'full' option dependencies
\if@csd@loadfull
	\PackageInfo{csdirty}{Loading full version with all features}%
	\@csd@loadappendixtrue
	\@csd@loadepigraphtrue
	\@csd@loadnicespacingtrue
	\@csd@loadorcidtrue
	\@csd@loadtheoremstrue
	\@csd@loadtikztrue
	\@csd@loadusefultrue
\fi

%% Process options
\ProcessOptions\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Engine Detection and Warnings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifLuaTeX
	\PackageInfo{csdirty}{LuaTeX engine detected - full Unicode support enabled}%
\else
	\ifPDFTeX
		\PackageInfo{csdirty}{pdfTeX engine detected - using fallback configurations}%
	\else
		\PackageWarning{csdirty}{%
			Unsupported TeX engine detected.^^J%
			This package is optimized for LuaTeX with pdfTeX fallback.^^J%
			Unexpected behavior may occur%
		}%
	\fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Document Class Detection
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\@ifclassloaded{article}{%
	\PackageInfo{csdirty}{Document class: article}%
}{%
	\@ifclassloaded{report}{%
		\PackageInfo{csdirty}{Document class: report}%
	}{%
		\@ifclassloaded{book}{%
			\PackageInfo{csdirty}{Document class: book}%
		}{%
			\PackageWarning{csdirty}{%
				Unsupported document class detected.^^J%
				This package is tested with: article, report, book.^^J%
				Current class: \@classoptionslist
			}%
		}%
	}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Core Programming Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{calc}                         % Length arithmetic
\RequirePackage{comment}                      % Block comments
\RequirePackage{xparse}                       % Extended command definitions

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Color Support
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[x11names,dvipsnames]{xcolor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PDF and Document Structure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[2.0,objcompress,compress]{bxpdfver}
\RequirePackage[nottoc]{tocbibind}
\RequirePackage{babel}
\RequirePackage{pdfpages}
\RequirePackage{refcount}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Page Layout
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\if@csd@loadfullpage
	\RequirePackage[margin=1in]{geometry}
	\PackageInfo{csdirty}{Using fullpage layout (1in margins)}%
\else
	\RequirePackage[margin=\csd@margin]{geometry}
	\PackageInfo{csdirty}{Using margin: \csd@margin}%
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Line Spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{setspace}
\if@csd@loadnicespacing
	\setstretch{1.15}%
	\PackageInfo{csdirty}{Using nice spacing (1.15)}%
\else
	\setstretch{\csd@spacing}%
	\PackageInfo{csdirty}{Using spacing: \csd@spacing}%
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Text Enhancement Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[autostyle=true,csdisplay=true]{csquotes}
\RequirePackage[final]{microtype}
\RequirePackage[full]{textcomp}
\RequirePackage[nocompress]{cite}
\RequirePackage[normalem]{ulem}
\RequirePackage{emptypage}
\RequirePackage{lipsum}
\RequirePackage{marginnote}
\RequirePackage{paralist}
\RequirePackage{pifont}
\RequirePackage{soul}
\RequirePackage{xspace}
\RequirePackage{xurl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Font Loading System
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Modular font loading system supporting multiple professional typefaces.
% Each font has separate implementations for LuaTeX (using fontspec/unicode-math)
% and pdfTeX (using traditional Type1 fonts).
%
% Available fonts:
%   - lmodern    : Latin Modern (default, works with both engines)
%   - libertinus : Libertinus Serif with math support
%   - concrete   : Concrete Roman with Euler math (LuaTeX only)
%   - garamond   : Garamond Libre with Garamond Math (LuaTeX only)
%   - gfsdidot   : GFS Didot with modern styling (LuaTeX only)
%   - palatino   : TeX Gyre Pagella with Palatino-style math
%
% Font selection is done via the font= key-value option.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font Dispatcher Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% These commands route to the appropriate engine-specific implementation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\csd@font@lmodern{%
	\PackageInfo{csdirty}{Loading Latin Modern fonts}%
	\ifLuaTeX
		\csd@load@lmodern@lua
	\else
		\csd@load@lmodern@pdftex
	\fi
}

\def\csd@font@libertinus{%
	\PackageInfo{csdirty}{Loading Libertinus fonts}%
	\ifLuaTeX
		\let\Game\relax
		\csd@load@libertinus@lua
	\else
		\csd@load@libertinus@pdftex
	\fi
}

\def\csd@font@concrete{%
	\PackageInfo{csdirty}{Loading Concrete fonts}%
	\ifLuaTeX
		\csd@load@concrete@lua
	\else
		\csd@load@concrete@pdftex
	\fi
}

\def\csd@font@garamond{%
	\PackageInfo{csdirty}{Loading Garamond fonts}%
	\ifLuaTeX
		\csd@load@garamond@lua
	\else
		\PackageError{csdirty}{Garamond font requires LuaTeX}{%
			The garamond font option is only available with LuaTeX.^^J%
			Please use lualatex instead of pdflatex%
		}%
	\fi
}

\def\csd@font@gfsdidot{%
	\PackageInfo{csdirty}{Loading GFS Didot fonts}%
	\ifLuaTeX
		\csd@load@gfsdidot@lua
	\else
		\csd@load@gfsdidot@pdftex
	\fi
}

\def\csd@font@palatino{%
	\PackageInfo{csdirty}{Loading Palatino fonts}%
	\ifLuaTeX
		\csd@load@palatino@lua
	\else
		\csd@load@palatino@pdftex
	\fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LuaTeX Font Configurations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Modern Unicode font setup using fontspec and unicode-math packages.
% Provides full OpenType feature support and native Unicode math rendering.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Latin Modern - Modern CM-style fonts with extended Unicode coverage
\def\csd@load@lmodern@lua{%
	\RequirePackage{fontspec}%
	\RequirePackage{thmtools}%
	\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}%
	\setmainfont{Latin Modern Roman}[
		Ligatures=TeX,
		SmallCapsFont=Latin Modern Roman Caps,
		RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+pnum}
	]%
	\setsansfont{Latin Modern Sans}[Scale=MatchUppercase,Ligatures=TeX]%
	\setmonofont{Latin Modern Mono}[Scale=MatchLowercase,Ligatures=TeX]%
	\setmathfont{Latin Modern Math}[AutoFakeBold,AutoFakeSlant]%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
}

%% Libertinus - Classical humanist serif with comprehensive math support
\def\csd@load@libertinus@lua{%
	\RequirePackage{fontspec}%
	\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}%
	\setmainfont{Libertinus Serif}[
		Scale=MatchUppercase,
		RawFeature={+calt,+liga,+lnum,+pnum}
	]%
	\setmathfont{Libertinus Math}[
		Scale=MatchUppercase,
		RawFeature={+calt,+liga,+lnum,+pnum}
	]%
	\setsansfont{Libertinus Sans}[
		Scale=MatchUppercase,
		RawFeature={+calt,+liga,+lnum,+pnum}
	]%
	\setmonofont{Latin Modern Mono}[
		Scale=MatchUppercase,
		RawFeature={+calt,+liga,+lnum,+pnum}
	]%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
}

%% GFS Didot - Neoclassical Greek-inspired serif
\def\csd@load@gfsdidot@lua{%
	\RequirePackage[gfsdidot]{fontsetup}%
	\setsansfont{Libertinus Sans}[
		Scale=MatchUppercase,
		RawFeature={+calt,+liga,+lnum,+pnum}
	]%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
}

%% Concrete - Knuth's concrete roman with Euler math
\def\csd@load@concrete@lua{%
	\RequirePackage[concrete]{fontsetup}%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
}

%% Palatino - TeX Gyre Pagella (Palatino clone) with math
\def\csd@load@palatino@lua{%
	\RequirePackage{fontspec}%
	\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}%
	\setmainfont{TeX Gyre Pagella}[Ligatures=TeX]%
	\setsansfont{Libertinus Sans}[Scale=MatchUppercase,Ligatures=TeX]%
	\setmonofont{Latin Modern Mono}[Scale=MatchLowercase,Ligatures=TeX]%
	\setmathfont{TeX Gyre Pagella Math}[AutoFakeBold,AutoFakeSlant]%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
}

%% Garamond - Classical old-style serif (LuaTeX only)
\def\csd@load@garamond@lua{%
	\RequirePackage{lualatex-math}%
	\RequirePackage{fontspec}%
	\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}%
	\setmainfont{GaramondLibre}[
		Extension=.otf,
		UprightFont=*-Regular,
		ItalicFont=*-Italic,
		BoldFont=*-Bold,
		BoldItalicFont=*-BoldItalic,
		SmallCapsFont=EBGaramond-Medium.otf,
		SmallCapsFeatures={Letters=SmallCaps},
	]%
	\setmathfont{Garamond-Math.otf}[
		AutoFakeBold,
		StylisticSet={2,6,7,9},
	]%
	\setsansfont{Ysabeau}[Scale=MatchLowercase]%
	\setmonofont{Noto Sans Mono}[Scale=MatchLowercase]%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% pdfTeX Font Configurations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Traditional Type1 font setup for pdfTeX compatibility.
% Uses classic LaTeX font packages with limited OpenType support.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Latin Modern for pdfTeX
\def\csd@load@lmodern@pdftex{%
	\RequirePackage[T1]{fontenc}%
	\RequirePackage{lmodern}%
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
	\csd@load@common@math@pdftex
}

%% Libertinus for pdfTeX (using newtxmath)
\def\csd@load@libertinus@pdftex{%
	\RequirePackage[T1]{fontenc}%
	\RequirePackage{lmodern}%
	\RequirePackage{biolinum}%
	\RequirePackage{libertineRoman}%
	\RequirePackage[libertine,varbb]{newtxmath}%
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
	\csd@load@common@math@pdftex
}

%% GFS Didot for pdfTeX
\def\csd@load@gfsdidot@pdftex{%
	\RequirePackage[T1]{fontenc}%
	\RequirePackage{lmodern}%
	\RequirePackage{libertinust1math}%
	\RequirePackage{gfsdidot}%
	\RequirePackage{biolinum}%
	\renewcommand\sfdefault{LinuxBiolinumT-TLF}%
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
	\csd@load@common@math@pdftex
}

%% Concrete for pdfTeX (using classic ccfonts)
\def\csd@load@concrete@pdftex{%
	\RequirePackage[T1]{fontenc}%
	\RequirePackage{ccfonts}%
	\RequirePackage{concmath}%
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
	\csd@load@common@math@pdftex
}

%% Palatino for pdfTeX (using mathpazo)
\def\csd@load@palatino@pdftex{%
	\RequirePackage[T1]{fontenc}%
	\RequirePackage{biolinum}%
	\RequirePackage{tgpagella}%
	\RequirePackage[sc]{mathpazo}%
	\RequirePackage[cal=cm,bb=stix,scr=dutchcal]{mathalpha}%
	\csd@load@common@math@pdftex
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Common Math Package Loading
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Standard mathematical typesetting packages used across all font configurations.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Common math packages for pdfTeX
\def\csd@load@common@math@pdftex{%
	\RequirePackage{amsmath}%
	\RequirePackage{amssymb}%
	\RequirePackage{amsthm}%
	\RequirePackage{bm}%
	\RequirePackage{mathrsfs}%
	\RequirePackage{mathtools}%
	\RequirePackage{moresize}%
	\RequirePackage{nicefrac}%
	\RequirePackage{siunitx}%
	\RequirePackage{thmtools}%
}

%% No-math option - disables all mathematical typesetting
\def\csd@load@nomath{%
	\RequirePackage[T1]{fontenc}%
	\PackageInfo{csdirty}{Math packages disabled}%
}

%% Execute font loading at end of preamble
\AtEndPreamble{%
	\if@csd@loadnomath
		\csd@load@nomath
	\else
		\@nameuse{csd@font@\csd@font}%
	\fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Hyperlinks and References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{nameref}
\RequirePackage[
	bookmarksnumbered=true,
	breaklinks=true,
	citecolor=MidnightBlue,
	colorlinks=true,
	frenchlinks=true,
	linkcolor=MidnightBlue,
	pagebackref,
	pdfencoding=auto,
	pdfpagelabels=true,
	pdfpagelayout=SinglePage,
	pdfstartview=FitH,
	pdfusetitle,
	unicode=true,
	urlcolor=MidnightBlue
]{hyperref}

\AtBeginDocument{%
	\RequirePackage[capitalize,nameinlink,noabbrev]{cleveref}%
	\crefname{section}{\S}{\S\S}%
	\Crefname{section}{\S}{\S\S}%
	\crefname{subsection}{\S}{\S\S}%
	\Crefname{subsection}{\S}{\S\S}%
	\crefname{subsubsection}{\S}{\S\S}%
	\Crefname{subsubsection}{\S}{\S\S}%
}

\RequirePackage{xr}

%% Customize backrefs
\renewcommand*\backref[1]{}
\renewcommand*\backrefalt[4]{%
	\ifcase#1\relax
	\or (Cited on p.~#2).%
	\else (Cited on pp.~#2).%
	\fi
}

%% Full reference command
\newcommand*\fullref[1]{\hyperref[{#1}]{\autoref*{#1}~\nameref*{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figures and Tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{adjustbox}
\RequirePackage{array}
\RequirePackage{booktabs}
\RequirePackage{caption}
\RequirePackage{colortbl}
\RequirePackage{dashbox}
\RequirePackage{diagbox}
\RequirePackage{fancybox}
\RequirePackage{float}
\RequirePackage{framed}
\RequirePackage{graphicx}
\RequirePackage{hhline}
\RequirePackage{longtable}
\RequirePackage{makecell}
\RequirePackage{multicol}
\RequirePackage{multirow}
\RequirePackage{pdflscape}
\RequirePackage{placeins}
\RequirePackage{ragged2e}
\RequirePackage{rotating}
\RequirePackage{subcaption}
\RequirePackage{tabularray}
\RequirePackage{tabularx}
\RequirePackage{threeparttable}
\RequirePackage{verbatim}
\RequirePackage{wrapfig}
\RequirePackage{xhfill}
\RequirePackage{xtab}

\AtBeginDocument{%
	\captionsetup{%
		font={rm,small},
		labelfont={color=black,sc,small},
		labelsep=period,
		skip=5pt,
		justification=justified
	}%
	\captionsetup[table]{position=bottom,skip=5pt}%
	\captionsetup[figure]{position=bottom,skip=5pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% List Customization
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{enumitem}

\setlist{nosep}
\setlist[enumerate,1]{label=(\arabic*)}
\setlist[enumerate,2]{label=(\alph*)}
\setlist[enumerate,3]{label=(\Roman*)}
\setlist[itemize,1]{label=\ensuremath{\bullet}}
\setlist[itemize,2]{label=\ensuremath{\textendash}}
\setlist[itemize,3]{label=\ensuremath{\circ}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Colored Boxes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Enhanced box environments for structured content presentation.
% Requires tcolorbox and mdframed packages for advanced styling.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[most]{tcolorbox}
\RequirePackage[
	skipabove=10pt,
	skipbelow=10pt,
	ntheorem,
	framemethod=TikZ
]{mdframed}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Annotation Command Generator
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Creates custom annotation commands for collaborative editing.
% Each annotator gets their own command with distinctive color and label.
%
% Syntax: \newguymarker{cmdname}{displaylabel}{color}
%
% Creates a new annotation command that:
%   1. Typesets argument text in specified color
%   2. Adds small caps label identifier
%   3. Places large star in margin for visual tracking
%
% Example usage:
%   \newguymarker{alice}{Alice}{Purple}
%   \alice{Check this citation}
%
% Result: Purple text "Check this citation, Alice" with purple star in margin
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand\newguymarker{mmm}{%
	\if@csd@comments
		\expandafter\newcommand\csname#1\endcsname[1]{%
			\textcolor{#3}{##1\ \textsc{#2}}%
			\marginnote{\textcolor{#3}{\LARGE$\star$}}%
		}%
	\else
		\expandafter\newcommand\csname#1\endcsname[1]{}%
	\fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Workflow Annotations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Predefined commands for common document workflow tasks.
% Active only when the comments option is enabled.
%
% Available commands:
%   \todo{text}    - Red annotations for tasks requiring completion
%   \fixme{text}   - Orange annotations for items needing correction
%   \missing{text} - Crimson highlights for incomplete content
%   \notes{text}   - Green annotations for general notes/observations
%   \query{text}   - Purple annotations for questions/uncertainties
%
% All workflow commands add margin stars for quick visual scanning.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\if@csd@comments
	\providecommand\todo[1]{%
		\textcolor{Red}{[\textsc{To-do}: #1]}%
		\marginnote{\textcolor{Red}{\LARGE$\star$}}%
	}
	\providecommand\fixme[1]{%
		\textcolor{OrangeRed}{[\textsc{Fix-me}: #1]}%
		\marginnote{\textcolor{OrangeRed}{\LARGE$\star$}}%
	}
	\providecommand\missing[1]{%
		\textcolor{Crimson}{#1}%
		\marginnote{\textcolor{Crimson}{\LARGE$\star$}}%
	}
	\providecommand\notes[1]{%
		\textcolor{ForestGreen}{[\textsc{Note}: #1]}%
		\marginnote{\textcolor{ForestGreen}{\LARGE$\star$}}%
	}
	\providecommand\query[1]{%
		\textcolor{Purple}{[\textsc{Q}: #1]}%
		\marginnote{\textcolor{Purple}{\LARGE$\star$}}%
	}
\else
	% Define empty commands when comments are disabled
	\providecommand\fixme[1]{}
	\providecommand\missing[1]{}
	\providecommand\notes[1]{}
	\providecommand\query[1]{}
	\providecommand\todo[1]{}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Revision Tracking
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Visual indicators for document modifications during collaborative editing.
% Provides change tracking without requiring external diff tools.
%
% Available commands:
%   \changed{text} - Blue highlight for modified content
%   \added{text}   - Green highlight for new additions
%   \removed{text} - Gray strikethrough for deleted content
%
% When comments are disabled, these commands pass through or remove text
% appropriately to produce a clean final output.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\if@csd@comments
	\providecommand\changed[1]{%
		\textcolor{blue}{#1}%
		\marginnote{\textcolor{blue}{\LARGE$\star$}}%
	}
	\providecommand\added[1]{%
		\textcolor{OliveGreen}{#1}%
		\marginnote{\textcolor{OliveGreen}{\LARGE$\star$}}%
	}
	\providecommand\removed[1]{%
		\textcolor{Gray}{\sout{#1}}%
		\marginnote{\textcolor{Gray}{\LARGE$\star$}}%
	}
\else
	% Clean output mode
	\providecommand\changed[1]{#1}      % Pass through changed text
	\providecommand\added[1]{#1}        % Pass through added text
	\providecommand\removed[1]{}        % Remove deleted text entirely
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Optional Feature Loading
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Epigraphs
\if@csd@loadepigraph
	\RequirePackage{epigraph}
	\setlength\epigraphrule{0.5pt}
	\setlength\epigraphwidth{0.65\textwidth}
	\renewcommand\textflush{flushright}
	\renewcommand\epigraphsize{\small}

	\let\csd@old@epigraph\epigraph
	\RenewDocumentCommand\epigraph{mm}{%
		\csd@old@epigraph{\textsf{#1}}{\smallskip\textsc{#2}}%
	}

	%% Dedication commands (book/report only)
	\@ifclassloaded{book}{%
		\NewDocumentCommand\generateDedications{m}{%
			\clearpage\thispagestyle{plain}%
			\begin{center}\vspace*{\fill}%
				\large#1%
				\vspace*{\fill}\end{center}%
			\clearpage
		}%
	}{}%
	\@ifclassloaded{report}{%
		\NewDocumentCommand\generateDedications{m}{%
			\clearpage\thispagestyle{plain}%
			\begin{center}\vspace*{\fill}%
				\large#1%
				\vspace*{\fill}\end{center}%
			\clearpage
		}%
	}{}%
\fi

%% TikZ
\if@csd@loadtikz
	\RequirePackage{pgfplots}
	\pgfplotsset{compat=1.18}
	\RequirePackage{tikz}
	\RequirePackage{tikz-cd}
	\RequirePackage{tikz-3dplot}
	\usetikzlibrary{%
		3d,
		arrows,
		arrows.meta,
		automata,
		babel,
		backgrounds,
		bending,
		calc,
		calendar,
		chains,
		circuits.ee.IEC,
		circuits.logic.IEC,
		datavisualization,
		datavisualization.formats.functions,
		decorations,
		decorations.markings,
		decorations.pathmorphing,
		decorations.shapes,
		decorations.text,
		er,
		external,
		fadings,
		fit,
		graphs,
		graphs.standard,
		hobby,
		intersections,
		lindenmayersystems,
		matrix,
		mindmap,
		patterns,
		patterns.meta,
		petri,
		plothandlers,
		plotmarks,
		positioning,
		quotes,
		scopes,
		shadows,
		shapes,
		shapes.arrows,
		shapes.callouts,
		shapes.geometric,
		shapes.misc,
		shapes.multipart,
		shapes.symbols,
		spy,
		svg.path,
		through,
		tikzmark,
		trees
	}
	\PackageInfo{csdirty}{TikZ loaded with common libraries}%
\fi

%% Appendices
\if@csd@loadappendix
	\RequirePackage[page,title,header,titletoc,toc]{appendix}
\fi

%% Theorems
\if@csd@loadtheorems
	\PackageInfo{csdirty}{Loaded thmtools for theorem environments}%
	\RequirePackage{amsthm}%
	\RequirePackage{thmtools}%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% THEOREM ENVIRONMENT CONFIGURATION
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Comprehensive theorem system using thmtools for consistent styling.
	% Provides four distinct style families:
	%   1. theoremlike    - Results requiring proof (bold headfont)
	%   2. definitionlike - Concept introductions (bold headfont)
	%   3. remarklike     - Observations and commentary (small caps headfont)
	%   4. highlightlike  - Pedagogical emphasis (sans-serif headfont)
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Number equations within sections
	\numberwithin{equation}{section}

	% Theorem style definitions
	\declaretheoremstyle[%
		headfont=\bfseries,
		notefont=\normalfont\scshape,
		bodyfont=\normalfont,
		spaceabove=3pt,
		spacebelow=3pt,
		headpunct=.,
		postheadspace=.5em
	]{csd@theoremlike}

	\declaretheoremstyle[%
		headfont=\bfseries,
		notefont=\normalfont\scshape,
		bodyfont=\normalfont,
		spaceabove=3pt,
		spacebelow=3pt,
		headpunct=.,
		postheadspace=.5em
	]{csd@definitionlike}

	\declaretheoremstyle[%
		headfont=\normalfont\scshape,
		bodyfont=\normalfont,
		spaceabove=3pt,
		spacebelow=3pt,
		headpunct=.,
		postheadspace=.5em
	]{csd@remarklike}

	\declaretheoremstyle[%
		headfont=\normalfont\sffamily,
		bodyfont=\normalfont,
		spaceabove=3pt,
		spacebelow=3pt,
		headpunct=.,
		postheadspace=.5em
	]{csd@highlightlike}

	% Base theorem environment
	\declaretheorem[%
		name=Theorem,
		style=csd@theoremlike,
		numberwithin=section
	]{theorem}

	% Helper macro for declaring sibling environments
	\newcommand\csd@declaretheoremfamily[2]{%
		\forcsvlist{\declaretheorem[sibling=theorem,style=#1]}{#2}%
	}

	% Theorem-like environments (require proof)
	\csd@declaretheoremfamily{csd@theoremlike}{%
		assertion,assumption,axiom,claim,conclusion,conjecture,corollary,%
		criterion,fact,folklore,hypothesis,lemma,observation,postulate,%
		property,proposition%
	}

	% Definition-like environments (introduce concepts)
	\csd@declaretheoremfamily{csd@definitionlike}{%
		application,construction,convention,definition,example,experiment,%
		problem,protocol,result,solution,step,notation%
	}

	% Remark-like environments (observations and commentary)
	\csd@declaretheoremfamily{csd@remarklike}{%
		commentary,discussion,exercise,motivation,notationabuse,note,%
		openproblem,question,remark,syntax%
	}

	% Highlight-like environments (pedagogical emphasis)
	\csd@declaretheoremfamily{csd@highlightlike}{%
		guideline,highlight,important,insight,keypoint,recall,summary,%
		takeaway,tip,warning%
	}

	% Unnumbered theorem variants
	\declaretheorem[name=Theorem,style=csd@theoremlike,numbered=no]{theorem*}
	\declaretheorem[name=Lemma,style=csd@theoremlike,numbered=no]{lemma*}
	\declaretheorem[name=Corollary,style=csd@theoremlike,numbered=no]{corollary*}
	\declaretheorem[name=Hypothesis,style=csd@theoremlike,numbered=no]{hypothesis*}
	\declaretheorem[name=Claim,style=csd@theoremlike,numbered=no]{claim*}
	\declaretheorem[name=Conjecture,style=csd@theoremlike,numbered=no]{conjecture*}
	\declaretheorem[name=Open Problem,style=csd@remarklike,numbered=no]{openproblem*}
	\declaretheorem[name=Syntax,style=csd@remarklike,numbered=no]{syntax*}

\fi

%% Cryptography
\if@csd@loadcrypto
	\IfFileExists{tcscrypto.sty}{%
		\RequirePackage{tcscrypto}%
		\PackageInfo{csdirty}{Loaded tcscrypto package}%
	}{%
		\PackageWarning{csdirty}{Package tcscrypto.sty not found}%
	}%
\fi

%% ORCID
\if@csd@loadorcid
	\IfFileExists{orcidlink.sty}{%
		\RequirePackage{orcidlink}%
		\PackageInfo{csdirty}{Loaded orcidlink package}%
	}{%
		\PackageWarning{csdirty}{Package orcidlink.sty not found}%
	}%
\fi

%% Nicodemus
\if@csd@loadnicodemus
	\IfFileExists{nicodemus.sty}{%
		\RequirePackage{nicodemus}%
		\PackageInfo{csdirty}{Loaded nicodemus package}%
	}{%
		\PackageWarning{csdirty}{Package nicodemus.sty not found}%
	}%
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Version Control and Comments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Comment system
\NewDocumentCommand\newcomment{mmm}{%
	\expandafter\NewDocumentCommand\csname#3\endcsname{m}{%
		\if@csd@comments
			\noindent\textcolor{#2}{\sffamily##1 -- $\mathsf{#1}$}%
		\fi
	}%
}

%% Acknowledgment environment
\AtBeginDocument{%
	\if@csd@shortversion
		\NewDocumentEnvironment{acknowledgment}{o}{}{}%
	\else
		\NewDocumentEnvironment{acknowledgment}{o}{%
			\@ifclassloaded{book}{%
				\IfNoValueTF{#1}{\chapter*{Acknowledgment}}{\chapter*{#1}}%
			}{%
				\@ifclassloaded{report}{%
					\IfNoValueTF{#1}{\chapter*{Acknowledgment}}{\chapter*{#1}}%
				}{%
					\IfNoValueTF{#1}{\paragraph*{Acknowledgment.}}{\paragraph*{#1}}%
				}%
			}%
		}{}%
	\fi
}

%% Abstract environment
\@ifclassloaded{book}{%
	\NewDocumentEnvironment{abstract}{}{%
		\begingroup\quotation\small
		\textbf{\abstractname.\ }%
		\addcontentsline{toc}{section}{\protect\abstractname}%
	}{%
		\endquotation\endgroup
	}%
}{%
	\RenewDocumentEnvironment{abstract}{}{%
		\begingroup\quotation\small
		\textbf{\abstractname.\ }%
		\addcontentsline{toc}{section}{\protect\abstractname}%
	}{%
		\endquotation\endgroup
	}%
}

%% Table of contents
\NewDocumentCommand\toc{}{%
	\clearpage\vfill
	\begin{spacing}{1.00}%
		\tableofcontents
	\end{spacing}%
	\vfill\clearpage
}

%% Bibliography
\NewDocumentCommand\printbib{O{alphaurl} m}{%
	\vfill\clearpage
	\begin{spacing}{1.00}%
		\bibliographystyle{#1}%
		\bibliography{#2}%
	\end{spacing}%
	\vfill\clearpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Title Formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{hep-title}
\titlefont{\normalfont\Huge\raggedright\itshape}
\subtitlefont{\normalfont\LARGE\raggedright\bfseries}
\authorfont{\normalfont\large\scshape\raggedright}
\affiliationfont{\normalfont\small\scshape\raggedright}
\datefont{\normalfont\normalsize\sffamily\scshape\raggedright}
\preprintfont{\normalfont\small\scshape}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% TOC Spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[titles]{tocloft}
\NewDocumentCommand\adjusttocspacing{}{%
	\addtolength\cftchapnumwidth{5pt}%
	\addtolength\cftsecnumwidth{3.5pt}%
	\addtolength\cftsubsecnumwidth{3.5pt}%
	\addtolength\cftsubsubsecnumwidth{3.5pt}%
	\addtolength\cftsecindent{5pt}%
	\addtolength\cftsubsecindent{8.5pt}%
	\addtolength\cftsubsubsecindent{12pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Section Formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{titlesec}

%% Heading fonts
\newcommand*\partheadingfont{\normalfont\bfseries\huge}
\newcommand*\chapterheadingfont{\normalfont\itshape\LARGE}
\newcommand*\sectionheadingfont{\normalfont\bfseries\Large}
\newcommand*\subsectionheadingfont{\normalfont\bfseries\large}
\newcommand*\subsubsectionheadingfont{\normalfont\bfseries\normalsize}
\newcommand*\paragraphheadingfont{\normalfont\bfseries\normalsize}
\newcommand*\subparagraphheadingfont{\normalfont\scshape\normalsize}

%% Section format commands
\newcommand*\setsectionformats{%
	\if@csd@loadoldsection
		\titleformat{\section}{\sectionheadingfont}{\S\thesection}{10pt}{}%
		\titleformat{\subsection}{\subsectionheadingfont}{\S\S\thesubsection}{10pt}{}%
		\titleformat{\subsubsection}[runin]{\subsubsectionheadingfont}{\S\S\S\thesubsubsection}{10pt}{}%
	\else
		\titleformat{\section}{\sectionheadingfont}{\thesection}{10pt}{}%
		\titleformat{\subsection}{\subsectionheadingfont}{\thesubsection}{10pt}{}%
		\titleformat{\subsubsection}[runin]{\subsubsectionheadingfont}{\thesubsubsection}{10pt}{}%
	\fi
	\titleformat{\paragraph}[runin]{\paragraphheadingfont}{\theparagraph}{10pt}{}[.]%
	\titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
	\titleformat{\subparagraph}[runin]{\subparagraphheadingfont}{\thesubparagraph}{10pt}{}[.]%
	\titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
}

\newcommand*\setchapterformat{%
	\titleformat{\chapter}[display]{\chapterheadingfont}%
	{\filleft\textnormal{\textsf{\large\chaptertitlename}~\Huge\textsf{\thechapter}}}%
	{2ex}{\titlerule\vspace{1ex}\filright}[\vspace{1ex}\titlerule]%
}

\newcommand*\setpartformat{%
\titleformat{\part}[display]{\partheadingfont}%
{\scshape\partname~{\Huge\thepart}}%
{1ex}{\scshape\titlerule\vspace{1ex}\Huge}[\vspace{1ex}\titlerule]%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PARAGRAPH HEADINGS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Provides \parhead command for inline paragraph headings with automatic
% punctuation. Appends period if text doesn't end with . ? ! :
%
% Implementation uses delimiter-based parsing to detect trailing punctuation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifcsd@haspunctuation

\def\csd@checkpunctuation#1{%
	\ifx\csd@checkpunctuation#1\csd@checkpunctuation
	\else
		\csd@haspunctuationtrue
	\fi
}

\def\csd@checkdot#1.\csd@delim#2\csd@stop{\csd@checkpunctuation{#2}}
\def\csd@checkquestion#1?\csd@delim#2\csd@stop{\csd@checkpunctuation{#2}}
\def\csd@checkexclam#1!\csd@delim#2\csd@stop{\csd@checkpunctuation{#2}}
\def\csd@checkcolon#1:\csd@delim#2\csd@stop{\csd@checkpunctuation{#2}}

\def\csd@appendpunctuationifneeded#1{%
	\csd@haspunctuationfalse
	\csd@checkdot#1\csd@delim.\csd@delim\csd@stop
	\csd@checkquestion#1\csd@delim?\csd@delim\csd@stop
	\csd@checkexclam#1\csd@delim!\csd@delim\csd@stop
	\csd@checkcolon#1\csd@delim:\csd@delim\csd@stop
	#1\ifcsd@haspunctuation \else.\fi%
}

\def\csd@ignorewhitespaceandimplicitpars{%
	\begingroup
	\catcode13=10 %
	\@ifnextchar\relax
	{\endgroup}
	{\endgroup}%
}

\NewDocumentCommand{\csd@paragraphhead}{m}{%
	\smallskip
	\noindent
	\textbf{\boldmath\ignorespaces\csd@appendpunctuationifneeded{#1}}%
	\hskip 0.9em plus 0.3em minus 0.3em
	\csd@ignorewhitespaceandimplicitpars
}

\NewDocumentCommand{\parhead}{m}{\csd@paragraphhead{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BROKEN REFERENCE DETECTION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Adds visual margin markers (colored stars) for undefined citations and
% references. Aids in document proofreading and debugging.
%
% Markers appear in document margins with label text indicating the
% undefined reference key.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\providecommand{\csd@colorize}{\color{Firebrick2}}

\newcommand{\csd@brokenrefmark}[1]{%
	\marginnote[%
		{\csd@colorize\normalfont\smash{\LARGE$\star$}\ \tiny\sffamily#1}%
	]{%
		{\csd@colorize\normalfont\smash{\LARGE$\star$}\ \tiny\sffamily#1}%
	}%
}

\newbool{csd@markundef}
\booltrue{csd@markundef}

\xpretocmd{\G@refundefinedtrue}{%
	\ifbool{csd@markundef}{%
		\csd@brokenrefmark{\@ifundefined{@citeb}{}{\@citeb}}%
	}{}%
}{}{}

\let\csd@old@setref=\@setref
\renewcommand{\@setref}[3]{%
	\ifx#1\relax \csd@brokenrefmark{#3}\fi%
	\csd@markundeffalse%
	\csd@old@setref{#1}{#2}{#3}%
	\csd@markundeftrue%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Useful Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\if@csd@loaduseful
	%% Custom lists
	\newlist{points}{itemize}{1}
	\setlist[points]{label=\textendash,leftmargin=1em,itemsep=1pt,before=\smallskip,after=\smallskip}

	\newlist{codelist}{enumerate}{1}
	\setlist[codelist,1]{label=\textcolor{gray}{\texttt{[\arabic*]}},leftmargin=1em,itemsep=1pt}

	\newlist{checkbox}{itemize}{1}
	\setlist[checkbox]{label=$\square$,leftmargin=1em}
	\newcommand*\checked{\item[\checkmark]}

	\newlist{deflist}{description}{1}
	\setlist[deflist]{labelwidth=0.35\textwidth,labelsep=1em,leftmargin=0.35\textwidth,%
		font=\normalfont\bfseries,style=nextline,itemsep=5pt}

	%% Text commands
	\newcommand*\highlightcolor{RoyalBlue}
	\newcommand*\sethighlightcolor[1]{\renewcommand*\highlightcolor{#1}}
	\newcommand*\emphmath[1]{\textcolor{\highlightcolor}{\mathrm{#1}}}
	\newcommand*\emphtext[1]{\textcolor{\highlightcolor}{#1}}
	\newcommand*\textbi[1]{\textbf{\textit{#1}}}
	\newcommand*\textem[1]{\textcolor{\highlightcolor}{#1}}
	\newcommand*\code[1]{\texttt{#1}}
	\newcommand*\mathsc[1]{\textnormal{\textsc{#1}}}
	\newcommand*\mathbi[1]{\textnormal{\textbf{\textit{#1}}}}
	\newcommand*\inmath[1]{\ensuremath{#1}}
	\mathchardef\mathhyphen="2D
	\newcommand*\putInQuotes[1]{``#1''}
	\newcommand*\strike[1]{\bgroup\ULdepth=-.55ex\ULset{#1}\egroup}

	%% Box environments
	\NewDocumentEnvironment{bashbox}{}{%
		\begin{adjustbox}{minipage=\textwidth,precode=\dbox}%
			\centering\medskip
			\begin{minipage}{0.975\textwidth}\noindent
				}{%
			\end{minipage}\medskip
		\end{adjustbox}%
	}

	\NewDocumentEnvironment{protocolbox}{o}{%
		\begin{mdframed}[font=\small,roundcorner=1.5pt,linewidth=0.5pt,%
				skipabove=0.5\baselineskip,skipbelow=0.1\baselineskip,%
				innerleftmargin=5pt,innerrightmargin=5pt,innertopmargin=5pt,innerbottommargin=5pt]%
			\IfNoValueF{#1}{\noindent\textbf{#1}\par\smallskip\hrule height0.4pt\vspace{0.5\baselineskip}}%
			\begin{points}%
				}{%
			\end{points}%
		\end{mdframed}%
	}

	\NewDocumentEnvironment{codelistbox}{o}{%
		\begin{mdframed}[font=\small,roundcorner=1.5pt,linewidth=0.5pt,%
				skipabove=0.5\baselineskip,skipbelow=0.1\baselineskip,%
				innerleftmargin=5pt,innerrightmargin=5pt,innertopmargin=5pt,innerbottommargin=5pt]%
			\IfNoValueF{#1}{\noindent\textbf{#1}\par\smallskip\hrule height0.4pt\vspace{0.5\baselineskip}}%
			\begin{codelist}%
				}{%
			\end{codelist}%
		\end{mdframed}%
	}

	\NewDocumentEnvironment{simplebox}{o}{%
		\begin{mdframed}[font=\small,roundcorner=1.5pt,linewidth=0.5pt,%
				skipabove=0.5\baselineskip,skipbelow=0.1\baselineskip,%
				innerleftmargin=5pt,innerrightmargin=5pt,innertopmargin=5pt,innerbottommargin=5pt]%
			\IfNoValueF{#1}{\noindent\textbf{#1}\par\smallskip\hrule height0.4pt\vspace{0.5\baselineskip}}%
			}{%
		\end{mdframed}%
	}

	\newtcolorbox{wirebox}{%
		colframe=black,colback=white,sharp corners,boxrule=0.5pt,%
		coltitle=black,colbacktitle=white,boxsep=5pt,top=0pt,bottom=0pt,left=5pt,right=5pt%
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Upright Greek Letters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\if@csd@modgreek
	\RequirePackage{upgreek}

	%% Define missing uppercase macros
	\providecommand*\Alpha{\mathrm{A}}
	\providecommand*\Beta{\mathrm{B}}
	\providecommand*\Chi{\mathrm{X}}
	\providecommand*\Epsilon{\mathrm{E}}
	\providecommand*\Eta{\mathrm{H}}
	\providecommand*\Iota{\mathrm{I}}
	\providecommand*\Kappa{\mathrm{K}}
	\providecommand*\Mu{\mathrm{M}}
	\providecommand*\Nu{\mathrm{N}}
	\providecommand*\Omicron{\mathrm{O}}
	\providecommand*\Rho{\mathrm{R}}
	\providecommand*\Tau{\mathrm{T}}
	\providecommand*\Zeta{\mathrm{Z}}
	\providecommand*\omicron{\mathrm{o}}

	%% Override with upright versions if available
	\@ifundefined{Upalpha}{}{\renewcommand*\Alpha{\Upalpha}}
	\@ifundefined{Upbeta}{}{\renewcommand*\Beta{\Upbeta}}
	\@ifundefined{Upchi}{}{\renewcommand*\Chi{\Upchi}}
	\@ifundefined{Updelta}{}{\renewcommand*\Delta{\Updelta}}
	\@ifundefined{Upepsilon}{}{\renewcommand*\Epsilon{\Upepsilon}}
	\@ifundefined{Upeta}{}{\renewcommand*\Eta{\Upeta}}
	\@ifundefined{Upgamma}{}{\renewcommand*\Gamma{\Upgamma}}
	\@ifundefined{Upiota}{}{\renewcommand*\Iota{\Upiota}}
	\@ifundefined{Upkappa}{}{\renewcommand*\Kappa{\Upkappa}}
	\@ifundefined{Uplambda}{}{\renewcommand*\Lambda{\Uplambda}}
	\@ifundefined{Upmu}{}{\renewcommand*\Mu{\Upmu}}
	\@ifundefined{Upnu}{}{\renewcommand*\Nu{\Upnu}}
	\@ifundefined{Upomega}{}{\renewcommand*\Omega{\Upomega}}
	\@ifundefined{Upomicron}{}{\renewcommand*\Omicron{\Upomicron}}
	\@ifundefined{Upphi}{}{\renewcommand*\Phi{\Upphi}}
	\@ifundefined{Uppi}{}{\renewcommand*\Pi{\Uppi}}
	\@ifundefined{Uppsi}{}{\renewcommand*\Psi{\Uppsi}}
	\@ifundefined{Uprho}{}{\renewcommand*\Rho{\Uprho}}
	\@ifundefined{Upsigma}{}{\renewcommand*\Sigma{\Upsigma}}
	\@ifundefined{Uptau}{}{\renewcommand*\Tau{\Uptau}}
	\@ifundefined{Uptheta}{}{\renewcommand*\Theta{\Uptheta}}
	\@ifundefined{Upupsilon}{}{\renewcommand*\Upsilon{\Upupsilon}}
	\@ifundefined{Upxi}{}{\renewcommand*\Xi{\Upxi}}
	\@ifundefined{Upzeta}{}{\renewcommand*\Zeta{\Upzeta}}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Fancy Headers (Simple Version)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*\simplefancyheader{%
	\RequirePackage{fancyhdr}%
	\pagestyle{fancy}%
	\fancyhf{}%
	\fancyhead[LE,RO]{\rmfamily\small\textnormal{\@title}}%
	\fancyhead[RE,LO]{\rmfamily\small\thepage}%
	\fancyfoot{}%
	\setlength\headheight{12pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Class-Specific Setup
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Applies appropriate formatting based on detected document class.
% Different classes require different heading structures and TOC handling.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AtBeginDocument{%
	\@ifclassloaded{article}{%
		\setsectionformats
		\setpartformat
	}{}%
	\@ifclassloaded{report}{%
		\setpartformat
		\setchapterformat
		\setsectionformats
		\simplefancyheader
		\adjusttocspacing
	}{}%
	\@ifclassloaded{book}{%
		\setpartformat
		\setchapterformat
		\setsectionformats
		\simplefancyheader
		\adjusttocspacing
	}{}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Document-Level Customizations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Redefines standard LaTeX commands at document start to integrate with
% package functionality and provide enhanced typographic control.
%
% Customizations:
%   - \paragraph    → Uses \parhead for consistent formatting
%   - \subparagraph → Small caps styling for hierarchical clarity
%   - \Pr           → Sans-serif probability operator
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AtBeginDocument{%
	% Redefine paragraph to use enhanced paragraph head
	\renewcommand\paragraph[1]{\parhead{#1}}%

	% Mathematical probability operator in sans-serif
	\renewcommand\Pr{\mathop{\mathsf{Pr}}}%
}

\endinput
%% End of csdirty.sty