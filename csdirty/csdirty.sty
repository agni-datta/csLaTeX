%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csdirty.sty - A Modern Academic LaTeX Package by Agni Datta
% Unified package suite for research, technical, and academic documents
%
% DESCRIPTION:
% csdirty is a comprehensive LaTeX package that streamlines academic and technical
% document preparation. It consolidates essential and advanced packages, and provides
% a flexible interface for version control, feature toggling, and professional typesetting.
% Designed for research papers, technical reports, and academic submissions, csdirty
% enables rapid switching between full/preprint and short/conference versions, and
% offers robust support for cryptography, mathematics, graphics, and more.
%
% USAGE:
%   \usepackage[<options>]{csdirty}
%   % Example: \usepackage[full,comments,crypto]{csdirty}
%
% AVAILABLE OPTIONS (all options have both positive and negative forms):
%
% VERSION CONTROL:
%   fullversion      - Full document (authors, affiliations, appendices, etc.)
%   shortversion     - Abbreviated version (no appendices, detailed proofs, etc.)
%   preprint         - Alias for fullversion (for arXiv/preprints)
%
% COMMENTS & ANNOTATIONS:
%   comments         - Enable inline comments/annotations (loads comment package)
%   nocomments       - Disable comment functionality (default)
%
% MATH & FONTS:
%   concmath         - Use Concmath for advanced math typesetting
%   nomath           - Disable advanced math packages (basic LaTeX math only)
%   libertinus       - Use Libertinus/Libertine font family for text/math
%   nolicertinus     - Do not use Libertinus/Libertine fonts
%   nicodemus        - Enable Nicodemus cryptography macros
%   nonicodemus      - Do not load Nicodemus macros
%
% FEATURE LOADING:
%   tikz             - Load TikZ suite (3dplot, cd, automata, circuits, etc.)
%   notikz           - Do not load TikZ or related graphics packages
%   appendix         - Enhanced appendix formatting and management
%   noappendix       - Do not load appendix enhancements
%   crypto           - Cryptography packages and notation (protocols, security, etc.)
%   nocrypto         - Do not load cryptography packages
%   theorems         - Enhanced theorem/proof environments and cross-referencing
%   notheorems       - Do not load theorem/proof enhancements
%   orcidlink        - ORCID link support for author identification
%   noorcidlink      - Do not load ORCID link package
%   epigraph         - Enhanced epigraph formatting and styling
%   noepigraph       - Do not load epigraph enhancements
%   fullpage         - Advanced full-page layout and formatting
%   nofullpage       - Do not load full-page layout options
%   nicespacing      - Enhanced line spacing (1.15 stretch factor)
%   badspacing       - Standard line spacing (1.0, default)
%   full             - Load all available features (recommended for full academic docs)
%   usefulcommands   - Load handy macros for cryptography, math, and writing
%   nousefulcommands - Do not load the macro suite
%   oldsection       - Use old section symbol formatting (with section symbols)
%
% ENHANCED FEATURES:
%   - Advanced Graphics: PGFPlots (compatibility mode 1.18) for data visualization
%   - Colored Content Boxes: tcolorbox for styled content and wireboxes
%   - Framed Environments: mdframed for theorem/content boxes with TikZ rendering
%   - Advanced Tables: tabularray for complex, multi-page, and styled tables
%   - TikZ Libraries: 3D plotting, commutative diagrams, automata, circuits, decorations, positioning, shapes, arrows
%   - Full-Page Layout: Professional page geometry and layout
%   - Enhanced Typography: Improved spacing, microtypography, and readability
%   - Useful Commands: Macros for cryptography, math, and general writing
%
% EXAMPLES:
%   \usepackage{csdirty}                                   % Basic usage with defaults
%   \usepackage[fullversion]{csdirty}                      % Full version with all features
%   \usepackage[shortversion,nocomments]{csdirty}          % Short version, no comments
%   \usepackage[tikz,crypto]{csdirty}                      % With TikZ and crypto
%   \usepackage[theorems,orcidlink]{csdirty}               % Theorem formatting and ORCID
%   \usepackage[epigraph,fullpage]{csdirty}                % Epigraphs and full-page layout
%   \usepackage[nicespacing]{csdirty}                      % Enhanced line spacing
%   \usepackage[full]{csdirty}                             % All features
%   \usepackage[notikz]{csdirty}                           % Exclude TikZ
%   \usepackage[noappendix,noepigraph]{csdirty}            % Exclude appendix and epigraph features
%   \usepackage[libertinus,concmath,crypto]{csdirty}        % Libertinus font, Concmath, and crypto
%
% CODE USAGE EXAMPLES:
%   % Colored content box (tcolorbox)
%   \begin{tcolorbox}[colback=blue!5!white, colframe=blue!75!black, title=Example Box]
%   This is a styled content box.
%   \end{tcolorbox}
%
%   % Wirebox (if tcolorbox loaded)
%   \begin{wirebox}
%   This is a wirebox for highlighting content.
%   \end{wirebox}
%
%   % Advanced table (tabularray is always loaded)
%   \begin{tblr}{
%     colspec = {Q[l]Q[c]Q[r]},
%     row{1} = {font=\bfseries}
%   }
%   Header 1 & Header 2 & Header 3 \\
%   Left     & Center   & Right    \\
%   \end{tblr}
%
% DEPENDENCIES:
% Core dependencies (always loaded):
%   - amsmath, amssymb (mathematical notation)
%   - geometry (page layout)
%   - hyperref (hyperlinks and references)
%   - tabularray (advanced tables)
%   - setspace (line spacing control)
%   - microtype (enhanced typography)
%
% Optional dependencies (loaded based on options):
%   - tikz, tikz-cd, tikz-3dplot (tikz option)
%   - pgfplots (data visualization)
%   - tcolorbox (colored content boxes)
%   - mdframed (framed environments)
%   - comment (comments option)
%   - cryptography packages (crypto option)
%   - csthm (theorems option)
%   - orcidlink (orcidlink option)
%   - appendix (appendix option)
%   - epigraph (epigraph option)
%   - layout packages (fullpage option)
%   - libertinus, unicode-math, fontspec (libertinus option)
%   - concmath (concmath option)
%   - nicodemus (nicodemus option)
%
% COMPATIBILITY:
%   - Compatible with modern LaTeX distributions (TeX Live 2022+, MiKTeX 23+)
%   - Tested with: article, report, book, and other standard classes
%   - Requires e-TeX extensions (standard in modern LaTeX)
%
% KNOWN ISSUES & LIMITATIONS:
%   - Version control options may require manual adjustment for complex documents
%   - TikZ graphics may require multiple compilation passes for complex diagrams
%   - PGFPlots compatibility mode 1.18 may need adjustment for newer versions
%   - Full-page layout options may conflict with some document class settings
%   - Enhanced spacing may affect layout and require fine-tuning
%   - Some options may increase compilation time and memory usage
%
% VERSION: 1.6
% DATE: 2025/06/26
% AUTHOR: Agni Datta
% LICENSE: LaTeX Project Public License 1.3c
% CONTACT: agnidatta.org@gmail.com
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesPackage{csdirty}[2025/06/26 v1.6 csdirty package]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Package Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% General Boolean flags
\newif\ifComments                       \Commentsfalse
\newif\ifFullVersion                    \FullVersionfalse
\newif\ifShortVersion                   \ShortVersionfalse

% Package-specific Boolean flags
\newif\ifcsdirty@Concmath               \csdirty@Concmathfalse
\newif\ifcsdirty@Libertinus             \csdirty@Libertinusfalse
\newif\ifcsdirty@Nicodemus              \csdirty@Nicodemusfalse
\newif\ifcsdirty@LoadAppendix           \csdirty@LoadAppendixfalse
\newif\ifcsdirty@LoadCrypto             \csdirty@LoadCryptofalse
\newif\ifcsdirty@LoadEpigraph           \csdirty@LoadEpigraphfalse
\newif\ifcsdirty@LoadFull               \csdirty@LoadFulltrue
\newif\ifcsdirty@LoadFullPage           \csdirty@LoadFullPagefalse
\newif\ifcsdirty@LoadNiceSpacing        \csdirty@LoadNiceSpacingfalse
\newif\ifcsdirty@LoadNoMath             \csdirty@LoadNoMathfalse
\newif\ifcsdirty@LoadOldSectionSymb     \csdirty@LoadOldSectionSymbfalse
\newif\ifcsdirty@LoadOrcidlink          \csdirty@LoadOrcidlinkfalse
\newif\ifcsdirty@LoadTheorems           \csdirty@LoadTheoremsfalse
\newif\ifcsdirty@LoadTikz               \csdirty@LoadTikzfalse
\newif\ifcsdirty@LoadUsefulCommands     \csdirty@LoadUsefulCommandstrue

% Version control options
\DeclareOption{fullversion}{\FullVersiontrue\ShortVersionfalse}             % Use full version
\DeclareOption{shortversion}{\ShortVersiontrue\FullVersionfalse}            % Use short version
\DeclareOption{preprint}{\ShortVersionfalse\FullVersiontrue}                % Preprint = full version

% Comment and annotation options
\DeclareOption{appendix}{\csdirty@LoadAppendixtrue}                         % Load Appendix
\DeclareOption{badspacing}{\csdirty@LoadNiceSpacingfalse}                   % Load Bad Spacing
\DeclareOption{comments}{\Commentstrue}                                     % Enable comments
\DeclareOption{concrete}{\csdirty@Concmathtrue}                             % Enable Concmath
\DeclareOption{crypto}{\csdirty@LoadCryptotrue}                             % Load Cryptography
\DeclareOption{epigraph}{\csdirty@LoadEpigraphtrue}                         % Load Epigraphs
\DeclareOption{full}{\csdirty@LoadFulltrue}                                 % Load Full
\DeclareOption{fullpage}{\csdirty@LoadFullPagetrue}                         % Load Full Page
\DeclareOption{libertinus}{\csdirty@Libertinustrue}                         % Enable Libertinus/Libertine font
\DeclareOption{nicodemus}{\csdirty@Nicodemustrue}                           % Enable Nicodemus macros
\DeclareOption{nicespacing}{\csdirty@LoadNiceSpacingtrue}                   % Load Nice Spacing
\DeclareOption{noappendix}{\csdirty@LoadAppendixfalse}                      % Do not load Appendix
\DeclareOption{nocomments}{\Commentsfalse}                                  % Disable comments
\DeclareOption{nocrypto}{\csdirty@LoadCryptofalse}                          % Do not load Cryptography
\DeclareOption{noepigraph}{\csdirty@LoadEpigraphfalse}                      % Do not load Epigraphs
\DeclareOption{nofullpage}{\csdirty@LoadFullPagefalse}                      % Do not load Full Page
\DeclareOption{nomath}{\csdirty@LoadNoMathtrue}                             % Disable math packages
\DeclareOption{noorcidlink}{\csdirty@LoadOrcidlinkfalse}                    % Do not load ORCID link
\DeclareOption{notheorems}{\csdirty@LoadTheoremsfalse}                      % Do not load Theorems
\DeclareOption{notikz}{\csdirty@LoadTikzfalse}                              % Do not load TikZ
\DeclareOption{nousefulcommands}{\csdirty@LoadUsefulCommandsfalse}          % Do not load Useful Commands
\DeclareOption{oldsection}{\csdirty@LoadOldSectionSymbtrue}                 % Load old section symbol
\DeclareOption{orcidlink}{\csdirty@LoadOrcidlinktrue}                       % Load ORCID link
\DeclareOption{theorems}{\csdirty@LoadTheoremstrue}                         % Load Theorems
\DeclareOption{tikz}{\csdirty@LoadTikztrue}                                 % Load TikZ
\DeclareOption{usefulcommands}{\csdirty@LoadUsefulCommandstrue}             % Load Useful Commands

\ifcsdirty@LoadFull
    \typeout{csdirty: Loading full version}
    \csdirty@LoadAppendixtrue
    \csdirty@LoadEpigraphtrue
    \csdirty@LoadNiceSpacingtrue
    \csdirty@LoadOrcidlinktrue
    \csdirty@LoadTheoremstrue
    \csdirty@LoadTikztrue
    \csdirty@LoadUsefulCommandstrue
\fi

% Ignore unknown options
\DeclareOption*{\relax}
\ProcessOptions\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core Programming and Utility Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{calc}                                        % Arithmetic with lengths
\RequirePackage{comment}                                     % Block comment environment
\RequirePackage{etoolbox}                                    % Logic and macro patching
\RequirePackage{ifpdf}                                       % Detect PDF output mode
\RequirePackage{iftex}                                       % Detect engine: pdfTeX, XeTeX, LuaTeX
\RequirePackage{xkeyval}                                     % Key-value parsing
\RequirePackage{xparse}                                      % Extended command/environment definitions

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Engine and Class Compatibility Warnings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifLuaTeX
    \typeout{csdirty: rock on! LuaTeX engine detected (this is the good stuff)}
\else
    \ifXeTeX
        \typeout{csdirty: nice! XeTeX engine detected (you're doing it right)}
    \else
        \PackageWarning{csdirty}{%
            pdfTeX engine detected. Concrete math option requires LuaTeX or XeTeX for full Unicode support.
        }%
    \fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Check for supported document classes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\@ifclassloaded{article}{%
    \typeout{csdirty: article class spotted (we got you covered)}
}{%
    \@ifclassloaded{report}{%
        \typeout{csdirty: report class spotted (looking good)}
    }{%
        \@ifclassloaded{book}{%
            \typeout{csdirty: book class spotted (you're all set)}
        }{%
            \PackageWarning{csdirty}{%
                uh oh! unsupported document class detected.
                this package only plays nice with article, report, or book classes :(
                your class (\@classload) has not been tested with this package yet.
                you may encounter issues with the package.
            }%
        }%
    }%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Color
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[x11names, dvipsnames, svgnames]{xcolor}      % Extended color support.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PDF and Document Structure Control
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[2.0,objcompress,compress]{bxpdfver}          % PDF version and compression management
\RequirePackage[nottoc]{tocbibind}                           % Add bibliography/lists to TOC (exclude TOC itself)
\RequirePackage{babel}                                       % Language, hyphenation
\RequirePackage{pdfpages}                                    % Include external PDFs
\RequirePackage{refcount}                                    % Reference counting

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Margin and Spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsdirty@LoadFullPage
    \RequirePackage[a4paper, margin=2.5cm]{geometry}         % Page layout
    \typeout{csdirty: Loading full page layout}
\else
    \RequirePackage[a4paper, margin=3.5cm]{geometry}         % Page layout (default)
    \typeout{csdirty: Loading default page layout}
\fi

\RequirePackage{setspace}
\ifcsdirty@LoadNiceSpacing
    \setstretch{1.15}
\else
    \setstretch{1.0}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Text, Layout, and Miscellaneous Enhancements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[autostyle=true, csdisplay=true]{csquotes}    % Automatic quotation marks and smart citations
\RequirePackage[final]{microtype}                            % Improved justification and hyphenation
\RequirePackage[full]{textcomp}                              % Additional text symbols (e.g., degree sign)
\RequirePackage[nocompress]{cite}                            % Citation package for references
\RequirePackage[normalem]{ulem}                              % Underlining and strikethrough capabilities
\RequirePackage{emptypage}                                   % No page numbers on empty pages
\RequirePackage{lipsum}                                      % Dummy text
\RequirePackage{paralist}                                    % Long List Style environments
\RequirePackage{pifont}                                      % For using Dingbat fonts
\RequirePackage{soul}                                        % For text highlighting
\RequirePackage{xspace}                                      % Intelligent spacing after macros
\RequirePackage{xurl}                                        % Breakable URLs

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fonts and Math
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Modular font/math loader for csdirty

% No Math Loader
\newcommand{\csdirty@loadnomath}{%
    \typeout{csdirty: Loading no math packages}           % Print info to log
    \RequirePackage[T1]{fontenc}                          % Use T1 font encoding
}

% Libertinus Math Loader
\newcommand{\csdirty@loadlibertinus}{%
    \ifLuaTeX
        \typeout{csdirty: Loading Libertinus math for LuaTeX}      % Print info to log
        \RequirePackage[T1]{fontenc}                               % Use T1 font encoding for text
        \RequirePackage{amssymb}                                   % AMS math symbols
        \RequirePackage{mathtools}                                 % Math tools extension
        \RequirePackage{moresize}                                  % More font sizes
        \RequirePackage{nicefrac}                                  % Nice fractions
        \RequirePackage{siunitx}                                   % SI units
        \RequirePackage{fontspec}                                  % Font selection for LuaTeX
        \RequirePackage{unicode-math}                              % Unicode math support
        \RequirePackage{libertineRoman}                            % Libertine Roman font (text)
        % Set main (serif) font
        \setmainfont[%
            Scale=MatchUppercase
        ]{linuxlibertineo}
        % Set math font
        \setmathfont[%
            Scale=MatchUppercase
        ]{libertinusmath}
        % Set monospaced font
        \setmonofont[%
            Scale=MatchLowercase,
            SmallCapsFeatures={RawFeature=+smcp},                               % Enable small caps
            RawFeature={+calt,+case,+dlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum}  % Typographic features
        ]{notosansmono}
        % Set sans-serif font
        \setsansfont[%
            Scale=MatchLowercase,
            SmallCapsFeatures={RawFeature=+smcp},                               % Enable small caps
            RawFeature={+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum}  % Typographic features
        ]{ysabeau}
        % Avoid conflicts with math font packages
        \let\mathbfcal\relax
        \let\mathbfscr\relax
        \RequirePackage{mathrsfs}                                  % Script math font (\mathscr)
        \RequirePackage[cal=cm,bb=bboldx,scr=esstix]{mathalpha}    % Math alphabets: cal, blackboard bold, script
    \else
        \ifXeTeX
            \typeout{csdirty: Loading Libertinus math for XeTeX}   % Print info to log
            \RequirePackage[T1]{fontenc}                           % Use T1 font encoding for text
            \RequirePackage{amssymb}                               % AMS math symbols
            \RequirePackage{mathtools}                             % Math tools extension
            \RequirePackage{moresize}                              % More font sizes
            \RequirePackage{nicefrac}                              % Nice fractions
            \RequirePackage{siunitx}                               % SI units
            \RequirePackage{fontspec}                              % Font selection for XeTeX
            \RequirePackage{unicode-math}                          % Unicode math support
            \RequirePackage{libertineRoman}                        % Libertine Roman font (text)
            % Set main (serif) font
            \setmainfont[%
                Scale=MatchUppercase,                                               % Scaling Factor
                SmallCapsFeatures={RawFeature=+smcp},                               % Enable small caps
                RawFeature={+calt,+case,+dlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum}  % Typographic features
            ]{linuxlibertineo}
            % Set math font
            \setmathfont[%
                Scale=MatchUppercase,                                               % Scaling Factor
                SmallCapsFeatures={RawFeature=+smcp},                               % Enable small caps
                RawFeature={+calt,+case,+dlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum}  % Typographic features
            ]{libertinusmath}
            % Set monospaced font
            \setmonofont[%
                Scale=MatchLowercase,                                               % Scaling Factor
                SmallCapsFeatures={RawFeature=+smcp},                               % Enable small caps
                RawFeature={+calt,+case,+dlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum}  % Typographic features
            ]{notosansmono}
            % Set sans-serif font
            \setsansfont[%
                Scale=MatchLowercase,                                               % Scaling Factor
                SmallCapsFeatures={RawFeature=+smcp},                               % Enable small caps
                RawFeature={+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum}  % Typographic features
            ]{ysabeau}
            % Avoid conflicts with math font packages
            \let\mathbfcal\relax
            \let\mathbfscr\relax
            \RequirePackage{mathrsfs}                              % Script math font (\mathscr)
            \RequirePackage[cal=cm,bb=bboldx,scr=esstix]{mathalpha}% Math alphabets: cal, blackboard bold, script
        \else
            \typeout{csdirty: Libertinus math setup not supported for this engine.}
        \fi
    \fi
}

% Concrete Math Loader
\newcommand{\csdirty@loadconcmath}{%
    \ifLuaTeX
        \typeout{csdirty: Loading Concrete math for LuaTeX}           % Print info to log
        \RequirePackage[T1]{fontenc}                                  % Use T1 font encoding
        \RequirePackage{amssymb}                                      % AMS math symbols
        \RequirePackage{mathtools}                                    % Math tools extension
        \RequirePackage{moresize}                                     % More font sizes
        \RequirePackage{nicefrac}                                     % Nice fractions
        \RequirePackage{siunitx}                                      % SI units
        \RequirePackage{fontspec}                                     % Font selection for LuaTeX
        \RequirePackage{unicode-math}                                 % Unicode math support
        \RequirePackage[concrete]{fontsetup}                          % Concrete font setup
        \let\mathbfcal\relax                                          % Avoid conflicts: clear \mathbfcal
        \let\mathbfscr\relax                                          % Avoid conflicts: clear \mathbfscr
        \RequirePackage{mathrsfs}                                     % Script math font
        \RequirePackage[cal=cm,bb=bboldx,scr=esstix]{mathalpha}       % Math alphabets
    \else
        \ifXeTeX
            \typeout{csdirty: Loading Concrete math for XeTeX}        % Print info to log
            \RequirePackage[T1]{fontenc}                              % Use T1 font encoding
            \RequirePackage{amssymb}                                  % AMS math symbols
            \RequirePackage{mathtools}                                % Math tools extension
            \RequirePackage{moresize}                                 % More font sizes
            \RequirePackage{nicefrac}                                 % Nice fractions
            \RequirePackage{siunitx}                                  % SI units
            \RequirePackage{fontspec}                                 % Font selection for XeTeX
            \RequirePackage{unicode-math}                             % Unicode math support
            \RequirePackage[concrete]{fontsetup}                      % Concrete font setup
            \let\mathbfcal\relax                                      % Avoid conflicts: clear \mathbfcal
            \let\mathbfscr\relax                                      % Avoid conflicts: clear \mathbfscr
            \RequirePackage{mathrsfs}                                 % Script math font
            \RequirePackage[cal=cm,bb=bboldx,scr=esstix]{mathalpha}   % Math alphabets
        \else
            \typeout{csdirty: Concrete math setup not supported for this engine.} % Print info to log
        \fi
    \fi
}

% Standard Math Loader
\newcommand{\csdirty@loadstdmath}{%
    \typeout{csdirty: Loading standard math packages}                % Print info to log
    \RequirePackage[T1]{fontenc}                                     % Use T1 font encoding
    \RequirePackage{amsfonts}                                        % AMS fonts
    \RequirePackage{amsmath}                                         % AMS math
    \RequirePackage{amssymb}                                         % AMS math symbols
    \RequirePackage{bm}                                              % Bold math symbols
    \RequirePackage{mathrsfs}                                        % Script math font
    \RequirePackage{mathtools}                                       % Math tools extension
    \RequirePackage{moresize}                                        % More font sizes
    \RequirePackage{nicefrac}                                        % Nice fractions
    \RequirePackage{siunitx}                                         % SI units
    \RequirePackage{lmodern}                                         % Latin Modern fonts
    \RequirePackage[cal=cm,bb=bboldx,scr=esstix]{mathalpha}          % Math alphabets
}

% Main Loader Switch
\AtEndPreamble{%
    \ifcsdirty@LoadNoMath
        \csdirty@loadnomath
    \else
        \ifcsdirty@Libertinus
            \csdirty@loadlibertinus
        \else
            \ifcsdirty@Concmath
                \csdirty@loadconcmath
            \else
                \csdirty@loadstdmath
            \fi
        \fi
    \fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hyperlinks & Referencing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{nameref}                                     % Name-based referencing
\RequirePackage[%
    bookmarksnumbered=true,                                  % Number PDF bookmarks
    breaklinks=true,                                         % Allow links to break over lines
    citecolor=SlateBlue2,                                    % Color for citations
    colorlinks=true,                                         % Use colored links
    frenchlinks=true,                                        % Use small caps for links
    linkcolor=RoyalBlue2,                                    % Color for internal links
    pagebackref,                                             % Back-references from bibliography
    pdfencoding=auto,                                        % Automatic encoding detection
    pdfpagelabels=true,                                      % Correct page labels in PDF
    pdfpagelayout=SinglePage,                                % Single page view
    pdfstartview=FitH,                                       % Fit the page to the window
    pdfusetitle,                                             % Use document title as PDF title
    unicode=true,                                            % Support for Unicode
    urlcolor=SpringGreen4                                    % Color for URLs
]{hyperref}
\AtBeginDocument{%
    \RequirePackage[capitalize,nameinlink,noabbrev]{cleveref} % Clever references
    % Sectioning names for cleveref
    \crefname{section}{\textsection}{\textsection\textsection}
    \Crefname{section}{\textsection}{\textsection\textsection}
    \crefname{subsection}{\textsection}{\textsection\textsection}
    \Crefname{subsection}{\textsection}{\textsection\textsection}
    \crefname{subsubsection}{\textsection}{\textsection\textsection}
    \Crefname{subsubsection}{\textsection}{\textsection\textsection}
}
\RequirePackage{xr}                                           % Cross-document references
% Customize backrefs
\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
    \ifcase #1\or (Cited on p.~#2).%
    \else (Cited on pp.~#2).%
    \fi
}
% Full reference combining hyperref, autoref, and nameref.
\newcommand*{\fullref}[1]{\hyperref[{#1}]{\autoref*{#1}~\nameref*{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Figures and Tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{adjustbox}                                     % Graphic/table boxes: scaling, trimming, framing
\RequirePackage{array}                                         % Custom column types and alignment
\RequirePackage{booktabs}                                      % High-quality horizontal rules for tables
\RequirePackage{caption}                                       % Custom caption formatting
\RequirePackage{colortbl}                                      % Cell background coloring in tables
\RequirePackage{dashbox}                                       % Dashed framed boxes
\RequirePackage{diagbox}                                       % Diagonal split table headers
\RequirePackage{fancybox}                                      % Simple framed boxes
\RequirePackage{float}                                         % Precise float positioning
\RequirePackage{framed}                                        % Framed environments (e.g., figures, text)
\RequirePackage{graphicx}                                      % Image inclusion and scaling
\RequirePackage{hhline}                                        % Horizontal lines in tables
\RequirePackage{longtable}                                     % Multi-page tables
\RequirePackage{makecell}                                      % Line breaks and formatting in cells
\RequirePackage{multicol}                                      % Multiple text columns
\RequirePackage{multirow}                                      % Multi-row cells in tables
\RequirePackage{pdflscape}                                     % Landscape pages in PDF output
\RequirePackage{placeins}                                      % Float placement control (e.g., \FloatBarrier)
\RequirePackage{ragged2e}                                      % Improved text justification
\RequirePackage{rotating}                                      % Rotated figures and tables
\RequirePackage{subcaption}                                    % Subfigures and subtables with captions
\RequirePackage{tabularray}                                    % Advanced table types and styling
\RequirePackage{tabularx}                                      % Tables with auto-stretching columns
\RequirePackage{threeparttable}                                % Notes and footnotes in tables
\RequirePackage{verbatim}                                      % Verbatim environment
\RequirePackage{wrapfig}                                       % Text wrapping around figures/tables
\RequirePackage{xhfill}                                        % Horizontal line
\RequirePackage{xtab}                                          % Page-breaking tables (alt to supertabular)
\AtBeginDocument{%
    \captionsetup{%
        font={rm,small},                                       % Roman font
        labelfont={color=black,sc,small},                      % Label in black roman
        labelsep=period,                                       % Label ends with period
        skip=5pt,                                              % Space below caption
        justification=justified                                % Center the caption
    }%
}%
\captionsetup[table]{position=bottom, skip=5pt}                % Table captions below
\captionsetup[figure]{position=bottom, skip=5pt}               % Figure captions below

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% List Customization
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{enumitem}                                      % Precise control over list environments

% Global list spacing
\setlist{nosep}                                                % Suppress vertical spacing between items

% Enumerate: Custom labels by nesting level
\setlist[enumerate,1]{label=(\arabic*)}                        % Level 1: (1), (2), ...
\setlist[enumerate,2]{label=(\alph*)}                          % Level 2: (a), (b), ...
\setlist[enumerate,3]{label=(\Roman*)}                         % Level 3: (I), (II), ...

% Itemize: Custom symbols by nesting level
\setlist[itemize,1]{label=\ensuremath{\bullet}}                % Level 1: bullet
\setlist[itemize,2]{label=\ensuremath{\textemdash}}            % Level 2: em dash
\setlist[itemize,3]{label=\ensuremath{\circ}}                  % Level 3: open circle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Epigraphs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsdirty@LoadEpigraph
    \RequirePackage{epigraph}                                     % Epigraphs (introductory quotations)

    % Epigraph configuration
    \setlength{\epigraphrule}{0.5pt}
    \setlength{\epigraphwidth}{0.65\textwidth}
    \renewcommand{\textflush}{flushright}
    \renewcommand{\epigraphsize}{\small}

    % Enhanced epigraph command
    \let\oldepigraph\epigraph
    \renewcommand{\epigraph}[2]{%
        \oldepigraph{\textsf{#1}}{\smallskip\textsc{#2}}%
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Diagrams and TikZ Graphics
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[most]{tcolorbox}                              % Colored and styled boxes
\RequirePackage[%
    skipabove=10pt,                                           % Vertical space above the frame
    skipbelow=10pt,                                           % Vertical space below the frame
    ntheorem,                                                 % Compatibility with theorem environments
    framemethod=Tikz                                          % Use TikZ for frame rendering
]{mdframed}                                                   % Framed environments with theorem support

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TikZ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsdirty@LoadTikz
    \typeout{csdirty: Loading TikZ package}
    \RequirePackage{pgfplots}                                     % Function/data plots
    \pgfplotsset{compat=1.18}                                     % PGFPlots compatibility version
    \RequirePackage{tikz}                                         % Core TikZ package
    \RequirePackage{tikz-cd}                                      % Commutative diagrams
    \RequirePackage{tikz-3dplot}                                  % 3D coordinate plotting

    % TikZ libraries for enhanced diagrammatic capability
    \usetikzlibrary{%
        3d,
        arrows,
        arrows.meta,
        automata,
        babel,
        backgrounds,
        bending,
        calc,
        calendar,
        chains,
        circuits.ee.IEC,
        circuits.logic.IEC,
        datavisualization,
        datavisualization.formats.functions,
        decorations,
        decorations.markings,
        decorations.pathmorphing,
        decorations.shapes,
        decorations.text,
        er,
        external,
        fadings,
        fit,
        graphs,
        graphs.standard,
        hobby,
        intersections,
        lindenmayersystems,
        matrix,
        mindmap,
        patterns,
        patterns.meta,
        petri,
        plothandlers,
        plotmarks,
        positioning,
        quotes,
        scopes,
        shadows,
        shapes,
        shapes.arrows,
        shapes.callouts,
        shapes.geometric,
        shapes.misc,
        shapes.multipart,
        shapes.symbols,
        spy,
        svg.path,
        through,
        tikzmark,
        trees
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendices
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[page, title, header, titletoc, toc]{appendix} % For handling appendices

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Cryptography and Styling
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsdirty@LoadTheorems
    \typeout{csdirty: Loading theorem formatting package}
    \IfFileExists{csthm.sty}{\RequirePackage[oldschool]{csthm}}{\PackageWarning{csdirty}{Package `csthm` not found.}} % Theorem formatting
\fi

\ifcsdirty@LoadCrypto
    \typeout{csdirty: Loading cryptography package}
    \IfFileExists{tcscrypto.sty}{\RequirePackage{tcscrypto}}{\PackageWarning{csdirty}{Package `tcscrypto` not found.}} % Cryptography macros
\fi

\ifcsdirty@LoadOrcidlink
    \typeout{csdirty: Loading ORCID link package}
    \IfFileExists{orcidlink.sty}{\RequirePackage{orcidlink}}{\PackageWarning{csdirty}{Package `orcidlink` not found.}} % ORCID ID and icon
\fi

\ifcsdirty@Nicodemus
    \typeout{csdirty: Loading Nicodemus font package}
    \IfFileExists{nicodemus.sty}{\RequirePackage{nicodemus}}{\PackageWarning{csdirty}{Package `nicodemus` not found.}} % Nicodemus macros
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Versioning, Comments, Acknowledgment, Abstract
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Comment macro: \newcomment{name}{color}{command}
\NewDocumentCommand{\newcomment}{mmm}{%
    \expandafter\NewDocumentCommand\csname#3\endcsname{m}{%
        \ifComments
            \noindent\textcolor{#2}{\sffamily##1 -- $\mathsf{#1}$}%
        \fi
    }%
}

\AtBeginDocument{%
    % Acknowledgment: hidden if anonymized, class-based otherwise
    \ifShortVersion
        \NewDocumentEnvironment{acknowledgment}{o}{}{}
    \else
        \NewDocumentEnvironment{acknowledgment}{o}{%
            \@ifclassloaded{book}{%
                \IfNoValueTF{#1}{\chapter*{Acknowledgment}}{\chapter*{#1}}%
            }{%
                \@ifclassloaded{report}{%
                    \IfNoValueTF{#1}{\chapter*{Acknowledgment}}{\chapter*{#1}}%
                }{%
                    \IfNoValueTF{#1}{\paragraph*{Acknowledgment.}}{\paragraph*{#1}}%
                }%
            }%
        }{}
    \fi
}

% Abstract: indented with TOC entry
\@ifclassloaded{book}{%
    \NewDocumentEnvironment{abstract}{}{%
        \begingroup
        \quotation
        \small
        \textbf{\abstractname.\ }%
        \addcontentsline{toc}{section}{\protect{\abstractname}}%
    }{%
        \endquotation
        \endgroup
    }
}{%
    \RenewDocumentEnvironment{abstract}{}{%
        \begingroup
        \quotation
        \small
        \textbf{\abstractname.\ }%
        \addcontentsline{toc}{section}{\protect{\abstractname}}%
    }{%
        \endquotation
        \endgroup
    }
}

% Table of Contents
\NewDocumentCommand{\toc}{}{%
    \clearpage
    \vfill
    \begin{spacing}{1.00}
        \tableofcontents
    \end{spacing}
    \vfill
    \clearpage
}

% Bibliography 
\NewDocumentCommand{\printbib}{m}{%
    \clearpage
    \vfill
    \begin{spacing}{1.00}
        \bibliographystyle{alphaurl}
        \bibliography{#1}
    \end{spacing}
    \vfill
    \clearpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title Formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{hep-title}                                   % Lightweight title formatting
\titlefont{\normalfont\LARGE\bfseries}                       % Title
\subtitlefont{\normalfont\large\bfseries}                    % Subtitle
\authorfont{\normalfont\normalsize\scshape}                  % Author
\affiliationfont{\normalfont\small\scshape}                  % Affiliation
\datefont{\normalfont\small\scshape}                         % Date
\preprintfont{\normalfont\small\ttfamily\scshape}            % Preprint line

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Adjust Table of Contents spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[titles]{tocloft}                             % TOC title formatting
\NewDocumentCommand{\adjusttocspacing}{}{%
    \addtolength{\cftchapnumwidth}{5pt}%
    \addtolength{\cftsecnumwidth}{3.5pt}%
    \addtolength{\cftsubsecnumwidth}{3.5pt}%
    \addtolength{\cftsubsubsecnumwidth}{3.5pt}%
    \addtolength{\cftsecindent}{5pt}%
    \addtolength{\cftsubsecindent}{8.5pt}%
    \addtolength{\cftsubsubsecindent}{12pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Header-level formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{titlesec}                                    % Header title formatting

% Define section-specific heading fonts and sizes
\NewDocumentCommand{\partheadingfont}{}{\normalfont\bfseries\huge}
\NewDocumentCommand{\chapterheadingfont}{}{\normalfont\bfseries\LARGE}
\NewDocumentCommand{\sectionheadingfont}{}{\normalfont\bfseries\Large}
\NewDocumentCommand{\subsectionheadingfont}{}{\normalfont\bfseries\large}
\NewDocumentCommand{\subsubsectionheadingfont}{}{\normalfont\bfseries\normalsize}
\NewDocumentCommand{\paragraphheadingfont}{}{\normalfont\bfseries\normalsize}
\NewDocumentCommand{\subparagraphheadingfont}{}{\normalfont\scshape\normalsize}

\ifcsdirty@LoadOldSectionSymb
    % Ancient Section, subsection, etc. formatting rules
    \NewDocumentCommand{\setsectionformats}{}{%
        \titleformat{\section}
        {\sectionheadingfont}
        {\textsection\thesection}
        {10pt}
        {}%
        \titleformat{\subsection}
        {\subsectionheadingfont}
        {\textsection\textsection\thesubsection}
        {10pt}
        {}%
        \titleformat{\subsubsection}[runin]
        {\subsubsectionheadingfont}
        {\textsection\textsection\textsection\thesubsubsection}
        {10pt}
        {}%
        \titleformat{\paragraph}[runin]
        {\paragraphheadingfont}
        {\theparagraph}
        {10pt}
        {}[.]%
        \titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
        \titleformat{\subparagraph}[runin]
        {\subparagraphheadingfont}
        {\thesubparagraph}
        {10pt}
        {}[.]%
        \titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
    }
\else
    % Section, subsection, etc. formatting rules
    \NewDocumentCommand{\setsectionformats}{}{%
        \titleformat{\section}
        {\sectionheadingfont}
        {\thesection}
        {10pt}
        {}%
        \titleformat{\subsection}
        {\subsectionheadingfont}
        {\thesubsection}
        {10pt}
        {}%
        \titleformat{\subsubsection}[runin]
        {\subsubsectionheadingfont}
        {\thesubsubsection}
        {10pt}
        {}%
        \titleformat{\paragraph}[runin]
        {\paragraphheadingfont}
        {\theparagraph}
        {10pt}
        {}[.]%
        \titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
        \titleformat{\subparagraph}[runin]
        {\subparagraphheadingfont}
        {\thesubparagraph}
        {10pt}
        {}[.]%
        \titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
    }
\fi

% Chapter-level title formatting (with embedded size and style)
\NewDocumentCommand{\setchapterformat}{}{%
    \titleformat{\chapter}[display]
    {\chapterheadingfont}
    {\filleft\textnormal{\textsc{\large\chaptertitlename}~\Huge\textsf{\thechapter}}}
    {2ex}
    {\titlerule\vspace{1ex}\filright}
    [\vspace{1ex}\titlerule]%
}

% Part-level title formatting (with embedded size and style)
\NewDocumentCommand{\setpartformat}{}{%
\titleclass{\part}{top}
\titleformat{\part}[display]
{\partheadingfont}
{\scshape\partname~{\Huge\thepart}}
{1ex}
{\scshape\titlerule\vspace{1ex}\Huge}
[\vspace{1ex}\titlerule]%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Paragraph formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Flag for punctuation detection
\newif\ifcsdirty@haspunctuation

% Check whether the second argument is empty (used for punctuation detection)
\def\csdirty@checkpunctuation#1{%
    \ifx\csdirty@checkpunctuation#1\csdirty@checkpunctuation
    \else
        \csdirty@haspunctuationtrue
    \fi
}

% Specific punctuation testers for '.', '?', '!', ':'
\def\csdirty@checkdot#1.\csdirty@delim#2\csdirty@stop{\csdirty@checkpunctuation{#2}}
\def\csdirty@checkquestion#1?\csdirty@delim#2\csdirty@stop{\csdirty@checkpunctuation{#2}}
\def\csdirty@checkexclam#1!\csdirty@delim#2\csdirty@stop{\csdirty@checkpunctuation{#2}}
\def\csdirty@checkcolon#1:\csdirty@delim#2\csdirty@stop{\csdirty@checkpunctuation{#2}}

% Main interface: Append period unless line ends with '.', '?', '!', or ':'
\def\csdirty@appendpunctuationifneeded#1{%
    \csdirty@haspunctuationfalse
    \csdirty@checkdot#1\csdirty@delim.\csdirty@delim\csdirty@stop
    \csdirty@checkquestion#1\csdirty@delim?\csdirty@delim\csdirty@stop
    \csdirty@checkexclam#1\csdirty@delim!\csdirty@delim\csdirty@stop
    \csdirty@checkcolon#1\csdirty@delim:\csdirty@delim\csdirty@stop
    #1\ifcsdirty@haspunctuation \else.\fi%
}

% Skip spaces and implicit paragraphs (blank lines)
\def\csdirty@ignorewhitespaceandimplicitpars{%
    \begingroup
    \catcode13=10 %
    \@ifnextchar\relax
    {\endgroup}
    {\endgroup}%
}

% Skip spaces, implicit paragraphs, and explicit \par commands
\def\csdirty@ignoreallpars{%
    \begingroup
    \catcode13=10 %
    \@ifnextchar\par
    {\endgroup\expandafter\csdirty@ignoreallpars\@gobble}
    {\endgroup}%
}

% Section-style paragraph header with automatic punctuation and spacing
\NewDocumentCommand{\csdirty@paragraphhead}{m}{%
    \smallskip
    \noindent
    \textbf{\boldmath\ignorespaces\csdirty@appendpunctuationifneeded{#1}}%
    \hskip 0.9em plus 0.3em minus 0.3em
    \csdirty@ignorewhitespaceandimplicitpars
}

\NewDocumentCommand{\parhead}{m}{\csdirty@paragraphhead{#1}}
\RenewDocumentCommand{\paragraph}{m}{\parhead{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Nested bar environment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\long\def\csdirty@customfbox#1#2#3#4#5#6#7#8#9{%
    \leavevmode
    \begingroup
    \setbox\@tempboxa\hbox{%
        \color@begingroup
        \kern\fboxsep{#9}\kern\fboxsep
        \color@endgroup}%
    \hbox{%
        \begingroup
        \@tempdima#4\relax
        \advance\@tempdima\fboxsep
        \advance\@tempdima\dp\@tempboxa
        \expandafter\endgroup
        \expandafter\lower\the\@tempdima\hbox{%
            \vbox{%
                \hrule \@height#3 \@width#7
                #1%
                \hbox{%
                    \vrule \@width#5
                    \hspace{#8}%
                    \vbox{%
                        \vskip\fboxsep
                        \copy\@tempboxa
                        \vskip\fboxsep}%
                    \vrule \@width#6}%
                #2%
                \hrule \@height#4\@width#7}%
        }%
    }%
    \endgroup
}

% Parameters for bar dimensions and spacing
\newcommand{\csdirty@nestedbar@topbotrulelength}{1em}
\newcommand{\csdirty@nestedbar@indent}{0.5em}

% FrameCommand helper that sets up side rule and spacing
\def\csdirty@openframebox#1#2{%
    \fboxsep=\FrameSep
    \csdirty@customfbox
    {}{}% no content above or below
    {#1}{#2}% top and bottom rule thicknesses
    \FrameRule\z@% left and right rule thickness
    \csdirty@nestedbar@topbotrulelength% horizontal rule length
    \csdirty@nestedbar@indent% indent from vertical rule
}

% Definition of the nestedbar environment
\newenvironment{nestedbar}[1][\hsize]{%
    \@ifundefined{OuterFrameSep}{%
        \@latex@error{To use nestedbar, update framed.sty to a recent version.}\@ehd}{}%
    \def\FrameCommand{\csdirty@openframebox\FrameRule\FrameRule}%
    \def\FirstFrameCommand{\csdirty@openframebox\FrameRule\z@}%
    \def\MidFrameCommand{\csdirty@openframebox\z@\z@}%
    \def\LastFrameCommand{\csdirty@openframebox\z@\FrameRule}%
    \OuterFrameSep=1ex
    \FrameSep=0pt
    \MakeFramed{\hsize#1\advance\hsize-\width\FrameRestore}%
}{%
    \endMakeFramed
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Simple fancyhdr header setup
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand{\simplefancyheader}{}{%
    \RequirePackage{fancyhdr}%
    \pagestyle{fancy}%
    \fancyhf{}%
    \fancyhead[LE,RO]{\rmfamily\small\textnormal{\@title}}%
    \fancyhead[RE,LO]{\rmfamily\small\thepage}%
    \fancyfoot{}%
    \setlength{\headheight}{12pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Class-specific adjustments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AtBeginDocument{%
    \@ifclassloaded{article}{%
        \setsectionformats%
    }{}

    \@ifclassloaded{report}{%
        \setchapterformat%
        \setsectionformats%
        \simplefancyheader%
        \adjusttocspacing%
    }{}

    \@ifclassloaded{book}{%
        \setchapterformat%
        \setpartformat%
        \setsectionformats%
        \simplefancyheader%
        \adjusttocspacing%
    }{}
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Useful commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Commands for the main document
\ifcsdirty@LoadUsefulCommands
    \@ifpackageloaded{enumitem}{%
        % Define 'points' list: itemize using "--"
        \newlist{points}{itemize}{1}
        \setlist[points]{%
            label={\textendash},
            leftmargin=1em,
            itemsep=1pt,
            align=left,
            before=\smallskip,
            after=\smallskip
        }

        % Define 'codelist' list: enumerated as [\texttt{1}], [\texttt{2}], ...
        \newlist{codelist}{enumerate}{1}
        \setlist[codelist,1]{%
            label=\textcolor{gray}{\texttt{[\arabic*]}},
            leftmargin=1em,
            itemsep=1pt,
            align=left,
            before=\smallskip,
            after=\smallskip
        }

        % Define 'checkbox' list
        \newlist{checkbox}{itemize}{1}
        \setlist[checkbox]{%
            label=$\square$,
            leftmargin=1em,
            align=left
        }
        % Define \checked command to switch label for one item
        \newcommand{\checked}{\item[\checkmark]}

        % Define a rigorous description list for definitions
        \newlist{deflist}{description}{1}
        \setlist[deflist]{%
            labelwidth=0.35\textwidth,
            labelsep=1em,
            leftmargin=0.35\textwidth,
            font=\normalfont\bfseries,
            style=nextline,
            itemsep=5pt
        }
    }{}

    % Highlight color for text and math
    \providecommand{\highlightcolor}{RoyalBlue}
    \providecommand{\sethighlightcolor}[1]{\renewcommand{\highlightcolor}{#1}}

    % Text and math highlighting
    \providecommand{\emphmath}[1]{\textcolor{\highlightcolor}{\mathrm{#1}}}
    \providecommand{\emphtext}[1]{\textcolor{\highlightcolor}{#1}}
    \providecommand{\textbi}[1]{\textbf{\textit{#1}}}
    \providecommand{\textem}[1]{\textcolor{\highlightcolor}{#1}}

    % Code highlighting
    \providecommand{\code}[1]{\texttt{#1}}

    % Math small caps and bold italic
    \providecommand{\mathsc}[1]{\textnormal{\textsc{#1}}}
    \providecommand{\mathbi}[1]{\textnormal{\textbf{\textit{#1}}}}

    % Inline math shortcut
    \providecommand{\inmath}[1]{\ensuremath{#1}}

    % Hyphen in math
    \mathchardef\mathhyphen="2D

    % Put in quotes
    \providecommand{\putInQuotes}[1]{``#1''}

    % Strike-through text
    \providecommand{\strike}[1]{\bgroup\ULdepth=-.55ex\ULset\strike{#1}\egroup}

    % Highlight missing or problematic text
    \newcounter{missingctr}
    \providecommand{\missinglist}{}

    % Main \missing command
    \providecommand{\missing}[1]{%
        \refstepcounter{missingctr}%
        \label{missing:\themissingctr}%
        \gappto\missinglist{%
            \noindent\textcolor{Brown4}{\ensuremath{\star}~\themissingctr~(\textsf{Missing at p.~\pageref{missing:\themissingctr}}):~#1}\par\medskip
        }%
        \textcolor{Brown4}{#1}%
    }

    % Print all collected missing items with page references
    \providecommand{\printmissing}{%
        \section*{Missing Content Report}%
        \missinglist
    }

    % Format for missing citations
    \providecommand{\missingcitation}{\textcolor{red}{\code{<Citation Missing>}}}

    % Double-struck Pi symbol for different engines
    \providecommand{\dsPi}{%
        \ifluatex
            \char"213F
        \else
            \ifxetex
                \char"213F
            \else
                \Pi
            \fi
        \fi
    }

    % Sans-serif Pi symbol for different engines
    \providecommand{\sansPi}{%
        \ifluatex
            \char"1D765
        \else
            \ifxetex
                \char"1D765
            \else
                \Pi
            \fi
        \fi
    }

    \@ifpackageloaded{mdframed}{%
        % Protocol box environment
        \NewDocumentEnvironment{protocolbox}{o}
        {%
            \begin{mdframed}[
                    font=\small,
                    roundcorner=1.5pt,
                    linewidth=0.5pt,
                    skipabove=0.5\baselineskip,
                    skipbelow=0.1\baselineskip,
                    leftmargin=0pt,
                    rightmargin=0pt,
                    innerleftmargin=5pt,
                    innerrightmargin=5pt,
                    innertopmargin=5pt,
                    innerbottommargin=5pt,
                    backgroundcolor=white,
                    linecolor=black
                ]%
                \IfNoValueF{#1}{%
                    \noindent\textnormal{\small\textbf{#1}}\par\smallskip
                    \noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
                }%
                \begin{points}%
                    }
                    {%
                \end{points}
            \end{mdframed}%
        }

        % Code list box environment
        \NewDocumentEnvironment{codelistbox}{o}
        {%
            \begin{mdframed}[
                    font=\small,
                    roundcorner=1.5pt,
                    linewidth=0.5pt,
                    skipabove=0.5\baselineskip,
                    skipbelow=0.1\baselineskip,
                    leftmargin=0pt,
                    rightmargin=0pt,
                    innerleftmargin=5pt,
                    innerrightmargin=5pt,
                    innertopmargin=5pt,
                    innerbottommargin=5pt,
                    backgroundcolor=white,
                    linecolor=black
                ]%
                \IfNoValueF{#1}{%
                    \noindent\textnormal{\small\textbf{#1}}\par\smallskip
                    \noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
                }%
                \begin{codelist}%
                    }
                    {%
                \end{codelist}
            \end{mdframed}%
        }

        \NewDocumentEnvironment{simplebox}{o}
        {%
            \begin{mdframed}[
                    font=\small,
                    roundcorner=1.5pt,
                    linewidth=0.5pt,
                    skipabove=0.5\baselineskip,
                    skipbelow=0.1\baselineskip,
                    leftmargin=0pt,
                    rightmargin=0pt,
                    innerleftmargin=5pt,
                    innerrightmargin=5pt,
                    innertopmargin=5pt,
                    innerbottommargin=5pt,
                    backgroundcolor=white,
                    linecolor=black
                ]%
                \IfNoValueF{#1}{%
                    \noindent\textnormal{\small\textbf{#1}}\par\smallskip
                    \noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
                }%
                }
                {%
            \end{mdframed}%
        }
    }{}

    \@ifpackageloaded{tcolorbox}{%
        % Wire box environment
        \newtcolorbox{wirebox}{%
            colframe=black,
            colback=white,
            sharp corners,
            boxrule=0.5pt,
            coltitle=black,
            colbacktitle=white,
            boxsep=5pt,
            top=0pt,
            bottom=0pt,
            left=5pt,
            right=5pt
        }
    }{}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Upright Greek Letters Setup
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{upgreek} % Load upright Greek letter symbols

% Provide definitions for missing uppercase Greek macros as roman letters, if undefined
\@ifundefined{Alpha}{\newcommand{\Alpha}{\mathrm{A}}}{}
\@ifundefined{Beta}{\newcommand{\Beta}{\mathrm{B}}}{}
\@ifundefined{Chi}{\newcommand{\Chi}{\mathrm{X}}}{}
\@ifundefined{Epsilon}{\newcommand{\Epsilon}{\mathrm{E}}}{}
\@ifundefined{Eta}{\newcommand{\Eta}{\mathrm{H}}}{}
\@ifundefined{Iota}{\newcommand{\Iota}{\mathrm{I}}}{}
\@ifundefined{Kappa}{\newcommand{\Kappa}{\mathrm{K}}}{}
\@ifundefined{Mu}{\newcommand{\Mu}{\mathrm{M}}}{}
\@ifundefined{Nu}{\newcommand{\Nu}{\mathrm{N}}}{}
\@ifundefined{Omicron}{\newcommand{\Omicron}{\mathrm{O}}}{}
\@ifundefined{Rho}{\newcommand{\Rho}{\mathrm{R}}}{}
\@ifundefined{Tau}{\newcommand{\Tau}{\mathrm{T}}}{}
\@ifundefined{Zeta}{\newcommand{\Zeta}{\mathrm{Z}}}{}
\@ifundefined{omicron}{\newcommand{\omicron}{\mathrm{o}}}{}

% Fallbacks for upright forms from `upgreek`, if undefined
\@ifundefined{Upalpha}{\newcommand{\Upalpha}{\mathrm{A}}}{}
\@ifundefined{Upbeta}{\newcommand{\Upbeta}{\mathrm{B}}}{}
\@ifundefined{Upchi}{\newcommand{\Upchi}{\mathrm{X}}}{}
\@ifundefined{Upepsilon}{\newcommand{\Upepsilon}{\mathrm{E}}}{}
\@ifundefined{Upeta}{\newcommand{\Upeta}{\mathrm{H}}}{}
\@ifundefined{Upiota}{\newcommand{\Upiota}{\mathrm{I}}}{}
\@ifundefined{Upkappa}{\newcommand{\Upkappa}{\mathrm{K}}}{}
\@ifundefined{Upmu}{\newcommand{\Upmu}{\mathrm{M}}}{}
\@ifundefined{Upnu}{\newcommand{\Upnu}{\mathrm{N}}}{}
\@ifundefined{Upomicron}{\newcommand{\Upomicron}{\mathrm{O}}}{}
\@ifundefined{Uprho}{\newcommand{\Uprho}{\mathrm{R}}}{}
\@ifundefined{Uptau}{\newcommand{\Uptau}{\mathrm{T}}}{}
\@ifundefined{Upzeta}{\newcommand{\Upzeta}{\mathrm{Z}}}{}
\@ifundefined{upomicron}{\newcommand{\upomicron}{\mathrm{o}}}{}

% If available, overwrite standard Greek macros with their upright versions
\@ifundefined{Upalpha}{}{\renewcommand{\Alpha}{\Upalpha}}
\@ifundefined{Upbeta}{}{\renewcommand{\Beta}{\Upbeta}}
\@ifundefined{Upchi}{}{\renewcommand{\Chi}{\Upchi}}
\@ifundefined{Updelta}{}{\renewcommand{\Delta}{\Updelta}}
\@ifundefined{Upepsilon}{}{\renewcommand{\Epsilon}{\Upepsilon}}
\@ifundefined{Upeta}{}{\renewcommand{\Eta}{\Upeta}}
\@ifundefined{Upgamma}{}{\renewcommand{\Gamma}{\Upgamma}}
\@ifundefined{Upiota}{}{\renewcommand{\Iota}{\Upiota}}
\@ifundefined{Upkappa}{}{\renewcommand{\Kappa}{\Upkappa}}
\@ifundefined{Uplambda}{}{\renewcommand{\Lambda}{\Uplambda}}
\@ifundefined{Upmu}{}{\renewcommand{\Mu}{\Upmu}}
\@ifundefined{Upnu}{}{\renewcommand{\Nu}{\Upnu}}
\@ifundefined{Upomega}{}{\renewcommand{\Omega}{\Upomega}}
\@ifundefined{Upomicron}{}{\renewcommand{\Omicron}{\Upomicron}}
\@ifundefined{Upphi}{}{\renewcommand{\Phi}{\Upphi}}
\@ifundefined{Uppi}{}{\renewcommand{\Pi}{\Uppi}}
\@ifundefined{Uppsi}{}{\renewcommand{\Psi}{\Uppsi}}
\@ifundefined{Uprho}{}{\renewcommand{\Rho}{\Uprho}}
\@ifundefined{Upsigma}{}{\renewcommand{\Sigma}{\Upsigma}}
\@ifundefined{Uptau}{}{\renewcommand{\Tau}{\Uptau}}
\@ifundefined{Uptheta}{}{\renewcommand{\Theta}{\Uptheta}}
\@ifundefined{Upupsilon}{}{\renewcommand{\Upsilon}{\Upupsilon}}
\@ifundefined{Upxi}{}{\renewcommand{\Xi}{\Upxi}}
\@ifundefined{Upzeta}{}{\renewcommand{\Zeta}{\Upzeta}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% End of package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\endinput