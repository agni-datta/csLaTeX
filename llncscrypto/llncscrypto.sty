%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% llncscrypto.sty â€“ Enhanced LaTeX Style Package for LNCS + Cryptography
%%
%% COMPREHENSIVE DOCUMENTATION (v1.2.1, 2025/06/26)
%% ---------------------------------------------------------------------------------------------------------------
%% DESCRIPTION:
%%   llncscrypto is a feature-rich LaTeX style package that extends the LNCS (Lecture Notes in Computer Science)
%%   document class with advanced tools for cryptography, theoretical computer science, and mathematical writing.
%%   It is designed for research papers, preprints, and proceedings, providing modern typesetting, robust theorem
%%   environments, cryptography-specific macros, and seamless integration with TikZ, cleveref, and more.
%%
%% AUTHORS:
%%   Matteo Campanelli (matteo.campanelli@gmail.com)
%%   Agni Datta (agnidatta.org@gmail.com)
%%
%% VERSION: 1.2.1
%% DATE: 2025/06/26
%% LICENSE: LaTeX Project Public License v1.3c
%%
%% ---------------------------------------------------------------------------------------------------------------
%% KEY FEATURES:
%%
%% 1. **Theorem Environments**
%%    - Enhanced, LLNCS-compliant theorem, lemma, corollary, definition, and remark environments.
%%    - Many additional environments: assertion, assumption, axiom, claim, conclusion, conjecture, fact, hypothesis,
%%      postulate, property, proposition, application, construction, convention, experiment, notation, problem, protocol,
%%      result, commentary, example, exercise, motivation, notation abuse, note, observation, question, guideline,
%%      highlight, important, insight, keypoint, recall, summary, takeaway, tip, warning.
%%    - All environments are cross-referenced and compatible with cleveref.
%%    - Custom proof and claimproof environments, with optional claim counters.
%%    - Highlight environments for guidelines, tips, warnings, etc.
%%
%% 2. **Cryptography-Specific Macros**
%%    - Loads tcscrypto.sty (if present) for cryptographic notation, protocols, and diagrams.
%%    - ORCID support for author identification.
%%    - Protocol box environments for clear presentation of cryptographic protocols.
%%    - Wirebox and codelistbox for protocol steps and code listings.
%%    - Double-struck and sans-serif Pi symbols, and other math/crypto notations.
%%
%% 3. **TikZ and Graphics**
%%    - Optionally loads TikZ, pgfplots, tikz-cd, tikz-3dplot, and a comprehensive set of TikZ libraries.
%%    - Enhanced support for commutative diagrams, 3D plots, and cryptographic figures.
%%    - tcolorbox and mdframed for custom boxes and framed environments.
%%
%% 4. **Captions and Figures**
%%    - Enhanced caption formatting (optional, via [captions] option).
%%    - Improved table and figure handling: booktabs, colortbl, subcaption, tabularx, tabularray, longtable, threeparttable, etc.
%%    - Float placement control, landscape pages, and advanced table/figure environments.
%%
%% 5. **Fonts and Math**
%%    - Modular font selection: Libertinus, Concrete, or default (lmodern/amsfonts/amsmath).
%%    - Math font and symbol enhancements: mathrsfs, mathtools, bm, siunitx, mathalpha, unicode-math, etc.
%%    - Upright Greek letter support via upgreek, with robust fallbacks and macro redefinitions for upright/roman forms.
%%
%% 6. **Cross-Referencing and Hyperlinks**
%%    - Smart cross-referencing with cleveref (automatic environment names, section symbols, etc.).
%%    - Full integration with hyperref: colored links, PDF metadata, backrefs, and fullref macro.
%%    - External document referencing (xr).
%%
%% 7. **Appendix Management**
%%    - Optional appendix support (via [appendix] option) with page, title, header, and TOC integration.
%%
%% 8. **Lists and Custom Environments**
%%    - Custom list types: points (itemize with dashes), codelist (enumerated code steps), checkbox (with \checked), deflist (definition list).
%%    - Nested bar and simplebox environments for boxed content.
%%    - Epigraph support with enhanced formatting.
%%
%% 9. **Document Structure and Utilities**
%%    - Full-page and preprint layout options (fullpage, fancyhdr, setspace).
%%    - Automatic loading of user settings and commands from settings.tex and commands.tex if present.
%%    - Paragraph header macros (\parhead) with smart punctuation.
%%    - Version control macros: \FullVersion, \ShortVersion, \usecomments, \newcomment.
%%    - Acknowledgment environment with optional title.
%%    - Missing content tracking and reporting (\missing, \printmissing).
%%    - Miscellaneous: code highlighting, math small caps, strike-through, putInQuotes, hyphen in math, etc.
%%
%% ---------------------------------------------------------------------------------------------------------------
%% PACKAGE OPTIONS (all optional, can be combined):
%%   appendix    - Enable appendix management and formatting.
%%   captions    - Enhanced caption formatting and positioning.
%%   concrete    - Use Concrete font for preprints.
%%   crypto      - Load cryptography-specific macros and notation (tcscrypto, orcidlink).
%%   fullpage    - Enable full-page layout (for preprints).
%%   libertinus  - Use Libertinus font for preprints.
%%   nicodemus   - Enable Nicodemus cryptography option.
%%   theorems    - Enable enhanced theorem environments with LLNCS styling.
%%   tikz        - Load TikZ and all supported graphics libraries.
%%
%% ---------------------------------------------------------------------------------------------------------------
%% DEPENDENCIES:
%%   - llncs document class (not loaded by this package)
%%   - xcolor, etoolbox, xparse, calc, comment, ifpdf, iftex, xkeyval, xpatch (core)
%%   - TikZ, pgfplots, tikz-cd, tikz-3dplot (if tikz option enabled)
%%   - tcscrypto, orcidlink (if crypto option enabled)
%%   - mdframed, tcolorbox (for wirebox and framed environments)
%%   - upgreek (for upright Greek letters)
%%   - cleveref, hyperref, xr, caption, booktabs, colortbl, subcaption, tabularx, tabularray, longtable, threeparttable, etc.
%%
%% ---------------------------------------------------------------------------------------------------------------
%% USAGE EXAMPLES:
%%   \documentclass{llncs}
%%   \usepackage[captions,tikz,appendix,crypto,theorems]{llncscrypto}
%%   \begin{document}
%%     % Your document content here
%%   \end{document}
%%
%%   % Custom theorem:
%%   \begin{theorem}[My Theorem]
%%     ...
%%   \end{theorem}
%%
%%   % Protocol box:
%%   \begin{protocolbox}[My Protocol]
%%     \item Step 1
%%     \item Step 2
%%   \end{protocolbox}
%%
%%   % Wirebox:
%%   \begin{wirebox}
%%     ...
%%   \end{wirebox}
%%
%%   % Paragraph header:
%%   \parhead{Main Idea} This is the main idea.
%%
%%   % Missing content:
%%   \missing{Proof to be added}
%%   ...
%%   \printmissing
%%
%% ---------------------------------------------------------------------------------------------------------------
%% CAVEATS & NOTES:
%%   - Do not remove or modify package calls unless necessary; use settings.tex/commands.tex for customizations.
%%   - Theorems and environments are only enabled with theorems option.
%%   - TikZ libraries are loaded only with tikz option.
%%   - Crypto macros require tcscrypto.sty to be present.
%%   - Upright Greek letters are provided with robust fallbacks if upgreek is not available.
%%   - settings.tex and commands.tex are loaded automatically if present in the document directory.
%%   - Some features (e.g., fullpage, captions) may not be allowed for final submission to all conferences.
%%   - For best results, use with a modern TeX engine (pdfLaTeX, XeLaTeX, LuaLaTeX).
%%   - Some hacks (e.g., claim counters, custom proof environments) may not be compatible with all packages.
%%   - If you need to add or override anything, do so in settings.tex or commands.tex, not in this file.
%%
%% ---------------------------------------------------------------------------------------------------------------
%% CUSTOM COMMANDS & ENVIRONMENTS (partial list):
%%   \parhead{Title}         - Section-style paragraph header with smart punctuation.
%%   \protocolbox[Title]     - Boxed protocol environment (with points list inside).
%%   \codelistbox[Title]     - Boxed code list environment (with codelist inside).
%%   \simplebox[Title]       - Simple boxed environment.
%%   \wirebox                - tcolorbox-based wirebox for diagrams.
%%   \checked                - For checked item in checkbox list.
%%   \fullversion, \shortversion, \usecomments, \newcomment{name}{color}{cmd} - Versioning and comments.
%%   \missing{desc}, \printmissing - Mark and print missing content.
%%   \dsPi, \sansPi         - Double-struck and sans-serif Pi symbols.
%%   \textem, \emphtext, \emphmath, \code, \mathsc, \mathbi, \inmath, \putInQuotes, \strike, etc.
%%   \fullref{label}         - Combined autoref/nameref hyperlink.
%%   \acknowledgment[Title]  - Acknowledgment environment.
%%   \begin{nestedbar} ... \end{nestedbar} - Custom bar environment.
%%   \begin{deflist} ... \end{deflist}     - Definition list.
%%   \begin{checkbox} ... \end{checkbox}   - Checkbox list.
%%   \begin{points} ... \end{points}       - Points list.
%%   \begin{codelist} ... \end{codelist}   - Codelist.
%%   \begin{epigraph}{quote}{author}        - Epigraph with formatting.
%%
%% ---------------------------------------------------------------------------------------------------------------
%% HACKS & ADVANCED FEATURES:
%%   - Smart paragraph header with auto-punctuation (\parhead).
%%   - Custom claim counters and proof environments for claims.
%%   - Automatic missing content tracking with page references.
%%   - Robust upright Greek letter support with fallbacks and macro redefinitions.
%%   - Automatic user settings/commands loading for easy customization.
%%   - Modular font logic for preprints (Libertinus/Concrete).
%%   - Full integration with cleveref and hyperref for smart referencing.
%%   - Custom list types for points, code, checkboxes, and definitions.
%%   - Protocol and wirebox environments for cryptographic protocols and diagrams.
%%   - Enhanced epigraph formatting.
%%   - All environments and macros are robust to missing dependencies (with warnings).
%%
%% ---------------------------------------------------------------------------------------------------------------
%% CHANGELOG:
%%   v1.2.1 (2025/06/26) - Upright Greek letter support, wirebox/framed environments, auto settings/commands loading
%%   v1.0   (2025/06/26) - Initial release with core functionality
%% ---------------------------------------------------------------------------------------------------------------
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesPackage{llncscrypto}[2025/06/26 v1.2.1 llncscrypto package]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Package Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Boolean flags
\newif\ifllncscrypto@loadappendix           \llncscrypto@loadappendixfalse
\newif\ifllncscrypto@loadcaptions           \llncscrypto@loadcaptionsfalse
\newif\ifllncscrypto@loadcrypto             \llncscrypto@loadcryptofalse
\newif\ifllncscrypto@loadfullpage           \llncscrypto@loadfullpagefalse
\newif\ifllncscrypto@loadnicodemus          \llncscrypto@loadnicodemusfalse
\newif\ifllncscrypto@loadpreprint           \llncscrypto@loadpreprintfalse
\newif\ifllncscrypto@loadpreprintconcrete   \llncscrypto@loadpreprintconcretefalse
\newif\ifllncscrypto@loadpreprintlibertinus \llncscrypto@loadpreprintlibertinusfalse
\newif\ifllncscrypto@loadtikz               \llncscrypto@loadtikzfalse
\newif\ifllncscrypto@modtheorems            \llncscrypto@modtheoremsfalse

% Load Options
\DeclareOption{appendix}{\llncscrypto@loadappendixtrue}
\DeclareOption{captions}{\llncscrypto@loadcaptionstrue}
\DeclareOption{concrete}{\llncscrypto@loadpreprintconcretetrue}
\DeclareOption{crypto}{\llncscrypto@loadcryptotrue}
\DeclareOption{fullpage}{\llncscrypto@loadfullpagetrue}
\DeclareOption{libertinus}{\llncscrypto@loadpreprintlibertinustrue}
\DeclareOption{nicodemus}{\llncscrypto@loadnicodemustrue}
\DeclareOption{theorems}{\llncscrypto@modtheoremstrue}
\DeclareOption{tikz}{\llncscrypto@loadtikztrue}

% Ignore unknown options
\DeclareOption*{\relax}
\ProcessOptions\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Color
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[x11names, dvipsnames, svgnames]{xcolor}     % Extended color support.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core Programming and Utility Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{calc}                                        % Arithmetic with lengths
\RequirePackage{comment}                                     % Block comment environment
\RequirePackage{etoolbox}                                    % Logic and macro patching
\RequirePackage{ifpdf}                                       % Detect PDF output mode
\RequirePackage{iftex}                                       % Detect engine: pdfTeX, XeTeX, LuaTeX
\RequirePackage{xkeyval}                                     % Key-value parsing
\RequirePackage{xparse}                                      % Extended command/environment definitions
\RequirePackage{xpatch}                                      % For patching existing macros

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PDF and Document Structure Control
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[%
    2.0,
    objcompress,
    compress
]{bxpdfver} % PDF version and compression settings
\RequirePackage[nottoc]{tocbibind}                           % Add bibliography, list of figures, etc. to TOC
\RequirePackage{babel}                                       % Language, hyphenation
\RequirePackage{pdfpages}                                    % Include external PDFs
\RequirePackage{refcount}                                    % Reference counting
\ifllncscrypto@loadfullpage
    % Load full page and header/footer packages
    \RequirePackage{fullpage}      % Full page layout
    \RequirePackage{fancyhdr}      % Custom headers/footers
    \RequirePackage{setspace}      % Line spacing

    % Set line spacing
    \setstretch{1.15}

    % Patch \@maketitle to use larger, bold title
    \xpatchcmd{\@maketitle}
    {\@title}
    {\LARGE\normalfont\bfseries\@title\par}
    {}{}

    % Preprint header macro with optional left/right header text using fancyhdr
    \NewDocumentCommand{\preprint}{O{}O{}}{%
    \AtEndPreamble{%
        \fancypagestyle{preprinthdr}{%
            \fancyhf{}%
            \IfValueT{#1}{\fancyhead[L]{\textsc{#1}}}%
            \IfValueT{#2}{\fancyhead[R]{\textsc{#2}}}%
            \fancyfoot[C]{\thepage}%
            \renewcommand{\headrulewidth}{0pt}%
            \renewcommand{\footrulewidth}{0pt}%
        }%
        % Adjust header and text body separation to prevent overlap
        \setlength{\headheight}{15pt}%
        \setlength{\headsep}{20pt}%
        \pagestyle{preprinthdr}%
    }%
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
% Text, Layout, and Miscellaneous Enhancements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[autostyle=true, csdisplay=true]{csquotes}    % Automatic quotation marks and smart citations
\RequirePackage[final]{microtype}                            % Improved justification and hyphenation
\RequirePackage[full]{textcomp}                              % Additional text symbols (e.g., degree sign)
\RequirePackage[nocompress]{cite}                            % Citation package for references
\RequirePackage[normalem]{ulem}                              % Underlining and strikethrough capabilities
\RequirePackage{emptypage}                                   % No page numbers on empty pages
\RequirePackage{lipsum}                                      % Dummy text
\RequirePackage{paralist}                                    % Long List Style environments
\RequirePackage{pifont}                                      % For using Dingbat fonts
\RequirePackage{soul}                                        % For text highlighting
\RequirePackage{xspace}                                      % Intelligent spacing after macros
\RequirePackage{xurl}                                        % Breakable URLs

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fonts and Math
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Libertine/Libertinus font setup (modular, reusable)
\newcommand{\llncscrypto@libertine}{%
    \ifLuaTeX
        \typeout{llncscrypto: Loading Libertinus setup for LuaTeX}
        \RequirePackage[T1]{fontenc}
        \RequirePackage{moresize}
        \RequirePackage{nicefrac}
        \RequirePackage{siunitx}
        \RequirePackage{fontspec}
        \RequirePackage{unicode-math}
        \RequirePackage{libertineRoman}
        \setmainfont[Scale=MatchUppercase]{linuxlibertineo}
        \setmathfont[Scale=MatchUppercase]{libertinusmath}
        \setmonofont[Scale=MatchLowercase]{firamono}
        \setsansfont[Scale=MatchLowercase]{ysabeau}
        \let\mathbfcal\relax
        \let\mathbfscr\relax
        \RequirePackage{mathrsfs}
        \RequirePackage[cal=stixplain,bb=bboldx,scr=esstix]{mathalpha}
    \else
        \ifXeTeX
            \typeout{llncscrypto: Loading Libertinus setup for XeTeX}
            \RequirePackage[T1]{fontenc}
            \RequirePackage{moresize}
            \RequirePackage{nicefrac}
            \RequirePackage{siunitx}
            \RequirePackage{fontspec}
            \RequirePackage{unicode-math}
            \RequirePackage{libertineRoman}
            \setmainfont[Scale=MatchUppercase]{linuxlibertineo}
            \setmathfont[Scale=MatchUppercase]{libertinusmath}
            \setmonofont[Scale=MatchLowercase]{firamono}
            \setsansfont[Scale=MatchLowercase]{ysabeau}
            \let\mathbfcal\relax
            \let\mathbfscr\relax
            \RequirePackage{mathrsfs}
            \RequirePackage[cal=stixplain,bb=bboldx,scr=esstix]{mathalpha}
        \else
            \typeout{llncscrypto: Libertine/Libertinus setup not supported for this engine.}
        \fi
    \fi
}

% Concrete math font setup (modular, reusable)
\newcommand{\llncscrypto@concrete}{%
    \ifLuaTeX
        \typeout{llncscrypto: Loading Concrete math for LuaTeX}
        \RequirePackage[T1]{fontenc}
        \RequirePackage{moresize}
        \RequirePackage{nicefrac}
        \RequirePackage{siunitx}
        \RequirePackage{fontspec}
        \RequirePackage{unicode-math}
        \RequirePackage[concrete]{fontsetup}
        \let\mathbfcal\relax
        \let\mathbfscr\relax
        \RequirePackage{mathrsfs}
        \RequirePackage[bb=bboldx,cal=cm,scr=esstix]{mathalpha}
    \else
        \ifXeTeX
            \typeout{llncscrypto: Loading Concrete math for XeTeX}
            \RequirePackage[T1]{fontenc}
            \RequirePackage{moresize}
            \RequirePackage{nicefrac}
            \RequirePackage{siunitx}
            \RequirePackage{fontspec}
            \RequirePackage{unicode-math}
            \RequirePackage[concrete]{fontsetup}
            \let\mathbfcal\relax
            \let\mathbfscr\relax
            \RequirePackage{mathrsfs}
            \RequirePackage[bb=bboldx,cal=cm,scr=esstix]{mathalpha}
        \else
            \typeout{llncscrypto: Concrete math setup not supported for this engine.}
        \fi
    \fi
}

% Default font setup (modular, reusable)
\newcommand{\llncscrypto@defaultfont}{%
    \RequirePackage[T1]{fontenc}
    \RequirePackage{lmodern}
    \RequirePackage{amsfonts}
    \RequirePackage{amsmath}
    \RequirePackage{amssymb}
    \RequirePackage{mathrsfs}
    \RequirePackage{bm}
    \RequirePackage{mathrsfs}
    \RequirePackage{mathtools}
    \RequirePackage{moresize}
    \RequirePackage{nicefrac}
    \RequirePackage{siunitx}
    \let\mathbfcal\relax
    \let\mathbfscr\relax
    \RequirePackage[cal=stixplain,bb=bboldx,scr=esstix]{mathalpha}
}

% Font selection logic
\ifllncscrypto@loadpreprintlibertinus
    \llncscrypto@libertine
\else
    \ifllncscrypto@loadpreprintconcrete
        \llncscrypto@concrete
    \else
        \llncscrypto@defaultfont
    \fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hyperlinks & Referencing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{nameref}                                     % Name-based referencing
\RequirePackage[%
    bookmarksnumbered=true,                                  % Number PDF bookmarks
    breaklinks=true,                                         % Allow links to break over lines
    citecolor=SlateBlue2,                                    % Color for citations
    colorlinks=true,                                         % Use colored links
    frenchlinks=true,                                        % Use small caps for links
    linkcolor=RoyalBlue2,                                    % Color for internal links
    pagebackref,                                             % Back-references from bibliography
    pdfencoding=auto,                                        % Automatic encoding detection
    pdfpagelabels=true,                                      % Correct page labels in PDF
    pdfpagelayout=SinglePage,                                % Single page view
    pdfstartview=FitH,                                       % Fit the page to the window
    pdfusetitle,                                             % Use document title as PDF title
    unicode=true,                                            % Support for Unicode
    urlcolor=SpringGreen4                                    % Color for URLs
]{hyperref}
\RequirePackage{xr}                                          % Cross-document references
% Customize backrefs
\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
    \ifcase #1\or (Cited on p.~#2).%
    \else (Cited on pp.~#2).%
    \fi
}
% Full reference combining hyperref, autoref, and nameref.
\newcommand*{\fullref}[1]{\hyperref[{#1}]{\autoref*{#1}~\nameref*{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Figures and Tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{adjustbox}                                     % Graphic/table boxes: scaling, trimming, framing
\RequirePackage{array}                                         % Custom column types and alignment
\RequirePackage{booktabs}                                      % High-quality horizontal rules for tables
\RequirePackage{colortbl}                                      % Cell background coloring in tables
\RequirePackage{dashbox}                                       % Dashed framed boxes
\RequirePackage{diagbox}                                       % Diagonal split table headers
\RequirePackage{fancybox}                                      % Simple framed boxes
\RequirePackage{float}                                         % Precise float positioning
\RequirePackage{framed}                                        % Framed environments (e.g., figures, text)
\RequirePackage{graphicx}                                      % Image inclusion and scaling
\RequirePackage{hhline}                                        % Horizontal lines in tables
\RequirePackage{longtable}                                     % Multi-page tables
\RequirePackage{makecell}                                      % Line breaks and formatting in cells
\RequirePackage{multicol}                                      % Multiple text columns
\RequirePackage{multirow}                                      % Multi-row cells in tables
\RequirePackage{pdflscape}                                     % Landscape pages in PDF output
\RequirePackage{placeins}                                      % Float placement control (e.g., \FloatBarrier)
\RequirePackage{ragged2e}                                      % Improved text justification
\RequirePackage{rotating}                                      % Rotated figures and tables
\RequirePackage{subcaption}                                    % Subfigures and subtables with captions
\RequirePackage{tabularray}                                    % Advanced table types and styling
\RequirePackage{tabularx}                                      % Tables with auto-stretching columns
\RequirePackage{threeparttable}                                % Notes and footnotes in tables
\RequirePackage{wrapfig}                                       % Text wrapping around figures/tables
\RequirePackage{xhfill}                                        % Horizontal line
\RequirePackage{xtab}                                          % Page-breaking tables (alt to supertabular)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Captions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifllncscrypto@loadcaptions
    \AtBeginDocument{%
        \RequirePackage{caption}                                   % Custom caption formatting
        \captionsetup{%
            font={rm},                                             % Roman font
            labelfont={color=black,sc},                            % Label in black roman
            labelsep=colon,                                        % Label ends with colon
            skip=5pt,                                              % Space below caption
            belowskip=0pt                                          % Skip below caption
        }%
    }%
    \captionsetup[table]{position=bottom, skip=5pt}                % Table captions below
    \captionsetup[figure]{position=bottom, skip=5pt}               % Figure captions below
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lists
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{enumitem}                                       % Customizing lists
\setlist{nosep}                                                 % Remove extra space between items
\setlist[enumerate,1]{label=(\arabic*)}                         % Top-level numbered lists
\setlist[enumerate,2]{label=(\alph*)}                           % Second-level numbered lists
\setlist[itemize,1]{label=\color{black!75}\textendash}          % Top-level itemized lists
\setlist[itemize,2]{label=\color{black!75}\textbullet}          % Second-level itemized lists

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Diagrams and TikZ Graphics
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{epigraph}                                     % Epigraphs (introductory quotations)

% Epigraph configuration
\setlength{\epigraphrule}{0.5pt}
\setlength{\epigraphwidth}{0.65\textwidth}
\renewcommand{\textflush}{flushright}
\renewcommand{\epigraphsize}{\small}

% Enhanced epigraph command
\let\oldepigraph\epigraph
\renewcommand{\epigraph}[2]{%
    \oldepigraph{\textsf{#1}}{\smallskip\textsc{#2}}%
}

\RequirePackage[most]{tcolorbox}                              % Colored and styled boxes
\RequirePackage[%
    skipabove=10pt,                                           % Vertical space above the frame
    skipbelow=10pt,                                           % Vertical space below the frame
    ntheorem,                                                 % Compatibility with theorem environments
    framemethod=Tikz                                          % Use TikZ for frame rendering
]{mdframed}                                                   % Framed environments with theorem support

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TikZ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifllncscrypto@loadtikz
    \RequirePackage{pgfplots}                                     % Function/data plots
    \pgfplotsset{compat=1.18}                                     % PGFPlots compatibility version
    \RequirePackage{tikz}                                         % Core TikZ package
    \RequirePackage{tikz-cd}                                      % Commutative diagrams
    \RequirePackage{tikz-3dplot}                                  % 3D coordinate plotting

    % TikZ libraries for enhanced diagrammatic capability
    \usetikzlibrary{%
        3d,
        arrows,
        arrows.meta,
        automata,
        babel,
        backgrounds,
        bending,
        calc,
        calendar,
        chains,
        circuits.ee.IEC,
        circuits.logic.IEC,
        datavisualization,
        datavisualization.formats.functions,
        decorations,
        decorations.markings,
        decorations.pathmorphing,
        decorations.shapes,
        decorations.text,
        er,
        external,
        fadings,
        fit,
        graphs,
        graphs.standard,
        hobby,
        intersections,
        lindenmayersystems,
        matrix,
        mindmap,
        patterns,
        patterns.meta,
        petri,
        plothandlers,
        plotmarks,
        positioning,
        quotes,
        scopes,
        shadows,
        shapes,
        shapes.arrows,
        shapes.callouts,
        shapes.geometric,
        shapes.misc,
        shapes.multipart,
        shapes.symbols,
        spy,
        svg.path,
        through,
        tikzmark,
        trees
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendices
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifllncscrypto@loadappendix
    \RequirePackage[page, title, header, titletoc, toc]{appendix}   % For handling appendices
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Cryptography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifllncscrypto@loadcrypto
    \IfFileExists{tcscrypto.sty}{\RequirePackage{tcscrypto}}       % Cryptography macros
    {\PackageWarning{llncscrypto}{Package `tcscrypto` not found.}} %
    \RequirePackage{orcidlink}                                     % ORCID ID and Logo
\fi

\ifllncscrypto@loadnicodemus
    \IfFileExists{nicodemus.sty}{\RequirePackage{nicodemus}}       % Nicodemus macros
    {\PackageWarning{llncscrypto}{Package `nicodemus` not found.}} %
    \RequirePackage{orcidlink}                                     % ORCID ID and Logo
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Theorem Environments for LLNCS Style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifllncscrypto@modtheorems
    \AtBeginDocument{%
        % Theorem-like environments
        \@ifundefined{theorem}{}{\let\theorem\relax}
        \@ifundefined{assertion}{}{\let\assertion\relax}
        \@ifundefined{assumption}{}{\let\assumption\relax}
        \@ifundefined{axiom}{}{\let\axiom\relax}
        \@ifundefined{claim}{}{\let\claim\relax}
        \@ifundefined{conclusion}{}{\let\conclusion\relax}
        \@ifundefined{conjecture}{}{\let\conjecture\relax}
        \@ifundefined{corollary}{}{\let\corollary\relax}
        \@ifundefined{fact}{}{\let\fact\relax}
        \@ifundefined{hypothesis}{}{\let\hypothesis\relax}
        \@ifundefined{lemma}{}{\let\lemma\relax}
        \@ifundefined{postulate}{}{\let\postulate\relax}
        \@ifundefined{property}{}{\let\property\relax}
        \@ifundefined{proposition}{}{\let\proposition\relax}

        \spnewtheorem{theorem}{Theorem}{\bfseries}{\normalfont}
        \spnewtheorem{assertion}{Assertion}{\bfseries}{\normalfont}
        \spnewtheorem{assumption}{Assumption}{\bfseries}{\normalfont}
        \spnewtheorem{axiom}{Axiom}{\bfseries}{\normalfont}
        \spnewtheorem{claim}{Claim}{\bfseries}{\normalfont}
        \spnewtheorem{conclusion}{Conclusion}{\bfseries}{\normalfont}
        \spnewtheorem{conjecture}{Conjecture}{\bfseries}{\normalfont}
        \spnewtheorem{corollary}{Corollary}{\bfseries}{\normalfont}
        \spnewtheorem{fact}{Fact}{\bfseries}{\normalfont}
        \spnewtheorem{hypothesis}{Hypothesis}{\bfseries}{\normalfont}
        \spnewtheorem{lemma}{Lemma}{\bfseries}{\normalfont}
        \spnewtheorem{postulate}{Postulate}{\bfseries}{\normalfont}
        \spnewtheorem{property}{Property}{\bfseries}{\normalfont}
        \spnewtheorem{proposition}{Proposition}{\bfseries}{\normalfont}

        % Definition-like
        \@ifundefined{application}{}{\let\application\relax}
        \@ifundefined{construction}{}{\let\construction\relax}
        \@ifundefined{convention}{}{\let\convention\relax}
        \@ifundefined{definition}{}{\let\definition\relax}
        \@ifundefined{experiment}{}{\let\experiment\relax}
        \@ifundefined{notation}{}{\let\notation\relax}
        \@ifundefined{problem}{}{\let\problem\relax}
        \@ifundefined{protocol}{}{\let\protocol\relax}
        \@ifundefined{result}{}{\let\result\relax}
        \spnewtheorem{application}{Application}{\bfseries}{\normalfont}
        \spnewtheorem{construction}{Construction}{\bfseries}{\normalfont}
        \spnewtheorem{convention}{Convention}{\bfseries}{\normalfont}
        \spnewtheorem{definition}{Definition}{\bfseries}{\normalfont}
        \spnewtheorem{experiment}{Experiment}{\bfseries}{\normalfont}
        \spnewtheorem{notation}{Notation}{\bfseries}{\normalfont}
        \spnewtheorem{problem}{Problem}{\bfseries}{\normalfont}
        \spnewtheorem{protocol}{Protocol}{\bfseries}{\normalfont}
        \spnewtheorem{result}{Result}{\bfseries}{\normalfont}

        % Remark-like environments
        \@ifundefined{commentary}{}{\let\commentary\relax}
        \@ifundefined{example}{}{\let\example\relax}
        \@ifundefined{exercise}{}{\let\exercise\relax}
        \@ifundefined{motivation}{}{\let\motivation\relax}
        \@ifundefined{notationabuse}{}{\let\notationabuse\relax}
        \@ifundefined{note}{}{\let\note\relax}
        \@ifundefined{observation}{}{\let\observation\relax}
        \@ifundefined{question}{}{\let\question\relax}
        \@ifundefined{remark}{}{\let\remark\relax}
        \spnewtheorem{commentary}{Commentary}{\scshape}{\normalfont}
        \spnewtheorem{example}{Example}{\scshape}{\normalfont}
        \spnewtheorem{exercise}{Exercise}{\scshape}{\normalfont}
        \spnewtheorem{motivation}{Motivation}{\scshape}{\normalfont}
        \spnewtheorem{notationabuse}{Notation Abuse}{\scshape}{\normalfont}
        \spnewtheorem{note}{Note}{\scshape}{\normalfont}
        \spnewtheorem{observation}{Observation}{\scshape}{\normalfont}
        \spnewtheorem{question}{Question}{\scshape}{\normalfont}
        \spnewtheorem{remark}{Remark}{\scshape}{\normalfont}

        % Highlight environments
        \@ifundefined{guideline}{}{\let\guideline\relax}
        \@ifundefined{highlight}{}{\let\highlight\relax}
        \@ifundefined{important}{}{\let\important\relax}
        \@ifundefined{insight}{}{\let\insight\relax}
        \@ifundefined{keypoint}{}{\let\keypoint\relax}
        \@ifundefined{recall}{}{\let\recall\relax}
        \@ifundefined{summary}{}{\let\summary\relax}
        \@ifundefined{takeaway}{}{\let\takeaway\relax}
        \@ifundefined{tip}{}{\let\tip\relax}
        \@ifundefined{warning}{}{\let\warning\relax}
        \spnewtheorem{guideline}{Guideline}{\sffamily}{\normalfont}
        \spnewtheorem{highlight}{Highlight}{\sffamily}{\normalfont}
        \spnewtheorem{important}{Important}{\sffamily}{\normalfont}
        \spnewtheorem{insight}{Insight}{\sffamily}{\normalfont}
        \spnewtheorem{keypoint}{Key Point}{\sffamily}{\normalfont}
        \spnewtheorem{recall}{Recall}{\sffamily}{\normalfont}
        \spnewtheorem{summary}{Summary}{\sffamily}{\normalfont}
        \spnewtheorem{takeaway}{Takeaway}{\sffamily}{\normalfont}
        \spnewtheorem{tip}{Tip}{\sffamily}{\normalfont}
        \spnewtheorem{warning}{Warning}{\sffamily}{\normalfont}

        % Redefine proof environment (optional tweak)
        \let\oldproof\proof
        \renewenvironment{proof}{\begin{oldproof}}{\qed\end{oldproof}\vspace*{10pt}}

        % Custom proof environment for claims
        \newcommand*{\claimproofname}{Claim}
        \newenvironment{claimproof}[1][\claimproofname]{\begin{proof}[#1]}{\end{proof}}

        % Custom claim counter
        \newcounter{claimcounter}[theorem]
        \renewenvironment{claim}{\stepcounter{claimcounter}{Claim \theclaimcounter:}}{}
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Cleveref Setup
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[capitalize,nameinlink,noabbrev]{cleveref} % Smart referencing with automatic names

% Sectioning names for cleveref
\crefname{section}{\textsection}{\textsection\textsection}
\Crefname{section}{\textsection}{\textsection\textsection}
\crefname{subsection}{\textsection}{\textsection\textsection}
\Crefname{subsection}{\textsection}{\textsection\textsection}
\crefname{subsubsection}{\textsection}{\textsection\textsection}
\Crefname{subsubsection}{\textsection}{\textsection\textsection}

% Declare names for all environments for cref/Cref
% Theorem-like
\crefname{theorem}{theorem}{theorems}
\Crefname{theorem}{Theorem}{Theorems}
\crefname{assertion}{assertion}{assertions}
\Crefname{assertion}{Assertion}{Assertions}
\crefname{assumption}{assumption}{assumptions}
\Crefname{assumption}{Assumption}{Assumptions}
\crefname{axiom}{axiom}{axioms}
\Crefname{axiom}{Axiom}{Axioms}
\crefname{claim}{claim}{claims}
\Crefname{claim}{Claim}{Claims}
\crefname{conclusion}{conclusion}{conclusions}
\Crefname{conclusion}{Conclusion}{Conclusions}
\crefname{conjecture}{conjecture}{conjectures}
\Crefname{conjecture}{Conjecture}{Conjectures}
\crefname{corollary}{corollary}{corollaries}
\Crefname{corollary}{Corollary}{Corollaries}
\crefname{fact}{fact}{facts}
\Crefname{fact}{Fact}{Facts}
\crefname{hypothesis}{hypothesis}{hypotheses}
\Crefname{hypothesis}{Hypothesis}{Hypotheses}
\crefname{lemma}{lemma}{lemmas}
\Crefname{lemma}{Lemma}{Lemmas}
\crefname{postulate}{postulate}{postulates}
\Crefname{postulate}{Postulate}{Postulates}
\crefname{property}{property}{properties}
\Crefname{property}{Property}{Properties}
\crefname{proposition}{proposition}{propositions}
\Crefname{proposition}{Proposition}{Propositions}

% Definition-like
\crefname{application}{application}{applications}
\Crefname{application}{Application}{Applications}
\crefname{construction}{construction}{constructions}
\Crefname{construction}{Construction}{Constructions}
\crefname{convention}{convention}{conventions}
\Crefname{convention}{Convention}{Conventions}
\crefname{definition}{definition}{definitions}
\Crefname{definition}{Definition}{Definitions}
\crefname{experiment}{experiment}{experiments}
\Crefname{experiment}{Experiment}{Experiments}
\crefname{notation}{notation}{notations}
\Crefname{notation}{Notation}{Notations}
\crefname{problem}{problem}{problems}
\Crefname{problem}{Problem}{Problems}
\crefname{protocol}{protocol}{protocols}
\Crefname{protocol}{Protocol}{Protocols}
\crefname{result}{result}{results}
\Crefname{result}{Result}{Results}

% Remark-like
\crefname{commentary}{commentary}{commentaries}
\Crefname{commentary}{Commentary}{Commentaries}
\crefname{example}{example}{examples}
\Crefname{example}{Example}{Examples}
\crefname{exercise}{exercise}{exercises}
\Crefname{exercise}{Exercise}{Exercises}
\crefname{motivation}{motivation}{motivations}
\Crefname{motivation}{Motivation}{Motivations}
\crefname{notationabuse}{notation abuse}{notation abuses}
\Crefname{notationabuse}{Notation Abuse}{Notation Abuses}
\crefname{note}{note}{notes}
\Crefname{note}{Note}{Notes}
\crefname{observation}{observation}{observations}
\Crefname{observation}{Observation}{Observations}
\crefname{question}{question}{questions}
\Crefname{question}{Question}{Questions}
\crefname{remark}{remark}{remarks}
\Crefname{remark}{Remark}{Remarks}

% Highlight-like
\crefname{guideline}{guideline}{guidelines}
\Crefname{guideline}{Guideline}{Guidelines}
\crefname{highlight}{highlight}{highlights}
\Crefname{highlight}{Highlight}{Highlights}
\crefname{important}{important point}{important points}
\Crefname{important}{Important}{Important Points}
\crefname{insight}{insight}{insights}
\Crefname{insight}{Insight}{Insights}
\crefname{keypoint}{key point}{key points}
\Crefname{keypoint}{Key Point}{Key Points}
\crefname{recall}{recall}{recalls}
\Crefname{recall}{Recall}{Recalls}
\crefname{summary}{summary}{summaries}
\Crefname{summary}{Summary}{Summaries}
\crefname{takeaway}{takeaway}{takeaways}
\Crefname{takeaway}{Takeaway}{Takeaways}
\crefname{tip}{tip}{tips}
\Crefname{tip}{Tip}{Tips}
\crefname{warning}{warning}{warnings}
\Crefname{warning}{Warning}{Warnings}

% Proof
\crefname{proof}{proof}{proofs}
\Crefname{proof}{Proof}{Proofs}

\renewcommand{\cref}[1]{\Cref{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Commenting and Version Control Macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifFullVersion    \FullVersiontrue
\newif\ifShortVersion   \ShortVersionfalse
\newif\ifComments       \Commentsfalse
\newif\ifAnonymize      \Anonymizefalse

\NewDocumentCommand{\fullversion}{}{\FullVersiontrue\ShortVersionfalse}
\NewDocumentCommand{\shortversion}{}{\ShortVersiontrue\FullVersionfalse}
\NewDocumentCommand{\usecomments}{}{\Commentstrue}

\NewDocumentCommand{\newcomment}{mmm}{%
    \expandafter\NewDocumentCommand\csname#3\endcsname{m}{%
        \ifComments
            \noindent\textcolor{#2}{\sffamily##1 -- $\mathsf{#1}$}%
        \fi
    }%
}

% Define acknowledgment environment with an optional title.
\NewDocumentEnvironment{acknowledgment}{o}{%
    \IfNoValueTF{#1}{%
        \noindent\textsf{Acknowledgment.}% Default title if not provided
    }{%
        \noindent\textsf{#1}% Use custom title if provided
    }
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Paragraph formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Flag for punctuation detection
\newif\ifllncscrypto@haspunctuation

% Check whether the second argument is empty (used for punctuation detection)
\def\llncscrypto@checkpunctuation#1{%
    \ifx\llncscrypto@checkpunctuation#1\llncscrypto@checkpunctuation
    \else
        \llncscrypto@haspunctuationtrue
    \fi
}

% Specific punctuation testers for '.', '?', '!', ':'
\def\llncscrypto@checkdot#1.\llncscrypto@delim#2\llncscrypto@stop{\llncscrypto@checkpunctuation{#2}}
\def\llncscrypto@checkquestion#1?\llncscrypto@delim#2\llncscrypto@stop{\llncscrypto@checkpunctuation{#2}}
\def\llncscrypto@checkexclam#1!\llncscrypto@delim#2\llncscrypto@stop{\llncscrypto@checkpunctuation{#2}}
\def\llncscrypto@checkcolon#1:\llncscrypto@delim#2\llncscrypto@stop{\llncscrypto@checkpunctuation{#2}}

% Main interface: Append period unless line ends with '.', '?', '!', or ':'
\def\llncscrypto@appendpunctuationifneeded#1{%
    \llncscrypto@haspunctuationfalse
    \llncscrypto@checkdot#1\llncscrypto@delim.\llncscrypto@delim\llncscrypto@stop
    \llncscrypto@checkquestion#1\llncscrypto@delim?\llncscrypto@delim\llncscrypto@stop
    \llncscrypto@checkexclam#1\llncscrypto@delim!\llncscrypto@delim\llncscrypto@stop
    \llncscrypto@checkcolon#1\llncscrypto@delim:\llncscrypto@delim\llncscrypto@stop
    #1\ifllncscrypto@haspunctuation \else.\fi%
}

% Skip spaces and implicit paragraphs (blank lines)
\def\llncscrypto@ignorewhitespaceandimplicitpars{%
    \begingroup
    \catcode13=10 %
    \@ifnextchar\relax
    {\endgroup}
    {\endgroup}%
}

% Skip spaces, implicit paragraphs, and explicit \par commands
\def\llncscrypto@ignoreallpars{%
    \begingroup
    \catcode13=10 %
    \@ifnextchar\par
    {\endgroup\expandafter\llncscrypto@ignoreallpars\@gobble}
    {\endgroup}%
}

% Section-style paragraph header with automatic punctuation and spacing
\newcommand{\llncscrypto@paragraphhead}[1]{%
    \smallskip
    \noindent
    \textbf{\boldmath\ignorespaces\llncscrypto@appendpunctuationifneeded{#1}}%
    \hskip 0.9em plus 0.3em minus 0.3em
    \llncscrypto@ignorewhitespaceandimplicitpars
}

\newcommand{\parhead}[1]{\llncscrypto@paragraphhead{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Nested bar environment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    

% Custom box construction with vertical rule, top/bottom bars, and optional content
\long\def\llncscrypto@customfbox#1#2#3#4#5#6#7#8#9{%
    \leavevmode
    \begingroup
    \setbox\@tempboxa\hbox{%
        \color@begingroup
        \kern\fboxsep{#9}\kern\fboxsep
        \color@endgroup}%
    \hbox{%
        \begingroup
        \@tempdima#4\relax
        \advance\@tempdima\fboxsep
        \advance\@tempdima\dp\@tempboxa
        \expandafter\endgroup
        \expandafter\lower\the\@tempdima\hbox{%
            \vbox{%
                \hrule \@height#3 \@width#7
                #1%
                \hbox{%
                    \vrule \@width#5
                    \hspace{#8}%
                    \vbox{%
                        \vskip\fboxsep
                        \copy\@tempboxa
                        \vskip\fboxsep}%
                    \vrule \@width#6}%
                #2%
                \hrule \@height#4\@width#7}%
        }%
    }%
    \endgroup
}

% Parameters for bar dimensions and spacing
\newcommand{\llncscrypto@nestedbar@topbotrulelength}{1em}
\newcommand{\llncscrypto@nestedbar@indent}{0.4em}

% FrameCommand helper that sets up side rule and spacing
\def\llncscrypto@openframebox#1#2{%
    \fboxsep=\FrameSep
    \llncscrypto@customfbox
    {}{}% no content above or below
    {#1}{#2}% top and bottom rule thicknesses
    \FrameRule\z@% left and right rule thickness
    \llncscrypto@nestedbar@topbotrulelength% horizontal rule length
    \llncscrypto@nestedbar@indent% indent from vertical rule
}

% Definition of the nestedbar environment
\newenvironment{nestedbar}[1][\hsize]{%
    \@ifundefined{OuterFrameSep}{%
        \@latex@error{To use nestedbar, update framed.sty to a recent version.}\@ehd}{}%
    \def\FrameCommand{\llncscrypto@openframebox\FrameRule\FrameRule}%
    \def\FirstFrameCommand{\llncscrypto@openframebox\FrameRule\z@}%
    \def\MidFrameCommand{\llncscrypto@openframebox\z@\z@}%
    \def\LastFrameCommand{\llncscrypto@openframebox\z@\FrameRule}%
    \OuterFrameSep=1ex
    \FrameSep=0pt
    \MakeFramed{\hsize#1\advance\hsize-\width\FrameRestore}%
}{%
    \endMakeFramed
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Useful commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
\@ifpackageloaded{enumitem}{%
    % Define 'points' list: itemize using "--"
    \newlist{points}{itemize}{1}
    \setlist[points]{%
        label={\textendash},
        leftmargin=1em,
        itemsep=1pt,
        align=left,
        before=\smallskip,
        after=\smallskip
    }

    % Define 'codelist' list: enumerated as [\texttt{1}], [\texttt{2}], ...
    \newlist{codelist}{enumerate}{1}
    \setlist[codelist,1]{%
        label=\textcolor{gray}{\texttt{[\arabic*]}},
        leftmargin=1em,
        itemsep=1pt,
        align=left,
        before=\smallskip,
        after=\smallskip
    }

    % Define 'checkbox' list
    \newlist{checkbox}{itemize}{1}
    \setlist[checkbox]{%
        label=$\square$,
        leftmargin=1em,
        align=left
    }
    % Define \checked command to switch label for one item
    \newcommand{\checked}{\item[\checkmark]}

    % Define a rigorous description list for definitions
    \newlist{deflist}{description}{1}
    \setlist[deflist]{%
        labelwidth=0.35\textwidth,
        labelsep=1em,
        leftmargin=0.35\textwidth,
        font=\normalfont\bfseries,
        style=nextline,
        itemsep=5pt
    }
}{}

% Highlight color for text and math
\providecommand{\highlightcolor}{RoyalBlue}
\providecommand{\sethighlightcolor}[1]{\renewcommand{\highlightcolor}{#1}}

% Text and math highlighting
\providecommand{\textem}[1]{\textcolor{\highlightcolor}{#1}}
\providecommand{\emphtext}[1]{\textcolor{\highlightcolor}{#1}}
\providecommand{\emphmath}[1]{\textcolor{\highlightcolor}{\mathrm{#1}}}

% Code highlighting
\providecommand{\code}[1]{\texttt{#1}}

% Math small caps and bold italic
\providecommand{\mathsc}[1]{\textnormal{\textsc{#1}}}
\providecommand{\mathbi}[1]{\textnormal{\textbf{\textit{#1}}}}

% Inline math shortcut
\providecommand{\inmath}[1]{\ensuremath{#1}}

% Hyphen in math
\mathchardef\mathhyphen="2D

% Put in quotes
\providecommand{\putInQuotes}[1]{``#1''}

% Strike-through text
\providecommand{\strike}[1]{\bgroup\ULdepth=-.55ex\ULset\strike{#1}\egroup}

% Highlight missing or problematic text
\newcounter{missingctr}
\providecommand{\missinglist}{}

% Main \missing command
\providecommand{\missing}[1]{%
    \refstepcounter{missingctr}%
    \label{missing:\themissingctr}%
    \gappto\missinglist{%
        \noindent\textcolor{Brown4}{\ensuremath{\star}~\themissingctr~(\textsf{Missing at p.~\pageref{missing:\themissingctr}}):~#1}\par\medskip
    }%
    \textcolor{Brown4}{#1}%
}

% Print all collected missing items with page references
\providecommand{\printmissing}{%
    \section*{Missing Content Report}%
    \missinglist
}

% Format for missing citations
\providecommand{\missingcitation}{\textcolor{red}{\code{<Citation Missing>}}}

% Double-struck Pi symbol for different engines
\providecommand{\dsPi}{%
    \ifluatex
        \char"213F
    \else
        \ifxetex
            \char"213F
        \else
            \Pi
        \fi
    \fi
}

% Sans-serif Pi symbol for different engines
\providecommand{\sansPi}{%
    \ifluatex
        \char"1D765
    \else
        \ifxetex
            \char"1D765
        \else
            \Pi
        \fi
    \fi
}

\@ifpackageloaded{mdframed}{%
    % Protocol box environment
    \NewDocumentEnvironment{protocolbox}{o}
    {%
        \begin{mdframed}[
                font=\small,
                roundcorner=1.5pt,
                linewidth=0.5pt,
                skipabove=0.5\baselineskip,
                skipbelow=0.1\baselineskip,
                leftmargin=0pt,
                rightmargin=0pt,
                innerleftmargin=5pt,
                innerrightmargin=5pt,
                innertopmargin=5pt,
                innerbottommargin=5pt,
                backgroundcolor=white,
                linecolor=black
            ]%
            \IfNoValueF{#1}{%
                \noindent\textnormal{\small\textbf{#1}}\par\smallskip
                \noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
            }%
            \begin{points}%
                }
                {%
            \end{points}
        \end{mdframed}%
    }

    % Code list box environment
    \NewDocumentEnvironment{codelistbox}{o}
    {%
        \begin{mdframed}[
                font=\small,
                roundcorner=1.5pt,
                linewidth=0.5pt,
                skipabove=0.5\baselineskip,
                skipbelow=0.1\baselineskip,
                leftmargin=0pt,
                rightmargin=0pt,
                innerleftmargin=5pt,
                innerrightmargin=5pt,
                innertopmargin=5pt,
                innerbottommargin=5pt,
                backgroundcolor=white,
                linecolor=black
            ]%
            \IfNoValueF{#1}{%
                \noindent\textnormal{\small\textbf{#1}}\par\smallskip
                \noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
            }%
            \begin{codelist}%
                }
                {%
            \end{codelist}
        \end{mdframed}%
    }

    \NewDocumentEnvironment{simplebox}{o}
    {%
        \begin{mdframed}[
                font=\small,
                roundcorner=1.5pt,
                linewidth=0.5pt,
                skipabove=0.5\baselineskip,
                skipbelow=0.1\baselineskip,
                leftmargin=0pt,
                rightmargin=0pt,
                innerleftmargin=5pt,
                innerrightmargin=5pt,
                innertopmargin=5pt,
                innerbottommargin=5pt,
                backgroundcolor=white,
                linecolor=black
            ]%
            \IfNoValueF{#1}{%
                \noindent\textnormal{\small\textbf{#1}}\par\smallskip
                \noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
            }%
            }
            {%
        \end{mdframed}%
    }
}{}

\@ifpackageloaded{tcolorbox}{%
    % Wire box environment
    \newtcolorbox{wirebox}{%
        colframe=black,
        colback=white,
        sharp corners,
        boxrule=0.5pt,
        coltitle=black,
        colbacktitle=white,
        boxsep=5pt,
        top=0pt,
        bottom=0pt,
        left=5pt,
        right=5pt
    }
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Upright Greek Letters Setup Using `upgreek`
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{upgreek} % Load upright Greek letter symbols

% Provide definitions for missing uppercase Greek macros as roman letters, if undefined
\@ifundefined{Alpha}{\newcommand{\Alpha}{\mathrm{A}}}{}
\@ifundefined{Beta}{\newcommand{\Beta}{\mathrm{B}}}{}
\@ifundefined{Chi}{\newcommand{\Chi}{\mathrm{X}}}{}
\@ifundefined{Epsilon}{\newcommand{\Epsilon}{\mathrm{E}}}{}
\@ifundefined{Eta}{\newcommand{\Eta}{\mathrm{H}}}{}
\@ifundefined{Iota}{\newcommand{\Iota}{\mathrm{I}}}{}
\@ifundefined{Kappa}{\newcommand{\Kappa}{\mathrm{K}}}{}
\@ifundefined{Mu}{\newcommand{\Mu}{\mathrm{M}}}{}
\@ifundefined{Nu}{\newcommand{\Nu}{\mathrm{N}}}{}
\@ifundefined{Omicron}{\newcommand{\Omicron}{\mathrm{O}}}{}
\@ifundefined{Rho}{\newcommand{\Rho}{\mathrm{R}}}{}
\@ifundefined{Tau}{\newcommand{\Tau}{\mathrm{T}}}{}
\@ifundefined{Zeta}{\newcommand{\Zeta}{\mathrm{Z}}}{}
\@ifundefined{omicron}{\newcommand{\omicron}{\mathrm{o}}}{}

% Fallbacks for upright forms from `upgreek`, if undefined
\@ifundefined{Upalpha}{\newcommand{\Upalpha}{\mathrm{A}}}{}
\@ifundefined{Upbeta}{\newcommand{\Upbeta}{\mathrm{B}}}{}
\@ifundefined{Upchi}{\newcommand{\Upchi}{\mathrm{X}}}{}
\@ifundefined{Upepsilon}{\newcommand{\Upepsilon}{\mathrm{E}}}{}
\@ifundefined{Upeta}{\newcommand{\Upeta}{\mathrm{H}}}{}
\@ifundefined{Upiota}{\newcommand{\Upiota}{\mathrm{I}}}{}
\@ifundefined{Upkappa}{\newcommand{\Upkappa}{\mathrm{K}}}{}
\@ifundefined{Upmu}{\newcommand{\Upmu}{\mathrm{M}}}{}
\@ifundefined{Upnu}{\newcommand{\Upnu}{\mathrm{N}}}{}
\@ifundefined{Upomicron}{\newcommand{\Upomicron}{\mathrm{O}}}{}
\@ifundefined{Uprho}{\newcommand{\Uprho}{\mathrm{R}}}{}
\@ifundefined{Uptau}{\newcommand{\Uptau}{\mathrm{T}}}{}
\@ifundefined{Upzeta}{\newcommand{\Upzeta}{\mathrm{Z}}}{}
\@ifundefined{upomicron}{\newcommand{\upomicron}{\mathrm{o}}}{}

% If available, overwrite standard Greek macros with their upright versions
\@ifundefined{Upalpha}{}{\renewcommand{\Alpha}{\Upalpha}}
\@ifundefined{Upbeta}{}{\renewcommand{\Beta}{\Upbeta}}
\@ifundefined{Upchi}{}{\renewcommand{\Chi}{\Upchi}}
\@ifundefined{Updelta}{}{\renewcommand{\Delta}{\Updelta}}
\@ifundefined{Upepsilon}{}{\renewcommand{\Epsilon}{\Upepsilon}}
\@ifundefined{Upeta}{}{\renewcommand{\Eta}{\Upeta}}
\@ifundefined{Upgamma}{}{\renewcommand{\Gamma}{\Upgamma}}
\@ifundefined{Upiota}{}{\renewcommand{\Iota}{\Upiota}}
\@ifundefined{Upkappa}{}{\renewcommand{\Kappa}{\Upkappa}}
\@ifundefined{Uplambda}{}{\renewcommand{\Lambda}{\Uplambda}}
\@ifundefined{Upmu}{}{\renewcommand{\Mu}{\Upmu}}
\@ifundefined{Upnu}{}{\renewcommand{\Nu}{\Upnu}}
\@ifundefined{Upomega}{}{\renewcommand{\Omega}{\Upomega}}
\@ifundefined{Upomicron}{}{\renewcommand{\Omicron}{\Upomicron}}
\@ifundefined{Upphi}{}{\renewcommand{\Phi}{\Upphi}}
\@ifundefined{Uppi}{}{\renewcommand{\Pi}{\Uppi}}
\@ifundefined{Uppsi}{}{\renewcommand{\Psi}{\Uppsi}}
\@ifundefined{Uprho}{}{\renewcommand{\Rho}{\Uprho}}
\@ifundefined{Upsigma}{}{\renewcommand{\Sigma}{\Upsigma}}
\@ifundefined{Uptau}{}{\renewcommand{\Tau}{\Uptau}}
\@ifundefined{Uptheta}{}{\renewcommand{\Theta}{\Uptheta}}
\@ifundefined{Upupsilon}{}{\renewcommand{\Upsilon}{\Upupsilon}}
\@ifundefined{Upxi}{}{\renewcommand{\Xi}{\Upxi}}
\@ifundefined{Upzeta}{}{\renewcommand{\Zeta}{\Upzeta}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% NOTE: You do not need to modify this preamble. It is fully set up and ready. %
% If you wish to add or change anything, do so in the `settings.tex` and/or    %
% `commands.tex` files.                                                        %
% These files will be loaded automatically if they exist.                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\AtBeginDocument{%
    \IfFileExists{settings.tex}{\input{settings.tex}}{\typeout{"settings.tex" does not exists!}}
    \IfFileExists{commands.tex}{\input{commands.tex}}{\typeout{"commands.tex" does not exists!}}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% End of package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\endinput