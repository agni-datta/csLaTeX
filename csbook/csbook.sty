%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csbook.sty: Academic Documentation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title:        csbook – A Contemporary LaTeX Book-Style Package for Computer Science
% Version:      2.0 (2025/06/28)
% Author:       Agni Datta
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 1. Introduction and Rationale
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The `csbook` package is an advanced LaTeX style file engineered to facilitate
% the production of professional, modern, and highly legible books, lecture notes,
% and monographs, with particular emphasis on the requirements of computer science
% authors. It constitutes a core module of the csLaTeX suite, which is designed to
% deliver a coherent, extensible, and user-centric toolkit for academic writing.

% The guiding principle of `csbook` is the integration of best practices in
% typographic design, modularity, and usability. The package is intended for authors
% who prioritize both aesthetics and functionality, enabling them to concentrate on
% content rather than low-level formatting. It is especially appropriate for:
%   - University instructors preparing textbooks or lecture notes
%   - Graduate students composing theses or dissertations
%   - Researchers authoring monographs or technical reports
%   - Users seeking a modern alternative to the standard LaTeX book class

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 2. Feature Overview
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The `csbook` package offers the following principal features:

% - Modular activation of advanced packages for layout, typography, and code
% - Modernized sectioning and header formatting with customizable fonts and spacing
% - Configurable theorem, proof, and definition environments (via csthm)
% - Enhanced list environments (itemize, enumerate) with improved spacing and
%   custom labels for each nesting level
% - Support for colored and framed boxes for examples, theorems, and notes
%   (utilizing tcolorbox and mdframed)
% - Optional integration with TikZ for diagrams and PGFPlots for data
%   visualization, including comprehensive TikZ library support
% - Epigraphs for chapter or section openings, with customizable appearance
% - Appendix and advanced table of contents management
% - Glossary and index support, with integration of external tools
% - Improved verbatim/code environments for source code listings, including
%   patching for empty line handling
% - Abstract and acknowledgment environments with modern formatting
% - Consistent bibliography and table of contents formatting, with custom
%   commands for insertion and style
% - User-friendly custom commands for common tasks, including colored comments
% - Header-level formatting via titlesec, supporting custom section fonts
% - Full compatibility with the csLaTeX suite and standard LaTeX tools

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 3. Usage Instructions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% To employ `csbook`, place the package in your LaTeX search path and load it in
% the document preamble as follows:

%   \usepackage[<options>]{csbook}

% Options permit selective enabling or disabling of specific features as required.
% For example:

%   \usepackage[epigraph,glossaries,niceboxs,theorem,tikz,verbatim]{csbook}

% Options are independent and may be combined arbitrarily.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 4. Package Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The following options govern the activation of features:

%   adjusttoc      – Advanced table of contents formatting
%   appendix       – Appendix support
%   epigraph       – Epigraphs for chapters/sections
%   glossaries     – Glossary support
%   hyperref       – Hyperref integration for PDF navigation
%   indices        – Index support
%   niceboxs       – Modern colored/framed boxes (tcolorbox, mdframed)
%   nicelayout     – Enhanced page layout and margins
%   nicespacing    – Improved line and paragraph spacing
%   oldsection     – Classic section formatting
%   theorem        – Theorem/proof/definition environments (csthm)
%   tikz           – TikZ and PGFPlots for graphics, with comprehensive library support
%   usefulcommands – Common utility macros (enabled by default)
%   verbatim       – Enhanced verbatim/code environments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 5. Principal Advantages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% - **Modularity:** Only the features explicitly requested are loaded, ensuring a
%   concise preamble and efficient compilation.
% - **Modern Aesthetics:** Section headings, lists, and boxes are styled for
%   clarity and visual appeal, adhering to contemporary typographic standards.
% - **Code and Math Optimization:** Tailored for documents with substantial code
%   listings, algorithms, and mathematical notation.
% - **Extensibility:** Seamlessly integrates with other csLaTeX packages and
%   standard LaTeX tools.
% - **Consistency:** Guarantees a uniform appearance across chapters, appendices,
%   and supplementary material.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 6. Custom Commands and Environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The package defines a comprehensive suite of user-facing commands and environments.
% In addition to the principal environments and commands enumerated below, csbook
% supplies an extensive set of utility macros for text, mathematics, code, lists,
% and collaborative writing. Refer to the extended list following the main features.

% - **Section Heading Customization:**
%     \sectionheadingfont, \subsectionheadingfont, etc. – Redefine heading fonts
% - **Modern Boxes:**
%     If `niceboxs` is enabled, environments such as `tcolorbox` and `mdframed`
%     are available for constructing colored and framed boxes, suitable for
%     highlighting theorems, examples, or important notes.
% - **Epigraphs:**
%     If `epigraph` is enabled, use \epigraph{<text>}{<author>} to insert
%     introductory quotations. The appearance is configurable (width, rule,
%     alignment, font).
% - **Acknowledgment:**
%     \begin{acknowledgment}[<optional title>] ... \end{acknowledgment}
% - **Abstract:**
%     \begin{abstract} ... \end{abstract}
% - **Table of Contents:**
%     \toc – Inserts a formatted table of contents with appropriate spacing and page breaks.
% - **Bibliography:**
%     \printbib[<style>]{<bibfile>} – Prints the bibliography with the specified
%     style (default: alphaurl).
% - **Custom Comments:**
%     \newcomment{name}{color}{command} – Defines a colored comment macro for
%     collaborative annotation.
% - **Enhanced Lists:**
%     Enumerate and itemize environments are redefined for improved labels and
%     spacing (e.g., (1), (a), (I) for enumerate; bullet, en dash, open circle
%     for itemize).
%     Additional list environments:
%       - codelist: enumerate with [1], [2], ... for code steps
%       - checkbox: itemize with empty box, checkmark, or crossmark
%       - deflist: description list with bold labels
%     List item commands:
%       - \taskitem: item with empty box
%       - \checkeditem: item with checkmark
%       - \uncheckeditem: item with crossmark
% - **Verbatim/Code:**
%     If `verbatim` is enabled, enhanced verbatim environments are provided,
%     with improved handling of empty lines and formatting.
% - **Appendices:**
%     If `appendix` is enabled, advanced appendix management is available.
% - **Theorem Environments:**
%     If `theorem` is enabled, theorem, proof, definition, and related
%     environments are provided via csthm, with modern styling and numbering.
% - **TikZ Graphics:**
%     If `tikz` is enabled, TikZ, PGFPlots, and a comprehensive set of TikZ libraries
%     are loaded for advanced diagramming and plotting.

% ---------------------------------------------------------------------------
% Additional Utility Commands Provided by csbook:
% ---------------------------------------------------------------------------

% -- Text and Math Highlighting:
%   \emphmath{<math>}      – Emphasize mathematics in highlight color
%   \emphtext{<text>}      – Emphasize text in highlight color
%   \textem{<text>}        – Alias for \emphtext
%   \textbi{<text>}        – Bold italic text
%   \code{<text>}          – Inline code font (\texttt)
%   \mathsc{<text>}        – Math small caps (upright)
%   \mathbi{<text>}        – Math bold italic (upright)
%   \inmath{<math>}        – Inline math shortcut (\ensuremath)
%   \putInQuotes{<text>}   – Typeset text in English-style quotation marks

% -- Math and Symbol Utilities:
%   \mathhyphen            – Hyphen/minus in math mode

% -- List and Task Utilities:
%   \taskitem              – List item with empty box (for checklists)
%   \checkeditem           – List item with checkmark
%   \uncheckeditem         – List item with crossmark

% -- Missing Content Reporting:
%   \missing{<description>} – Mark missing content and collect for reporting
%   \missinglist            – List of all missing items (for reporting)

% -- Miscellaneous:
%   \newcomment{name}{color}{command} – Define a colored comment macro
%   (e.g., \newcomment{Bob}{blue}{bobnote} yields \bobnote{...})

% -- List Environments (in addition to standard itemize/enumerate):
%   codelist                – Enumerate with [1], [2], ... for code steps
%   checkbox                – Itemize with empty box, checkmark, or crossmark
%   deflist                 – Description list with bold labels

% -- Section Heading Font Customization:
%   \sectionheadingfont, \subsectionheadingfont, etc. – Redefine heading fonts

% -- Table of Contents and Bibliography:
%   \toc                    – Insert formatted table of contents
%   \printbib[<style>]{<bibfile>} – Print bibliography with specified style

% -- Abstract and Acknowledgment Environments:
%   \begin{abstract}...\end{abstract}
%   \begin{acknowledgment}[<title>]...\end{acknowledgment}

% -- Epigraphs:
%   \epigraph{<text>}{<author>} – Insert an epigraph

% -- Enhanced Verbatim/Code Environments:
%   (if enabled) – Improved verbatim/code with blank line handling

% -- Theorem/Proof/Definition Environments:
%   (if enabled) – Modern theorem/proof/definition environments via csthm

% -- TikZ/PGFPlots Graphics:
%   (if enabled) – Comprehensive TikZ and PGFPlots support with libraries

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 7. Style and Formatting Principles (Comprehensive)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% - **Section Headings:** Modern, bold, and optionally centered section titles
%   with clear numbering and spacing, customizable via \sectionheadingfont, etc.
% - **Lists:** Compact, visually distinct list items with minimal vertical spacing.
%   Enumerate and itemize environments employ custom labels for each nesting level.
% - **Boxes:** Utilization of `tcolorbox` and `mdframed` for visually appealing
%   framed environments, supporting theorems, proofs, and examples.
% - **Epigraphs:** Right-aligned, small-caps author attributions, and adjustable
%   width and rule.
% - **Typography:** Defaults to legible font sizes and line spacing, with
%   options for further customization.
% - **Code Listings:** Enhanced verbatim environments for code, with optional
%   syntax highlighting if used in conjunction with other packages.
% - **Bibliography and TOC:** Consistent formatting, with spacing and page breaks
%   to enhance readability.
% - **Header-level Formatting:** Employs titlesec for flexible section formatting.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 8. Limitations and Caveats (Comprehensive)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% - **Package Interactions:** Although `csbook` is designed for modularity, certain
%   features (e.g., advanced theorem environments, TikZ) may conflict with
%   packages that redefine the same environments. Users should test their preamble
%   when employing additional customizations.
% - **Font Choices:** The package does not prescribe a specific font family,
%   allowing users to select their preferred fonts. For optimal results, use with
%   a modern font package (e.g., `lmodern`, `newtx`, or `mathpazo`).
% - **Language Support:** Multilingual support is not enabled by default; employ
%   `babel` or `polyglossia` as required.
% - **Glossaries/Indices:** These features necessitate external tools (e.g.,
%   `makeglossaries`, `makeindex`) for compilation.
% - **Backward Compatibility:** Some features may be unavailable in legacy
%   TeX distributions. Use a recent TeX Live or MiKTeX for full compatibility.
% - **Customization:** While many aspects are customizable, substantial changes to
%   sectioning or theorem styles may require patching the package or advanced
%   LaTeX techniques.
% - **Theorem Styles:** The theorem environments depend on the presence of
%   `csthm.sty`. If this file is absent, a warning is issued and the
%   environments are not loaded.
% - **TikZ/PGFPlots:** The complete set of TikZ libraries is loaded if the `tikz`
%   option is enabled, which may increase compilation time and memory usage.
% - **Verbatim Patch:** The patch for verbatim environments suppresses empty lines,
%   which may affect code listings that rely on blank lines.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 9. Changelog (Comprehensive)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% v2.0 (2025/06/28)
%   - Major refactor for modularity and option-based loading
%   - Enhanced documentation and code comments
%   - Improved support for modern boxes (tcolorbox, mdframed)
%   - New custom commands for TOC and bibliography insertion
%   - Refined list formatting and spacing
%   - Epigraph environment now utilizes xparse for flexibility
%   - Added support for collaborative comment macros
%   - Improved abstract and acknowledgment environments
%   - Enhanced compatibility with csLaTeX suite
%   - Comprehensive TikZ library loading for advanced graphics
%   - Patched verbatim environment to suppress empty lines
%   - Added appendix and glossary support with external tool integration
%   - Introduced header-level formatting with titlesec
%   - Improved modularity for all features via boolean flags and options
%   - Added warning for missing csthm.sty
%   - Improved bibliography and TOC formatting
%   - Added support for indices and hyperref integration

% v1.5 (2024/07/15)
%   - Introduced TikZ/PGFPlots integration
%   - Enhanced theorem and proof environments
%   - Improved appendix and glossary support
%   - Added support for indices and refined list environments

% v1.2 (2024/03/10)
%   - Added support for collaborative colored comments
%   - Improved abstract and acknowledgment environments
%   - Enhanced compatibility with csLaTeX suite

% v1.0 (2023/12/01)
%   - Initial release with core features: section formatting, lists, boxes,
%     basic theorem environments, and utility commands

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 10. Example Usage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \documentclass{book}
% \usepackage[epigraph,niceboxs,theorem,verbatim,tikz,glossaries,indices,hyperref]{csbook}
%
% \begin{document}
%
% \begin{abstract}
%   This book provides an introduction to modern algorithms...
% \end{abstract}
%
% \toc
%
% \chapter{Introduction}
% \epigraph{All models are wrong, but some are useful.}{George Box}
%
% \section{Motivation}
% \begin{acknowledgment}
%   The author thanks the csLaTeX community for their support.
% \end{acknowledgment}
%
% \begin{tcolorbox}[title=Key Idea]
%   Divide and conquer is a fundamental paradigm...
% \end{tcolorbox}
%
% \begin{itemize}
%   \item Fast
%   \item Modular
%   \item Readable
% \end{itemize}
%
% \printbib{references}
%
% \end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 11. Support and Further Information
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% For bug reports, feature requests, or contributions, please consult the
% csLaTeX project repository or contact the maintainer.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesPackage{csbook}[2025/06/28 v2.0 csbook package]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core Programming and Utility Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{blindtext}									 % Generate blind documents
\RequirePackage{calc}                                        % Arithmetic with lengths
\RequirePackage{comment}                                     % Block comment environment
\RequirePackage{etoolbox}                                    % Logic and macro patching
\RequirePackage{ifpdf}                                       % Detect PDF output mode
\RequirePackage{iftex}                                       % Detect engine: pdfTeX, XeTeX, LuaTeX
\RequirePackage{kvoptions}									 % Key-value options
\RequirePackage{lipsum}                                      % Dummy text generation
\RequirePackage{xkeyval}                                     % Key-value parsing
\RequirePackage{xparse}                                      % Extended command/environment definitions

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Package Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifcsbook@LoadAdjustToC 			\csbook@LoadAdjustToCfalse
\newif\ifcsbook@LoadAppendix            \csbook@LoadAppendixfalse
\newif\ifcsbook@LoadDefaultFont         \csbook@LoadDefaultFontfalse
\newif\ifcsbook@LoadEpigraph            \csbook@LoadEpigraphfalse
\newif\ifcsbook@LoadGlossaries          \csbook@LoadGlossariesfalse
\newif\ifcsbook@LoadHyperref            \csbook@LoadHyperreffalse
\newif\ifcsbook@LoadIndices             \csbook@LoadIndicesfalse
\newif\ifcsbook@LoadNiceBoxs            \csbook@LoadNiceBoxsfalse
\newif\ifcsbook@LoadNiceLayout          \csbook@LoadNiceLayoutfalse
\newif\ifcsbook@LoadNiceSpacing         \csbook@LoadNiceSpacingfalse
\newif\ifcsbook@LoadOldSection          \csbook@LoadOldSectionfalse
\newif\ifcsbook@LoadTheorem             \csbook@LoadTheoremfalse
\newif\ifcsbook@LoadTikZ                \csbook@LoadTikZfalse
\newif\ifcsbook@LoadUsefulCommands      \csbook@LoadUsefulCommandstrue
\newif\ifcsbook@LoadVerbatim            \csbook@LoadVerbatimfalse

% Declare package options
\DeclareOption{adjusttoc}{\csbook@LoadAppendixtrue}
\DeclareOption{appendix}{\csbook@LoadAdjustToCtrue}
\DeclareOption{defaultfont}{\csbook@LoadDefaultFonttrue}
\DeclareOption{epigraph}{\csbook@LoadEpigraphtrue}
\DeclareOption{glossaries}{\csbook@LoadGlossariestrue}
\DeclareOption{hyperref}{\csbook@LoadHyperreftrue}
\DeclareOption{indices}{\csbook@LoadIndicestrue}
\DeclareOption{niceboxs}{\csbook@LoadNiceBoxstrue}
\DeclareOption{nicelayout}{\csbook@LoadNiceLayouttrue}
\DeclareOption{nicespacing}{\csbook@LoadNiceSpacingtrue}
\DeclareOption{oldsection}{\csbook@LoadOldSectiontrue}
\DeclareOption{theorem}{\csbook@LoadTheoremtrue}
\DeclareOption{tikz}{\csbook@LoadTikZtrue}
\DeclareOption{usefulcommands}{\csbook@LoadUsefulCommandstrue}
\DeclareOption{verbatim}{\csbook@LoadVerbatimtrue}
\DeclareOption{full}{%
	\csbook@LoadHyperreftrue
	\csbook@LoadNiceBoxstrue
	\csbook@LoadNiceLayouttrue
	\csbook@LoadNiceSpacingtrue
	\csbook@LoadUsefulCommandstrue
	\csbook@LoadVerbatimtrue
}

% Ignore unknown options
\DeclareOption*{\PackageWarning{csbook}{Unknown option '\CurrentOption'}}
\DeclareOption*{\relax}
\ProcessOptions\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Engine and Class Compatibility Warnings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifLuaTeX
	\typeout{csbook: LuaTeX engine detected. Proceeding with package initialization.}
\else
	\ifXeTeX
		\typeout{csbook: XeTeX engine detected. Proceeding with package initialization.}
	\else
		\typeout{csbook: ERROR: Unsupported engine detected. This package requires LuaTeX or XeTeX.}
		\PackageError{csbook}{%
			Unsupported engine detected.%
		}{%
			The csbook package requires either LuaTeX or XeTeX for proper operation.%
			Please compile your document with LuaLaTeX or XeLaTeX.%
		}
	\fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Check for supported document classes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\@ifclassloaded{book}{%
	\typeout{csbook: Detected document class: book.}
}{%
	\@ifclassloaded{extbook}{%
		\typeout{csbook: Detected document class: extbook.}
	}{%
		\@ifclassloaded{report}{%
			\typeout{csbook: Detected document class: report.}
		}{%
			\PackageError{csbook}{%
				Unsupported document class detected.
				This package is officially supported only
				for the following classes: extbook, book, or report.
				Your class (\@currclass) is not supported.%
			}{%
				Please use extbook, book, or report as your document class.%
			}
		}%
	}%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Color
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[x11names, dvipsnames, svgnames]{xcolor}      % Extended color support.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PDF and Document Structure Control
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[2.0,objcompress,compress]{bxpdfver}          % PDF version and compression management
\RequirePackage[nottoc]{tocbibind}                           % Add bibliography/lists to TOC (exclude TOC itself)
\RequirePackage{babel}                                       % Language, hyphenation
\RequirePackage{pdfpages}                                    % Include external PDFs
\RequirePackage{refcount}                                    % Reference counting

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Margin and Spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Modular Page Layout Setup
\newcommand{\csbook@setup@layout@nice}{%
	\typeout{csbook: Loading full page layout}%
	\RequirePackage[margin=3.00cm]{geometry}%
	\RequirePackage{fancyhdr}%
	\fancyhf{}%
	\fancyhead[LE,RO]{\normalfont\small\sffamily\thepage}%
	\fancyhead[LO,RE]{\normalfont\small\sffamily\@title}%
	\renewcommand{\headrulewidth}{0.25pt}%
	\pagestyle{fancy}%
}
\newcommand{\csbook@setup@layout@default}{%
	\typeout{csbook: Loading default page layout}%
	\RequirePackage[margin=2.5cm]{geometry}%
	\RequirePackage{fancyhdr}%
	\pagestyle{plain}%
}

% Modular Spacing Setup
\newcommand{\csbook@setup@spacing@nice}{%
	\RequirePackage{setspace}%
	\setstretch{1.175}%
}
\newcommand{\csbook@setup@spacing@default}{%
	\RequirePackage{setspace}%
	\setstretch{1.015}%
}

% Apply Layout and Spacing
\ifcsbook@LoadNiceLayout
	\typeout{csbook: Using nice layout}
	\csbook@setup@layout@nice
\else
	\typeout{csbook: Using default layout}
	\csbook@setup@layout@default
\fi
\ifcsbook@LoadNiceSpacing
	\typeout{csbook: Using nice spacing}
	\csbook@setup@spacing@nice
\else
	\typeout{csbook: Using default spacing}
	\csbook@setup@spacing@default
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Text, Layout, and Miscellaneous Enhancements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[autostyle=true, csdisplay=true]{csquotes}    % Automatic quotation marks and smart citations
\RequirePackage[final]{microtype}                            % Improved justification and hyphenation
\RequirePackage[full]{textcomp}                              % Additional text symbols (e.g., degree sign)
\RequirePackage[nocompress]{cite}                            % Citation package for references
\RequirePackage[normalem]{ulem}                              % Underlining and strikethrough capabilities
\RequirePackage{emptypage}                                   % No page numbers on empty pages
\RequirePackage{moresize}                                    % Extra font sizes
\RequirePackage{paralist}                                    % Compact and in-paragraph list environments
\RequirePackage{soul}                                        % For text highlighting (e.g., \hl, \ul, \st)
\RequirePackage{underscore}                                  % Allows underscores handling
\RequirePackage{xspace}                                      % Intelligent spacing after macros
\RequirePackage{xurl}                                        % Breakable URLs in text

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fonts and Math
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Font options
\SetupKeyvalOptions{%
	family=csbookfonts,
	prefix=csbookfonts@
}

% Set default fonts to Computer Modern for all families
\DeclareStringOption[cmroman]{rm}
\DeclareStringOption[cmsans]{sf}
\DeclareStringOption[cmmono]{tt}

% Load Unicode math and text font support, and core math packages
\newcommand{\csbook@loadunicodefonts}{%
	% AMS math fonts and symbols
	\RequirePackage[T1]{fontenc} % Enable T1 font encoding for better font and symbol support
	\RequirePackage{amsfonts}    % Extra math fonts
	\RequirePackage{amsmath}     % Advanced math environments and features
	\RequirePackage{amssymb}     % Additional math symbols
	\RequirePackage{mathtools}   % Math tools and enhancements to amsmath
	\RequirePackage{sansmath}    % Sans-serif font for mathematical expressions

	% Useful math and science packages
	\RequirePackage{nicefrac}    % Nice-looking fractions (e.g., ½)
	\RequirePackage{siunitx}     % SI units and number formatting
	\RequirePackage{cancel}      % Cancel lines in math expressions (strike out terms)
	\RequirePackage{empheq}      % Emphasized equations and boxed math environments
	\RequirePackage{tensor}      % Typesetting tensors with indices above and below

	% Font Setup for Unicode and OpenType
	\RequirePackage{fontspec}    % Font selection for XeTeX/LuaTeX
	\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
}

\newcommand{\csbook@loadfont@rm@cmroman}{%
	\csbook@loadunicodefonts
	\setmainfont[%
		BoldFont = NewCM10-Bold.otf,
		BoldItalicFont = NewCM10-BoldItalic.otf,
		ItalicFont = NewCM10-BookItalic.otf,
		RawFeature = {+calt,+case,+hlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		SlantedFont = NewCM10-Book.otf,
		SlantedFeatures={FakeSlant=0.25},
		SmallCapsFeatures = {RawFeature=+smcp,FakeSlant=0},
		SmallCapsFont = NewCM10-Book.otf
	]{NewCM10-Book.otf}
	\setmathfont[AutoFakeBold,Scale=MatchUppercase]{NewCMMath-Book.otf}
}
\newcommand{\csbook@loadfont@rm@garamond}{%
	\csbook@loadunicodefonts
	\setmainfont[%
		BoldFont = GaramondLibre-Bold.otf,
		BoldItalicFont = GaramondLibre-BoldItalic.otf,
		ItalicFont = GaramondLibre-Italic.otf,
		RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		SlantedFont = GaramondLibre-Regular.otf,
		SlantedFeatures={FakeSlant=0.25},
		SmallCapsFeatures={RawFeature=+smcp,FakeSlant=0},
		SmallCapsFont = EBGaramond-Medium.otf
	]{GaramondLibre-Regular.otf}
	\setmathfont[AutoFakeBold,StylisticSet={2,6,7,9},Scale=MatchUppercase]{Garamond-Math.otf}
}
\newcommand{\csbook@loadfont@rm@libertinus}{%
	\csbook@loadunicodefonts
	\setmainfont[%
		BoldFont = LibertinusSerif-Bold.otf,
		BoldItalicFont = LibertinusSerif-BoldItalic.otf,
		ItalicFont = LibertinusSerif-Italic.otf,
		RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+mark,+mkmk,+pnum,+ss06},
		SlantedFont = LibertinusSerif-Regular.otf,
		SlantedFeatures={FakeSlant=0.25},
		SmallCapsFeatures={RawFeature=+smcp,FakeSlant=0},
		SmallCapsFont = LibertinusSerif-Regular.otf
	]{LibertinusSerif-Regular.otf}
	\setmathfont[AutoFakeBold,Scale=MatchUppercase]{LibertinusMath-Regular.otf}
}
\newcommand{\csbook@loadfont@rm@concrete}{%
	\csbook@loadunicodefonts
	\RequirePackage[concrete]{fontsetup}
}
\newcommand{\csbook@loadfont@rm@oldstandard}{%
	\csbook@loadunicodefonts
	\RequirePackage[oldstandard]{fontsetup}
}

% Sans-serif (sf) font loaders
\newcommand{\csbook@loadfont@sf@cmsans}{%
	\setsansfont[%
		BoldFont = NewCMSans10-Bold.otf,
		ItalicFont = NewCMSans10-BookOblique.otf,
		BoldItalicFont = NewCMSans10-BoldOblique.otf,
		SmallCapsFont = NewCMSans10-Book.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{NewCMSans10-Book.otf}
}
\newcommand{\csbook@loadfont@sf@firasans}{%
	\setsansfont[%
		BoldFont = FiraSans-Bold.otf,
		BoldItalicFont = FiraSans-BoldItalic.otf,
		ItalicFont = FiraSans-BookItalic.otf,
		SmallCapsFont = FiraSans-Book.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{FiraSans-Book.otf}
}
\newcommand{\csbook@loadfont@sf@sourcesans}{%
	\setsansfont[%
		BoldFont = SourceSansPro-Bold.otf,
		BoldItalicFont = SourceSansPro-BoldIt.otf,
		ItalicFont = SourceSansPro-RegularIt.otf,
		SmallCapsFont = SourceSansPro-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{SourceSansPro-Regular.otf}
}
\newcommand{\csbook@loadfont@sf@biolinum}{%
	\setsansfont[%
		BoldFont = LibertinusSans-Bold.otf,
		ItalicFont = LibertinusSans-Italic.otf,
		SmallCapsFont = LibertinusSans-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{LibertinusSans-Regular.otf}
}
\newcommand{\csbook@loadfont@sf@ysabeau}{%
	\setsansfont[%
		BoldFont = Ysabeau-Bold.otf,
		BoldItalicFont = Ysabeau-BoldItalic.otf,
		ItalicFont = Ysabeau-Italic.otf,
		SmallCapsFont = Ysabeau-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{Ysabeau-Regular.otf}
}

% Monospace (tt) font loaders
\newcommand{\csbook@loadfont@tt@cmmono}{%
	\setmonofont[%
		BoldFont = NewCMMono10-Bold.otf,
		ItalicFont = NewCMMono10-BookItalic.otf,
		BoldItalicFont = NewCMMono10-BoldOblique.otf,
		SmallCapsFont = NewCMMono10-Book.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{NewCMMono10-Regular.otf}
}
\newcommand{\csbook@loadfont@tt@sourcecode}{%
	\setmonofont[%
		BoldFont = SourceCodePro-Bold.otf,
		ItalicFont = SourceCodePro-RegularIt.otf,
		BoldItalicFont = SourceCodePro-BoldIt.otf,
		SmallCapsFont = SourceCodePro-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{SourceCodePro-Regular.otf}
}
\newcommand{\csbook@loadfont@tt@anonymouspro}{%
	\setmonofont[%
		BoldFont = AnonymousPro-Bold.ttf,
		ItalicFont = AnonymousPro-Italic.ttf,
		BoldItalicFont = AnonymousPro-BoldItalic.ttf,
		SmallCapsFont = AnonymousPro-Regular.ttf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{AnonymousPro-Regular.ttf}
}
\newcommand{\csbook@loadfont@tt@cascadiamono}{%
	\setmonofont[%
		BoldFont = CascadiaCode-Bold.otf,
		BoldItalicFont = CascadiaCode-BoldItalic.otf,
		ItalicFont = CascadiaCode-Italic.otf,
		SmallCapsFont = CascadiaCode-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{CascadiaCode-Regular.otf}
}
\newcommand{\csbook@loadfont@tt@firamono}{%
	\setmonofont[%
		BoldFont = FiraMono-Bold.otf,
		ItalicFont = FiraMono-Oblique.otf,
		BoldItalicFont = FiraMono-BoldOblique.otf,
		SmallCapsFont = FiraMono-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{FiraMono-Regular.otf}
}
\newcommand{\csbook@loadfont@tt@inconsolata}{%
	\setmonofont[%
		SmallCapsFont = Inconsolatazi4-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{Inconsolatazi4-Regular.otf}
}
\newcommand{\csbook@loadfont@tt@notosansmono}{%
	\ifXeTeX
		\PackageWarning{csbook}{The 'notosansmono' font is not supported with XeTeX. Falling back to default 'cmmono'.}%
		\csbook@loadfont@tt@cmmono
	\else
		\setmonofont[%
			UprightFont = NotoSansMono-Regular.ttf,
			BoldFont = NotoSansMono-Bold.ttf,
			ItalicFont = NotoSansMono-Regular.ttf,
			BoldItalicFont = NotoSansMono-Bold.ttf,
			SmallCapsFont = NotoSansMono-Regular.ttf,
			SmallCapsFeatures = {RawFeature=+smcp},
			RawFeature = {+calt,+case,+dlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
			Scale=MatchLowercase
		]{NotoSansMono}
	\fi
}

% Modular error handling for unknown font choices
\newcommand{\csbook@font@validchoices}[1]{%
	\ifstrequal{#1}{rm}{cmroman, garamond, libertinus, concrete, oldstandard}{}%
	\ifstrequal{#1}{sf}{cmsans, firasans, sourcesans, biolinum, ysabeau}{}%
	\ifstrequal{#1}{tt}{cmmono, sourcecode, anonymouspro, cascadiamono, firamono, inconsolata, notosansmono}{}%
}

\newcommand{\csbook@font@error}[2]{%
	\PackageError{csbook}{Unknown #1 font family: '#2'}%
	{Valid choices for #1 are:\MessageBreak
		\csbook@font@validchoices{#1}%
	}%
}

% Load a font family by name, with fallback and error reporting.
\newcommand{\csbook@load@fontfamily}[3]{%
	% #1: family type (rm, sf, tt)
	% #2: requested font name
	% #3: fallback font name
	\@ifundefined{csbook@loadfont@#1@#2}{%
		\PackageWarning{csbook}{Unknown #1 font family: '#2'. Falling back to '#3'.}%
		\@ifundefined{csbook@loadfont@#1@#3}{%
			\PackageError{csbook}{Unknown #1 font family: '#2' and fallback '#3'.}{%
				Valid choices for #1 are:\MessageBreak
				\csbook@font@validchoices{#1}%
			}%
		}{%
			\csname csbook@loadfont@#1@#3\endcsname
		}%
	}{%
		\csname csbook@loadfont@#1@#2\endcsname
	}%
}

% Always sets defaults, then applies user overrides, then loads each font family.
\newcommand{\csbookfonts}[1]{%
	% Set default font families
	\def\csbookfonts@rm{cmroman}%
	\def\csbookfonts@sf{cmsans}%
	\def\csbookfonts@tt{cmmono}%
	% Apply user-specified font choices (if any)
	\setkeys{csbookfonts}{#1}%
	% Load each font family, using fallback if necessary
	\csbook@load@fontfamily{rm}{\csbookfonts@rm}{cmroman}%
	\csbook@load@fontfamily{sf}{\csbookfonts@sf}{cmsans}%
	\csbook@load@fontfamily{tt}{\csbookfonts@tt}{cmmono}%
}

% Set Default Font Style
\ifcsbook@LoadDefaultFont
	\AtEndPreamble{%
		\csbookfonts{rm=cmroman,sf=cmsans,tt=cmmono}%
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hyperlinks & Referencing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadHyperref
	\RequirePackage{nameref}                                     % Name-based referencing
	\RequirePackage[%
		bookmarksnumbered=true,                                  % Number PDF bookmarks
		breaklinks=true,                                         % Allow links to break over lines
		citecolor=DodgerBlue3,                                   % Color for citations
		colorlinks=true,                                         % Use colored links
		frenchlinks=true,                                        % Use small caps for links
		linkcolor=RoyalBlue3,                                    % Color for internal links
		pagebackref,                                             % Back-references from bibliography
		pdfencoding=auto,                                        % Automatic encoding detection
		pdfpagelabels=true,                                      % Correct page labels in PDF
		pdfpagelayout=SinglePage,                                % Single page view
		pdfstartview=FitH,                                       % Fit the page to the window
		pdfusetitle,                                             % Use document title as PDF title
		unicode=true,                                            % Support for Unicode
		urlcolor=Turquoise4                                      % Color for URLs
	]{hyperref}
	\RequirePackage{bookmark}									 % Bookmarking and referencing
	\AtBeginDocument{%
		\RequirePackage[capitalize,nameinlink,noabbrev]{cleveref} % Clever references
		% Sectioning names for cleveref
		\crefname{section}{\textsection}{\textsection\textsection}
		\Crefname{section}{\textsection}{\textsection\textsection}
		\crefname{subsection}{\textsection}{\textsection\textsection}
		\Crefname{subsection}{\textsection}{\textsection\textsection}
		\crefname{subsubsection}{\textsection}{\textsection\textsection}
		\Crefname{subsubsection}{\textsection}{\textsection\textsection}
	}
	\RequirePackage{xr}                                        	 % Cross-document references
	% Customize backrefs
	\renewcommand*{\backref}[1]{}
	\renewcommand*{\backrefalt}[4]{%
		\ifcase #1\or (Cited on p.~#2).%
		\else (Cited on pp.~#2).%
		\fi
	}
	% Full reference combining hyperref, autoref, and nameref.
	\newcommand*{\fullref}[1]{\hyperref[{#1}]{\autoref*{#1}~\nameref*{#1}}}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Figures and Tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{adjustbox}                                     % Graphic/table boxes: scaling, trimming, framing
\RequirePackage{array}                                         % Custom column types and alignment
\RequirePackage{booktabs}                                      % High-quality horizontal rules for tables
\RequirePackage{caption}                                       % Custom caption formatting
\RequirePackage{colortbl}                                      % Cell background coloring in tables
\RequirePackage{dashbox}                                       % Dashed framed boxes
\RequirePackage{diagbox}                                       % Diagonal split table headers
\RequirePackage{fancybox}                                      % Simple framed boxes
\RequirePackage{float}                                         % Precise float positioning
\RequirePackage{framed}                                        % Framed environments (e.g., figures, text)
\RequirePackage{graphicx}                                      % Image inclusion and scaling
\RequirePackage{hhline}                                        % Horizontal lines in tables
\RequirePackage{longtable}                                     % Multi-page tables
\RequirePackage{makecell}                                      % Line breaks and formatting in cells
\RequirePackage{multicol}                                      % Multiple text columns
\RequirePackage{multirow}                                      % Multi-row cells in tables
\RequirePackage{pdflscape}                                     % Landscape pages in PDF output
\RequirePackage{placeins}                                      % Float placement control (e.g., \FloatBarrier)
\RequirePackage{ragged2e}                                      % Improved text justification
\RequirePackage{rotating}                                      % Rotated figures and tables
\RequirePackage{subcaption}                                    % Subfigures and subtables with captions
\RequirePackage{tabularray}                                    % Advanced table types and styling
\RequirePackage{tabularx}                                      % Tables with auto-stretching columns
\RequirePackage{threeparttable}                                % Notes and footnotes in tables
\RequirePackage{verbatim}                                      % Verbatim environment
\RequirePackage{wrapfig}                                       % Text wrapping around figures/tables
\RequirePackage{xhfill}                                        % Horizontal line
\RequirePackage{xtab}                                          % Page-breaking tables (alt to supertabular)
\AtBeginDocument{%
	\captionsetup{%
		font={rm,small},                                       % Roman font
		labelfont={color=black,sc,small},                      % Label in black roman
		labelsep=period,                                       % Label ends with period
		skip=5pt,                                              % Space below caption
		justification=justified                                % Center the caption
	}%
}%
\captionsetup[table]{position=bottom, skip=5pt}                % Table captions below
\captionsetup[figure]{position=bottom, skip=5pt}               % Figure captions below

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Adjust Table of Contents spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[titles]{tocloft}                               % TOC title formatting

% Define table-of-content spacing
\NewDocumentCommand{\adjusttocformat}{}{%
	\addtolength{\cftchapnumwidth}{5pt}%
	\addtolength{\cftsecnumwidth}{3.5pt}%
	\addtolength{\cftsubsecnumwidth}{3.5pt}%
	\addtolength{\cftsubsubsecnumwidth}{3.5pt}%
	\addtolength{\cftsecindent}{5pt}%
	\addtolength{\cftsubsecindent}{8.5pt}%
	\addtolength{\cftsubsubsecindent}{12pt}%
	% Customize TOC font styles
	\renewcommand{\cftpartfont}{\Large\sffamily}
	\renewcommand{\cftchapfont}{\large\bfseries}
	\renewcommand{\cftsecfont}{\normalsize\scshape}
	\renewcommand{\cftsubsecfont}{\normalsize}
	\renewcommand{\cftsubsubsecfont}{\normalsize}
	% Set numbering and TOC depth
	\setcounter{secnumdepth}{4}
	\setcounter{tocdepth}{2}
}

\ifcsbook@LoadAdjustToC
	\adjusttocformat
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Header-level formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[compact]{titlesec}                               % Header title formatting

% Define section-specific heading fonts and sizes
\NewDocumentCommand{\partheadingfont}{}{\normalfont\bfseries\huge}
\NewDocumentCommand{\chapterheadingfont}{}{\normalfont\bfseries\LARGE}
\NewDocumentCommand{\sectionheadingfont}{}{\normalfont\bfseries\Large}
\NewDocumentCommand{\subsectionheadingfont}{}{\normalfont\bfseries\large}
\NewDocumentCommand{\subsubsectionheadingfont}{}{\normalfont\bfseries\normalsize}
\NewDocumentCommand{\paragraphheadingfont}{}{\normalfont\bfseries\normalsize}
\NewDocumentCommand{\subparagraphheadingfont}{}{\normalfont\scshape\normalsize}

\ifcsbook@LoadOldSection
	% Ancient Section, subsection, etc. formatting rules
	\NewDocumentCommand{\setsectionformats}{}{%
		\titleformat{\section}
		{\sectionheadingfont}
		{\textsection\thesection}
		{10pt}
		{}%
		\titleformat{\subsection}
		{\subsectionheadingfont}
		{\textsection\textsection\thesubsection}
		{10pt}
		{}%
		\titleformat{\subsubsection}[runin]
		{\subsubsectionheadingfont}
		{\textsection\textsection\textsection\thesubsubsection}
		{10pt}
		{}%
		\titleformat{\paragraph}[runin]
		{\paragraphheadingfont}
		{\theparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
		\titleformat{\subparagraph}[runin]
		{\subparagraphheadingfont}
		{\thesubparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
	}
\else
	% Section, subsection, etc. formatting rules
	\NewDocumentCommand{\setsectionformats}{}{%
		\titleformat{\section}
		{\sectionheadingfont}
		{\thesection}
		{10pt}
		{}%
		\titleformat{\subsection}
		{\subsectionheadingfont}
		{\thesubsection}
		{10pt}
		{}%
		\titleformat{\subsubsection}[runin]
		{\subsubsectionheadingfont}
		{\thesubsubsection}
		{10pt}
		{}%
		\titleformat{\paragraph}[runin]
		{\paragraphheadingfont}
		{\theparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
		\titleformat{\subparagraph}[runin]
		{\subparagraphheadingfont}
		{\thesubparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
	}
\fi

% Chapter-level title formatting (with embedded size and style)
\NewDocumentCommand{\setchapterformat}{}{%
	\titleformat{\chapter}[display]
	{\chapterheadingfont}
	{\filleft\textnormal{\textsc{\large\chaptertitlename}~\Huge\textsf{\thechapter}}}
	{2ex}
	{\titlerule\vspace{1ex}\filright}
	[\vspace{1ex}\titlerule]%
}

% Part-level title formatting (with embedded size and style)
\NewDocumentCommand{\setpartformat}{}{%
\titleformat{\part}[display]
{\partheadingfont}
{\scshape\partname~{\Huge\thepart}}
{1ex}
{\scshape\titlerule\vspace{1ex}\Huge}
[\vspace{1ex}\titlerule]%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% List Customization
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{enumitem}                                      % Precise control over list environments

% Global list spacing
\setlist{nosep}                                                % Suppress vertical spacing between items

% Enumerate: Custom labels by nesting level
\setlist[enumerate,1]{label=(\arabic*)}                        % Level 1: (1), (2), ...
\setlist[enumerate,2]{label=(\alph*)}                          % Level 2: (a), (b), ...
\setlist[enumerate,3]{label=(\Roman*)}                         % Level 3: (I), (II), ...

% Itemize: Custom symbols by nesting level
\setlist[itemize,1]{label=\textbullet}                		   % Level 1: bullet
\setlist[itemize,2]{label=\textendash}           			   % Level 2: en dash
\setlist[itemize,3]{label=\textasteriskcentered}               % Level 3: open circle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Verbatim and Code Environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadVerbatim
	\RequirePackage{verbatim}   % Basic verbatim environment
	\RequirePackage{fancyvrb}   % Enhanced verbatim features

	% Patch: Only print non-empty lines in verbatim
	\newcommand{\savedverbatim@processline}{}
	\let\savedverbatim@processline=\verbatim@processline
	\renewcommand{\verbatim@processline}{%
		\let\verbatim@processline=\savedverbatim@processline
		\if\relax\the\verbatim@line\relax
		\else
			\the\verbatim@line\par
		\fi
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Modern Boxes 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadNiceBoxs
	\RequirePackage[most]{tcolorbox}                              % Colored and styled boxes
	\RequirePackage[%
		skipabove=1em,                                            % Vertical space above the frame
		skipbelow=1em,                                            % Vertical space below the frame
		ntheorem,                                                 % Compatibility with theorem environments
		framemethod=Tikz                                          % Use TikZ for frame rendering
	]{mdframed}                                                   % Framed environments with theorem support
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TikZ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadTikZ
	\typeout{csbook: Loading TikZ package}
	\RequirePackage{pgfplots}                                     % Function/data plots
	\pgfplotsset{compat=1.18}                                     % PGFPlots compatibility version
	\RequirePackage{tikz}                                         % Core TikZ package
	\RequirePackage{tikz-cd}                                      % Commutative diagrams
	\RequirePackage{tikz-3dplot}                                  % 3D coordinate plotting
	% TikZ libraries for enhanced diagrammatic capability
	\usetikzlibrary{%
		3d,
		arrows,
		arrows.meta,
		automata,
		babel,
		backgrounds,
		bending,
		calc,
		calendar,
		chains,
		circuits.ee.IEC,
		circuits.logic.IEC,
		datavisualization,
		datavisualization.formats.functions,
		decorations,
		decorations.markings,
		decorations.pathmorphing,
		decorations.shapes,
		decorations.text,
		er,
		external,
		fadings,
		fit,
		graphs,
		graphs.standard,
		hobby,
		intersections,
		lindenmayersystems,
		matrix,
		mindmap,
		patterns,
		patterns.meta,
		petri,
		plothandlers,
		plotmarks,
		positioning,
		quantikz2,
		quotes,
		scopes,
		shadows,
		shapes,
		shapes.arrows,
		shapes.callouts,
		shapes.geometric,
		shapes.misc,
		shapes.multipart,
		shapes.symbols,
		spy,
		svg.path,
		through,
		tikzmark,
		trees
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendices
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadAppendix
	\typeout{csbook: Loading appendix package}
	\RequirePackage[page, title, header, titletoc, toc]{appendix} % For handling appendices
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Theorems
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadTheorem
	\typeout{csbook: Loading theorem package}
	\IfFileExists{csthm.sty}{%
		\RequirePackage[oldschool]{csthm}
		\typeout{csbook: Loaded csthm package with oldschool option}
	}{%
		\PackageWarning{csbook}{Package `csthm` not found. Theorem formatting will use defaults.}
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Epigraphs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadEpigraph
	\RequirePackage{epigraph} % Load epigraph package for introductory quotations

	% Epigraph appearance configuration
	\setlength{\epigraphrule}{0.5pt}         	% Thickness of the epigraph rule
	\setlength{\epigraphwidth}{0.65\textwidth} 	% Width of the epigraph block
	\renewcommand{\textflush}{flushright}      	% Align epigraph text to the right
	\renewcommand{\epigraphsize}{\small}       	% Set epigraph font size

	% Enhanced epigraph command using xparse
	\let\oldepigraph\epigraph
	\RenewDocumentCommand{\epigraph}{mm}{%
		\oldepigraph{\textsf{#1}}{\smallskip\textsc{#2}}%
	}

	% Simple dedication environment
	\NewDocumentEnvironment{dedication}{O{}}{%
		\cleardoublepage
		\thispagestyle{empty}
		\vspace*{\fill}
		\begin{flushright}
			\begin{itshape}
				}{%
			\end{itshape}
			\IfNoValueF{#1}{\par\medskip\textsf{#1}}
		\end{flushright}
		\vspace*{\fill}
		\cleardoublepage
	}

	% Generate Dedications: Produces a page of dedications with multiple epigraphs
	\NewDocumentCommand{\generateDedications}{m}{%
		\cleardoublepage
		\thispagestyle{empty}
		\begin{center}
			\vspace*{\fill}
			\large
			\begin{minipage}{0.9\textwidth}
				#1
			\end{minipage}
			\vspace*{\fill}
		\end{center}
		\clearpage
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Index Support
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadIndices
	\RequirePackage[makeindex]{imakeidx}
	\IfFileExists{csindex.ist}{%
		\typeout{csbook: Using custom index style file 'csindex.ist' for the index.}
		\makeindex[intoc, title={Index}, columns=2, options={-s csindex.ist}]
	}{%
		\typeout{csbook: No custom index style file 'csindex.ist' found. Using default index style.}
		\makeindex[intoc, title={Index}, columns=3]
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Glossaries and Acronyms
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadGlossaries
	\RequirePackage[%
		automake,           	% Auto-generate glossary files
		acronym,            	% Enable acronyms
		symbols,            	% Enable symbols list
		nonumberlist,       	% No numbering for entries
		nogroupskip,        	% No extra space between groups
		indexonlyfirst,     	% Only first occurrence indexed
		stylemods=longextra,	% Use long extra style
		nopostdot,          	% No period after entries
		toc                 	% Add to Table of Contents
	]{glossaries-extra}
	\makeglossaries
	\setabbreviationstyle[acronym]{long-short}
	\renewcommand*{\glsnamefont}[1]{\sffamily\small#1.}
	\renewcommand*{\glossarypreamble}{\begingroup\small}
	\renewcommand*{\glossarypostamble}{\endgroup}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Page Style Customizations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Save originals
\let\csbook@orig@frontmatter\frontmatter
\let\csbook@orig@mainmatter\mainmatter
\let\csbook@orig@backmatter\backmatter
\let\csbook@orig@tableofcontents\tableofcontents

% Redefine frontmatter: plain page style
\RenewDocumentCommand{\frontmatter}{}{%
	\csbook@orig@frontmatter%
	\pagestyle{plain}%
}

% Redefine mainmatter: fancy page style, chapters on right
\RenewDocumentCommand{\mainmatter}{}{%
	\csbook@orig@mainmatter%
	\@openrighttrue%
	\pagestyle{fancy}%
}

% Redefine backmatter: plain page style, sections on right, bookmarks at root
\RenewDocumentCommand{\backmatter}{}{%
	\csbook@orig@backmatter%
	\@openrighttrue%
	\bookmarksetup{startatroot}%
	\pagestyle{plain}%
}

% Redefine tableofcontents: page break after, fancy style
\RenewDocumentCommand{\tableofcontents}{}{%
	\csbook@orig@tableofcontents%
	\cleardoublepage%
	\pagestyle{fancy}%
}

% Header and section formatting setup
\AtBeginDocument{%
	\setpartformat
	\setchapterformat
	\setsectionformats
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Extra Environments and Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadUsefulCommands
	\AtEndPreamble{%
		% List Environments (require enumitem)
		\@ifpackageloaded{enumitem}{%
			% Points list: itemize with en-dash
			\newlist{points}{itemize}{1}
			\setlist[points]{%
				label={--},
				leftmargin=1em,
				itemsep=1pt,
				align=left,
				before=\smallskip,
				after=\smallskip
			}
			% Codelist: enumerate as [1], [2], ...
			\newlist{codelist}{enumerate}{1}
			\setlist[codelist,1]{%
				label=\textcolor{gray}{\texttt{[\arabic*]}},
				leftmargin=1em,
				itemsep=1pt,
				align=left,
				before=\smallskip,
				after=\smallskip
			}
			% Checkbox list: itemize with empty box
			\newlist{checkbox}{itemize}{1}
			\setlist[checkbox]{%
				label={--},
				leftmargin=1em,
				align=left
			}
			% Checked and unchecked items for checkbox list
			\newcommand{\taskitem}{\item[$\square$]}
			\newcommand{\checkeditem}{\item[$\color{SpringGreen3}\boxtimes$]}
			\newcommand{\uncheckeditem}{\item[$\color{IndianRed1}\vectimes$]}
			% Definition list: description with bold labels
			\newlist{deflist}{description}{1}
			\setlist[deflist]{%
				labelwidth=0.35\textwidth,
				labelsep=1em,
				leftmargin=0.35\textwidth,
				font=\normalfont\bfseries,
				style=nextline,
				itemsep=5pt
			}
			% Chapter notes environment
			\NewDocumentEnvironment{chapternotes}{}{%
				\section*{Chapter Notes and History}%
				\addcontentsline{toc}{section}{\protect{\textsc{Chapter Notes and History}}}%
			}{}
			% Problem set environment (auto-labels, two levels)
			\NewDocumentEnvironment{problemset}{}{%
				\section*{Problem Set}%
				\addcontentsline{toc}{section}{\protect{\textsc{Problem Set}}}%
				\setlist[enumerate,1]{label={$\textrm{(\thechapter.\arabic*)}~$}, left=0pt}%
				\setlist[enumerate,2]{label=(\arabic*), left=1em}%
				\begin{enumerate}%
					}{%
				\end{enumerate}%
			}
			% Choices environment: two-column, (a), (b), ...
			\NewDocumentEnvironment{choices}{}{%
				\begin{multicols}{2}%
					\begin{enumerate}[label={$\texttt{\small(\alph*)}$}]%
						}{%
					\end{enumerate}%
				\end{multicols}%
			}
			% Hard problem item: star and colored label
			\NewDocumentCommand{\hardproblem}{}{%
				\item[\textrm{(\ensuremath{\color{Brown1}\star}\,\thechapter.\number\numexpr\value{enumi}+1\relax)}]%
				\stepcounter{enumi}%
			}

		}{}
		% Highlight color (default: RoyalBlue)
		\newcommand{\highlightcolor}{RoyalBlue}
		\newcommand{\sethighlightcolor}[1]{\renewcommand{\highlightcolor}{#1}}
		% Highlighted math and text
		\newcommand{\emphmath}[1]{\textcolor{\highlightcolor}{\mathrm{#1}}}
		\newcommand{\emphtext}[1]{\textcolor{\highlightcolor}{#1}}
		\newcommand{\textem}[1]{\textcolor{\highlightcolor}{#1}}
		% Bold italic text
		\newcommand{\textbi}[1]{\textbf{\textit{#1}}}
		% Code font
		\newcommand{\code}[1]{\texttt{#1}}
		% Math small caps and bold italic
		\newcommand{\mathsc}[1]{\textnormal{\textsc{#1}}}
		\newcommand{\mathbi}[1]{\textnormal{\textbf{\textit{#1}}}}
		% Inline math shortcut
		\newcommand{\inmath}[1]{\ensuremath{#1}}
		% Hyphen in math mode
		\mathchardef\mathhyphen="2D
		% Quotation marks
		\newcommand{\putInQuotes}[1]{``#1''}
		% Missing Content Reporting
		\newcounter{missingctr}
		% List of all missing items (initialize as empty)
		\newcommand{\missinglist}{}
		% Mark missing content and collect for report
		\newcommand{\missing}[1]{%
			\refstepcounter{missingctr}%
			\label{missing:\themissingctr}%
			\gappto\missinglist{%
				\noindent\textcolor{Brown4}{%
					\ensuremath{\star}~\themissingctr~(\textsf{Missing at p.~\pageref{missing:\themissingctr}}):~#1%
				}\par\medskip
			}%
			\textcolor{Brown4}{#1}%
		}
		% Print all missing items with page references
		\newcommand{\printmissing}{%
			\section*{Missing Content Report}%
			\missinglist
		}
		% Mark missing citation (for future expansion)
		% Debug: #1 was used but not defined; remove #1 and just print <Citation Missing>
		\newcommand{\missingcitation}{%
			\refstepcounter{missingctr}%
			\label{missing:\themissingctr}%
			\gappto\missinglist{%
				\noindent\textcolor{Brown4}{%
					\ensuremath{\star}~\themissingctr~(\textsf{Missing at p.~\pageref{missing:\themissingctr}}):~\texttt{<Citation Missing>}%
				}\par\medskip
			}%
			\textcolor{Brown4}{\texttt{<Citation Missing>}}%
		}
		% Boxed Environments (mdframed/tcolorbox)
		\@ifpackageloaded{mdframed}{%
			% Protocol box: points list in a box, optional title
			\NewDocumentEnvironment{protocolbox}{o}{%
				\begin{mdframed}[
						font=\small,
						roundcorner=1.5pt,
						linewidth=0.5pt,
						skipabove=0.5\baselineskip,
						skipbelow=0.1\baselineskip,
						leftmargin=0pt,
						rightmargin=0pt,
						innerleftmargin=5pt,
						innerrightmargin=5pt,
						innertopmargin=5pt,
						innerbottommargin=5pt,
						backgroundcolor=white,
						linecolor=black
					]%
					\IfNoValueF{#1}{%
						\noindent\textnormal{\small\textbf{#1}}\par\smallskip
						\noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
					}%
					\begin{points}%
						}{%
					\end{points}
				\end{mdframed}%
			}
			% Codelist box: codelist in a box, optional title
			\NewDocumentEnvironment{codelistbox}{o}{%
				\begin{mdframed}[
						font=\small,
						roundcorner=1.5pt,
						linewidth=0.5pt,
						skipabove=0.5\baselineskip,
						skipbelow=0.1\baselineskip,
						leftmargin=0pt,
						rightmargin=0pt,
						innerleftmargin=5pt,
						innerrightmargin=5pt,
						innertopmargin=5pt,
						innerbottommargin=5pt,
						backgroundcolor=white,
						linecolor=black
					]%
					\IfNoValueF{#1}{%
						\noindent\textnormal{\small\textbf{#1}}\par\smallskip
						\noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
					}%
					\begin{codelist}%
						}{%
					\end{codelist}
				\end{mdframed}%
			}
			% Simple box: plain box, optional title
			\NewDocumentEnvironment{simplebox}{o}{%
				\begin{mdframed}[
						font=\small,
						roundcorner=1.5pt,
						linewidth=0.5pt,
						skipabove=0.5\baselineskip,
						skipbelow=0.1\baselineskip,
						leftmargin=0pt,
						rightmargin=0pt,
						innerleftmargin=5pt,
						innerrightmargin=5pt,
						innertopmargin=5pt,
						innerbottommargin=5pt,
						backgroundcolor=white,
						linecolor=black
					]%
					\IfNoValueF{#1}{%
						\noindent\textnormal{\small\textbf{#1}}\par\smallskip
						\noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
					}%
					}{%
				\end{mdframed}%
			}
			% Learned box: "What Have We Learned?" title
			\NewDocumentEnvironment{learnedbox}{}{%
				\begin{mdframed}[frametitle={\normalfont\sffamily\large What Have We Learned?\medskip\hrule}]
					}{%
				\end{mdframed}
			}
			% Case study box: simple black frame
			\NewDocumentEnvironment{casestudy}{}{%
				\begin{mdframed}[linewidth=1pt,linecolor=black,backgroundcolor=none]%
					}{%
				\end{mdframed}%
			}

		}{}
		\@ifpackageloaded{tcolorbox}{%
			% Simple Wire box: simple tcolorbox, etc.
			\newtcolorbox{wirebox}{%
				colframe=black,
				colback=white,
				sharp corners,
				boxrule=0.5pt,
				coltitle=black,
				colbacktitle=white,
				boxsep=5pt,
				top=0pt,
				bottom=0pt,
				left=5pt,
				right=5pt
			}
			% Modern, clean definition for paired numbered/unnumbered color boxes
			\NewDocumentCommand{\newcolorboxes}{mmm}{%
				% Create a counter for the numbered environment
				\newcounter{#1ctr}
				% Numbered environment
				\newtcolorbox[#2]{#1}{O{}}{%
					enhanced,
					breakable,
					colback=#3!5,
					colframe=#3!80!black,
					arc=1pt,
					boxrule=0.5pt,
					fonttitle=\color{black}\sffamily,
					before upper={\parindent0pt},
					before lower={\parindent0pt},
					fontupper=\color{black}\normalfont,
					fontlower=\color{black}\normalfont,
					right=15pt, top=15pt, bottom=15pt,
					attach boxed title to top left={yshift=-5pt,xshift=10pt},
					boxed title style={
							colback=#3!5,
							colframe=#3!50!black,
							arc=1pt,
							boxrule=0.5pt
						},
					title={%
							\refstepcounter{#1ctr}#2~\thesection.\arabic{#1ctr}%
							\IfValueT{##1}{: ##1}%
						}
				}
				% Unnumbered environment
				\newtcolorbox[#2]{#1*}{O{}}{%
					enhanced,
					breakable,
					colback=#3!5,
					colframe=#3!80!black,
					arc=1pt,
					boxrule=0.5pt,
					fonttitle=\color{black}\sffamily,
					before upper={\parindent0pt},
					before lower={\parindent0pt},
					fontupper=\color{black}\normalfont,
					fontlower=\color{black}\normalfont,
					right=15pt, top=15pt, bottom=15pt,
					attach boxed title to top left={yshift=-5pt,xshift=10pt},
					boxed title style={
							colback=#3!5,
							colframe=#3!50!black,
							arc=1pt,
							boxrule=0.5pt
						},
					title={%
							#2%
							\IfValueT{##1}{: ##1}%
						}
				}
			}
		}{}
		% Exercises Environment
		\NewDocumentEnvironment{exercises}{}{%
			\vfill\cleardoublepage%
			\begin{small}%
				\section*{Exercises}%
				\addcontentsline{toc}{section}{\textsc{Exercises}}%
				}{%
			\end{small}%
		}
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Comments, Acknowledgment, Abstract
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\AtBeginDocument{%
	% Comment macro: \newcomment{name}{color}{command}
	\NewDocumentCommand{\newcomment}{mmm}{%
		\expandafter\NewDocumentCommand\csname#3\endcsname{m}{%
			\noindent\textcolor{#2}{\sffamily##1 -- $\mathsf{#1}$}%
		}%
	}
	% Acknowledgment
	\AtBeginDocument{%
		\NewDocumentEnvironment{acknowledgment}{o}{%
			\IfNoValueTF{#1}{\chapter*{Acknowledgment.}}{\chapter*{#1}}%
		}%
	}
	% Abstract
	\NewDocumentEnvironment{abstract}{}{%
		\begin{quotation}
			\begin{small}
				{\noindent\paragraphheadingfont{Abstract.\ }}%
				\addcontentsline{toc}{section}{\protect{\textsc{Abstract}}}%
				}{%
			\end{small}
		\end{quotation}
	}
	% Table of Contents
	\NewDocumentCommand{\toc}{}{%
		\vfill
		\clearpage
		\begin{spacing}{1.00}
			\tableofcontents
		\end{spacing}
		\vfill
		\clearpage
	}
	% Bibliography 
	\NewDocumentCommand{\printbib}{O{alphaurl} m}{%
		\vfill
		\clearpage
		\begin{spacing}{1.00}
			\bibliographystyle{#1}
			\bibliography{#2}
		\end{spacing}
		\vfill
		\clearpage
	}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title Page Customisation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{hep-title} % Title and Author Management

% Before main title
\NewDocumentCommand{\csbook@pretitle}{}{
	\begin{center}
		\hrule width \textwidth height 1pt\par
		\vspace{2em}
		\normalfont\bfseries\LARGE
		\begingroup
		}
		\NewDocumentCommand{\csbook@posttitle}{}{
		\endgroup
		\vspace{1em}
		\hrule width \textwidth height 1pt
	\end{center}
	\vspace{1em}
}
% Subtitle
\NewDocumentCommand{\csbook@presubtitle}{}{
	\begin{center}
		\normalfont\large\itshape
		}
		\NewDocumentCommand{\csbook@postsubtitle}{}{
		\par\vspace{1.5em}
	\end{center}
}
% Author
\NewDocumentCommand{\csbook@preauthor}{}{
	\begin{center}
		\normalfont\scshape\large
		}
		\NewDocumentCommand{\csbook@postauthor}{}{
		\par\vspace{2em}
	\end{center}
}
% Date
\NewDocumentCommand{\csbook@predate}{}{
	\begin{center}
		\normalfont\small
		}
		\NewDocumentCommand{\csbook@postdate}{}{
		\par\vspace*{2em}
	\end{center}
}
% Modular maketitle customisation using xsparse
\NewDocumentCommand{\csbook@fancymaketitle}{}{
	\pretitle{\csbook@pretitle}
	\posttitle{\csbook@posttitle}
	\presubtitle{\csbook@presubtitle}
	\postsubtitle{\csbook@postsubtitle}
	\preauthor{\csbook@preauthor}
	\postauthor{\csbook@postauthor}
	\predate{\csbook@predate}
	\postdate{\csbook@postdate}
}

% Apply custom title formatting at the end of the preamble
\AtEndPreamble{\csbook@fancymaketitle}

% Modular Title Page Command
\NewDocumentCommand{\printtitlepage}{O{\@title} O{\@author} O{\@date} O{}}{%
	\cleardoublepage
	\begingroup
	\thispagestyle{empty}
	\vspace*{\fill}
	\LARGE\sffamily
	\begin{flushright}
		\hrule width \textwidth height 1pt\par
		\vspace{1em}
		#1\par
		\IfNoValueF{#4}{\par\vspace{0.5em}{\large\itshape #4}\par}
		\vspace{1em}
		\hrule width \textwidth height 1pt
	\end{flushright}
	\vspace*{\fill}
	\endgroup
	\clearpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Paragraph formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Flag for punctuation detection
\newif\ifcsbook@haspunctuation

% Check whether the second argument is empty (used for punctuation detection)
\def\csbook@checkpunctuation#1{%
	\ifx\csbook@checkpunctuation#1\csbook@checkpunctuation
	\else
		\csbook@haspunctuationtrue
	\fi
}

% Specific punctuation testers for '.', '?', '!', ':'
\def\csbook@checkdot#1.\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}
\def\csbook@checkquestion#1?\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}
\def\csbook@checkexclam#1!\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}
\def\csbook@checkcolon#1:\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}

% Main interface: Append period unless line ends with '.', '?', '!', or ':'
\def\csbook@appendpunctuationifneeded#1{%
	\csbook@haspunctuationfalse
	\csbook@checkdot#1\csbook@delim.\csbook@delim\csbook@stop
	\csbook@checkquestion#1\csbook@delim?\csbook@delim\csbook@stop
	\csbook@checkexclam#1\csbook@delim!\csbook@delim\csbook@stop
	\csbook@checkcolon#1\csbook@delim:\csbook@delim\csbook@stop
	#1\ifcsbook@haspunctuation \else.\fi%
}

% Skip spaces and implicit paragraphs (blank lines)
\def\csbook@ignorewhitespaceandimplicitpars{%
	\begingroup
	\catcode13=10 %
	\@ifnextchar\relax
	{\endgroup}
	{\endgroup}%
}

% Skip spaces, implicit paragraphs, and explicit \par commands
\def\csbook@ignoreallpars{%
	\begingroup
	\catcode13=10 %
	\@ifnextchar\par
	{\endgroup\expandafter\csbook@ignoreallpars\@gobble}
	{\endgroup}%
}

% Section-style paragraph header with automatic punctuation and spacing
\NewDocumentCommand{\csbook@paragraphhead}{m}{%
	\smallskip
	\noindent
	\textbf{\boldmath\ignorespaces\csbook@appendpunctuationifneeded{#1}}%
	\hskip 0.9em plus 0.3em minus 0.3em
	\csbook@ignorewhitespaceandimplicitpars
}

\NewDocumentCommand{\parhead}{m}{\csbook@paragraphhead{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Nested bar environment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\long\def\csbook@customfbox#1#2#3#4#5#6#7#8#9{%
	\leavevmode
	\begingroup
	\setbox\@tempboxa\hbox{%
		\color@begingroup
		\kern\fboxsep{#9}\kern\fboxsep
		\color@endgroup}%
	\hbox{%
		\begingroup
		\@tempdima#4\relax
		\advance\@tempdima\fboxsep
		\advance\@tempdima\dp\@tempboxa
		\expandafter\endgroup
		\expandafter\lower\the\@tempdima\hbox{%
			\vbox{%
				\hrule \@height#3 \@width#7
				#1%
				\hbox{%
					\vrule \@width#5
					\hspace{#8}%
					\vbox{%
						\vskip\fboxsep
						\copy\@tempboxa
						\vskip\fboxsep}%
					\vrule \@width#6}%
				#2%
				\hrule \@height#4\@width#7}%
		}%
	}%
	\endgroup
}

% Parameters for bar dimensions and spacing
\newcommand{\csbook@nestedbar@topbotrulelength}{1em}
\newcommand{\csbook@nestedbar@indent}{0.5em}

% FrameCommand helper that sets up side rule and spacing
\def\csbook@openframebox#1#2{%
	\fboxsep=\FrameSep
	\csbook@customfbox
	{}{}% no content above or below
	{#1}{#2}% top and bottom rule thicknesses
	\FrameRule\z@% left and right rule thickness
	\csbook@nestedbar@topbotrulelength% horizontal rule length
	\csbook@nestedbar@indent% indent from vertical rule
}

% Definition of the nestedbar environment
\newenvironment{nestedbar}[1][\hsize]{%
	\@ifundefined{OuterFrameSep}{%
		\@latex@error{To use nestedbar, update framed.sty to a recent version.}\@ehd}{}%
	\def\FrameCommand{\csbook@openframebox\FrameRule\FrameRule}%
	\def\FirstFrameCommand{\csbook@openframebox\FrameRule\z@}%
	\def\MidFrameCommand{\csbook@openframebox\z@\z@}%
	\def\LastFrameCommand{\csbook@openframebox\z@\FrameRule}%
	\OuterFrameSep=1ex
	\FrameSep=0pt
	\MakeFramed{\hsize#1\advance\hsize-\width\FrameRestore}%
}{%
	\endMakeFramed
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Copyright and License Page Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Modular CC BY-NC-SA 4.0 License Text (Structured for Open Books)
\NewDocumentCommand{\ccbyncsalicense}{}{
	\begin{small}
		\textbf{CC BY-NC-SA 4.0 License}
		\par\bigskip\noindent
		This book is licensed under a Creative Commons Attribution-NonCommercial-
		ShareAlike 4.0 International License. You are permitted to copy and
		redistribute the material in any medium or format, provided that you give
		appropriate credit, provide a link to the license, and indicate if changes
		were made. You may not use the material for commercial purposes. If you
		remix, transform, or build upon the material, you must distribute your
		contributions under the same license as the original. No additional
		restrictions may be applied that would legally restrict others from doing
		anything the license permits.
		\par\smallskip\noindent
		Please note that you do not have to comply with the license for elements of
		the material that are in the public domain or where your use is permitted by
		an applicable exception or limitation. No warranties are given. The license
		may not grant you all the permissions necessary for your intended use; for
		example, other rights such as publicity, privacy, or moral rights may limit
		how you use the material.
		\par\smallskip\noindent
		For the full license text, visit:
		\url{https://creativecommons.org/licenses/by-nc-sa/4.0/}
		\par\bigskip\noindent
		\textbf{AI Training Restriction:} The contents of this book may not be used,
		in whole or in part, for training artificial intelligence systems or models,
		including but not limited to large language models, without explicit written
		permission from the copyright holder.
	\end{small}
}

% Modular Copyright Page Command
\NewDocumentCommand{\makecopyrightpage}{O{\@title} O{\@author} O{\@date}}{
	\cleardoublepage
	\pagestyle{empty}
	\begin{flushleft}
		{\noindent\normalfont\normalsize\textbf{#1}}\par\medskip
		{\noindent\normalfont\normalsize By #2}\par\smallskip
		{\noindent\normalfont\textcopyright~#3.}\par\smallskip
		{\noindent\small\url{https://creativecommons.org/licenses/by-nc-sa-4.0/}}\par
	\end{flushleft}
	\vspace*{\fill}
	\ccbyncsalicense
	\cleardoublepage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% End of package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\endinput
