%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% csbook.sty: Academic Documentation and Modern Book-Style Framework
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title:   csbook – A Contemporary LaTeX Book-Style Package for Computer
%          Science
% Version: 2.1.1 (2025/01/28)
% Author:  Agni Datta
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 1. Introduction and Rationale
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The `csbook` package is a comprehensive, modular LaTeX style file
% designed to facilitate the creation of professional, visually appealing,
% and highly legible books, lecture notes, and monographs, with a
% particular focus on the needs of computer science and technical authors.
% As a core component of the csLaTeX suite, `csbook` provides a unified,
% extensible, and user-oriented toolkit for academic writing, emphasizing
% both typographic excellence and functional flexibility.
%
% The package is guided by principles of best-practice typographic design,
% modularity, and usability. It is intended for authors who value both
% aesthetics and efficiency, enabling them to focus on content development
% rather than low-level formatting. Typical users include:
%   - University instructors preparing textbooks or lecture notes
%   - Graduate students composing theses or dissertations
%   - Researchers authoring monographs or technical reports
%   - Academics seeking a modern, feature-rich alternative to the standard
%     LaTeX book class

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 2. Critical Requirements and Warnings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% **ENGINE REQUIREMENT:** The `csbook` package requires compilation with
% either LuaLaTeX or XeLaTeX. LuaLaTeX is strongly recommended for optimal
% support of modern font features, Unicode, and advanced typographic
% requirements. Compilation with pdfLaTeX or other engines is not supported
% and will result in a fatal error.
%
% **FONT REQUIREMENT:** Explicit font configuration is mandatory. Users must
% either:
%   (1) Enable the `defaultfont` option to load Computer Modern fonts, or
%   (2) Specify fonts explicitly using the `\csbookfonts{...}` command.
% Failure to configure fonts will result in compilation errors or degraded
% typography.
%
% **EXTERNAL TOOLS:** Some features (e.g., glossaries, indices) require
% external tools such as `makeglossaries` and `makeindex` for full
% functionality.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 3. Feature Overview
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The `csbook` package provides the following principal features:
%
% - Modular, option-based activation of advanced packages for layout,
%   typography, code, and graphics
% - Modernized sectioning and header formatting with customizable fonts,
%   spacing, and symbols
% - Configurable theorem, proof, and definition environments (via csthm),
%   with support for custom theorem styles
% - Enhanced list environments (itemize, enumerate, description) with
%   improved spacing, custom labels, and additional list types (e.g.,
%   codelist, checkbox, deflist)
% - Support for colored and framed boxes for theorems, examples, notes, and
%   custom content (via tcolorbox, mdframed, and csLaTeX box macros)
% - Optional integration with TikZ and PGFPlots for advanced diagrams and
%   data visualization, including comprehensive TikZ library support
% - Epigraphs for chapter or section openings, with fully customizable
%   appearance (width, rule, alignment, font)
% - **Letterine (Dropped Capitals) Support:** Optionally enable decorative
%   dropped capitals (letterine) at the start of chapters or sections, with
%   customizable style, font, and color. Provides user commands for manual
%   or automatic insertion of letterine.
% - Appendix and advanced table of contents management, including
%   multi-level TOC formatting and spacing adjustments
% - Glossary and index support, with seamless integration of external tools
%   and customizable formatting
% - Enhanced verbatim/code environments for source code listings, including
%   improved handling of empty lines and optional syntax highlighting
% - Abstract and acknowledgment environments with modern, typographically
%   consistent formatting
% - Consistent bibliography and table of contents formatting, with custom
%   commands for insertion, style selection, and spacing
% - User-friendly custom commands for common tasks, including colored
%   comments, text and math highlighting, and collaborative annotation
% - Header-level formatting via titlesec, supporting custom section fonts
%   and flexible heading layouts
% - Full compatibility with the csLaTeX suite and standard LaTeX tools,
%   with robust option processing and error handling
% - Advanced utility macros for text, mathematics, code, lists, and missing
%   content reporting
% - Fine-grained control over feature activation, allowing users to enable
%   only the desired components for efficient compilation
% - **Copyright Page Support:** Provides a modern, customizable copyright
%   page environment and commands for academic and professional books.
% - **Missing Content Reporting:** Mark and collect missing content for
%   collaborative review and reporting.
% - **Collaborative Colored Comments:** Define custom colored comment macros
%   for annotation and review.
% - **Section Heading Font Customization:** Easily redefine heading fonts
%   and styles for all sectioning levels.
% - **Advanced List Environments:** Includes codelist, checkbox, and deflist
%   for specialized list formatting.
% - **Text and Math Highlighting:** Highlight text and math with custom
%   colors for emphasis.
% - **Math and Symbol Utilities:** Includes commands for math hyphens,
%   small caps, bold italic, and more.
% - **Enhanced Option Processing:** Robust and user-friendly option handling
%   with improved error messages and logical grouping.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 4. Usage Instructions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% To use `csbook`, place the package in your LaTeX search path and load it
% in the document preamble as follows:
%
%   \usepackage[<options>]{csbook}
%
% Options allow selective enabling or disabling of specific features. For
% example:
%
%   \usepackage[epigraph,glossaries,niceboxs,theorem,tikz,verbatim,
%               adjusttoc,indices,hyperref,appendix,letterine]{csbook}
%
% Options are independent and may be combined arbitrarily. The `full`
% option enables all major features for maximal functionality. Font
% configuration is required via either the `defaultfont` option or the
% `\csbookfonts{...}` command.
%
% For collaborative annotation, missing content reporting, custom
% comment macros, and letterine (dropped capitals), see the relevant
% commands in Section 7 below.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 5. Package Options (Organized by Category)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% **Layout and Typography Options:**
%   nicelayout    – Enhanced page layout with improved margins, headers,
%                   and footers
%   nicespacing   – Improved line and paragraph spacing for superior
%                   readability
%   oldsection    – Classic section formatting with traditional symbols
%                   and spacing
%   adjusttoc     – Advanced table of contents formatting, multi-level
%                   spacing, and custom TOC title
%   letterine     – Enable decorative dropped capitals (letterine) at the
%                   start of chapters or sections. Provides commands for
%                   manual or automatic insertion, with customizable style,
%                   font, and color.
%
% **Content Enhancement Options:**
%   epigraph      – Epigraphs for chapters/sections with customizable
%                   appearance
%   niceboxs      – Modern colored/framed boxes (tcolorbox, mdframed,
%                   csLaTeX box macros)
%   theorem       – Theorem/proof/definition environments (csthm), with
%                   support for custom theorem styles
%   verbatim      – Enhanced verbatim/code environments with improved
%                   formatting and blank line handling
%   copyrightpage – Modern copyright page environment and commands
%
% **Document Structure Options:**
%   appendix      – Appendix support with advanced formatting and TOC
%                   integration
%   glossaries    – Glossary support with external tool integration and
%                   custom formatting
%   indices       – Index support with customizable formatting and
%                   external tool integration
%   hyperref      – Hyperref integration for PDF navigation, bookmarks,
%                   and metadata
%
% **Graphics and Visualization Options:**
%   tikz          – TikZ and PGFPlots for graphics, with comprehensive
%                   TikZ library support and advanced diagramming
%
% **Utility Options:**
%   usefulcommands – Common utility macros for text, math, code, lists,
%                    annotation, missing content reporting, and
%                    collaborative comments (enabled by default)
%   defaultfont    – Load Computer Modern fonts automatically (if no
%                    explicit font configuration is provided)
%
% **Convenience Options:**
%   full           – Enable all major features (hyperref, niceboxs,
%                    nicelayout, nicespacing, usefulcommands, verbatim,
%                    adjusttoc, appendix, glossaries, indices, epigraph,
%                    theorem, tikz, copyrightpage, letterine)
%
% **Advanced/Experimental Options:**
%   (Additional options may be introduced in future versions; consult the
%   documentation for updates.)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 6. Principal Advantages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% - **Modularity:** Only explicitly requested features are loaded,
%   ensuring a concise preamble and efficient compilation.
% - **Modern Aesthetics:** Section headings, lists, and boxes are styled
%   for clarity and visual appeal, adhering to contemporary typographic
%   standards.
% - **Code and Math Optimization:** Tailored for documents with
%   substantial code listings, algorithms, and mathematical notation,
%   including advanced verbatim and math highlighting.
% - **Extensibility:** Seamless integration with other csLaTeX packages
%   and standard LaTeX tools, with robust option processing and error
%   handling.
% - **Consistency:** Guarantees a uniform appearance across chapters,
%   appendices, and supplementary material, with customizable sectioning
%   and environment styles.
% - **Comprehensive Utility:** Provides a wide array of user-facing
%   commands, environments, and macros for collaborative writing,
%   annotation, missing content reporting, and content management.
% - **Collaborative Annotation:** Easily define colored comment macros for
%   review and collaboration.
% - **Missing Content Reporting:** Mark and collect missing content for
%   later review and reporting.
% - **Section Heading Customization:** Redefine heading fonts and styles
%   for all sectioning levels.
% - **Advanced List Environments:** Specialized lists for code, checklists,
%   and definitions.
% - **Copyright Page:** Easily insert a professional copyright page
%   suitable for academic and professional books, with customizable
%   fields and layout.
% - **Letterine (Dropped Capitals):** Easily insert decorative dropped
%   capitals at the start of chapters or sections for a classic or
%   modern typographic effect. Fully customizable style, font, and color.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 7. Custom Commands and Environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The package defines an extensive suite of user-facing commands and
% environments. In addition to the principal environments and commands
% enumerated below, `csbook` supplies a broad set of utility macros for
% text, mathematics, code, lists, collaborative writing, missing content
% reporting, annotation, and decorative dropped capitals (letterine).
% Refer to the extended list following the main features.
%
% - **Section Heading Customization:**
%     \sectionheadingfont, \subsectionheadingfont, etc. – Redefine heading
%     fonts and styles
% - **Modern Boxes:**
%     If `niceboxs` is enabled, environments such as `tcolorbox`,
%     `mdframed`, and csLaTeX box macros are available for constructing
%     colored and framed boxes, suitable for highlighting theorems,
%     examples, or important notes.
% - **Epigraphs:**
%     If `epigraph` is enabled, use \epigraph{<text>}{<author>} to insert
%     introductory quotations. The appearance is fully configurable
%     (width, rule, alignment, font).
% - **Acknowledgment:**
%     \begin{acknowledgment}[<optional title>] ... \end{acknowledgment}
% - **Abstract:**
%     \begin{abstract} ... \end{abstract}
% - **Copyright Page:**
%     If `copyrightpage` is enabled, use
%     \begin{copyrightpage}[<options>] ... \end{copyrightpage} to insert
%     a modern copyright page. Custom fields such as year, publisher,
%     ISBN, and license can be set via commands:
%       \copyrightyear{<year>}
%       \copyrightauthor{<author>}
%       \copyrightpublisher{<publisher>}
%       \copyrightisbn{<isbn>}
%       \copyrightlicense{<license>}
%     The layout and appearance are fully customizable.
% - **Table of Contents:**
%     \toc – Inserts a formatted table of contents with advanced spacing,
%     page breaks, and custom title.
% - **Bibliography:**
%     \printbib[<style>]{<bibfile>} – Prints the bibliography with the
%     specified style (default: alphaurl).
% - **Custom Comments:**
%     \newcomment{name}{color}{command} – Defines a colored comment macro
%     for collaborative annotation and review.
% - **Enhanced Lists:**
%     Enumerate and itemize environments are redefined for improved
%     labels and spacing (e.g., (1), (a), (I) for enumerate; bullet, en
%     dash, open circle for itemize). Additional list environments:
%       - codelist: enumerate with [1], [2], ... for code steps
%       - checkbox: itemize with empty box, checkmark, or crossmark
%       - deflist: description list with bold labels
%     List item commands:
%       - \taskitem: item with empty box
%       - \checkeditem: item with checkmark
%       - \uncheckeditem: item with crossmark
% - **Verbatim/Code:**
%     If `verbatim` is enabled, enhanced verbatim environments are
%     provided, with improved handling of empty lines, formatting, and
%     optional syntax highlighting.
% - **Appendices:**
%     If `appendix` is enabled, advanced appendix management and TOC
%     integration are available.
% - **Theorem Environments:**
%     If `theorem` is enabled, theorem, proof, definition, and related
%     environments are provided via csthm, with modern styling,
%     numbering, and support for custom theorem styles.
% - **TikZ Graphics:**
%     If `tikz` is enabled, TikZ, PGFPlots, and a comprehensive set of
%     TikZ libraries are loaded for advanced diagramming and plotting.
% - **Glossaries and Indices:**
%     If `glossaries` or `indices` are enabled, environments and
%     commands for glossary and index management are provided, with
%     support for external tool integration and custom formatting.
% - **Missing Content Reporting:**
%     \missing{<description>} – Mark missing content and collect for
%     reporting
%     \missinglist – List of all missing items (for reporting)
% - **Letterine (Dropped Capitals):**
%     If `letterine` is enabled, the following commands are available:
%       - \letterine{<letter>}[<options>] – Insert a decorative dropped
%         capital at the start of a paragraph, with optional style
%         customization (e.g., color, font, size, lines dropped).
%       - \autoletterine – Automatically insert a dropped capital at the
%         start of each chapter or section (configurable).
%     The appearance of the letterine can be customized globally or per
%     use. See the documentation for advanced usage and styling.

%
% ------------------------------------------------------------------------
% Additional Utility Commands Provided by csbook:
% ------------------------------------------------------------------------
%
% -- Text and Math Highlighting:
%   \emphmath{<math>}    – Emphasize mathematics in highlight color
%   \emphtext{<text>}    – Emphasize text in highlight color
%   \textem{<text>}      – Alias for \emphtext
%   \textbi{<text>}      – Bold italic text
%   \code{<text>}        – Inline code font (\texttt)
%   \mathsc{<text>}      – Math small caps (upright)
%   \mathbi{<text>}      – Math bold italic (upright)
%   \inmath{<math>}      – Inline math shortcut (\ensuremath)
%   \putInQuotes{<text>} – Typeset text in English-style quotation marks
%
% -- Math and Symbol Utilities:
%   \mathhyphen          – Hyphen/minus in math mode
%
% -- List and Task Utilities:
%   \taskitem            – List item with empty box (for checklists)
%   \checkeditem         – List item with checkmark
%   \uncheckeditem       – List item with crossmark
%
% -- Missing Content Reporting:
%   \missing{<description>} – Mark missing content and collect for
%                            reporting
%   \missinglist            – List of all missing items (for reporting)
%
% -- Letterine (Dropped Capitals):
%   \letterine{<letter>}[<options>] – Insert a decorative dropped capital
%   at the start of a paragraph. Options include color, font, size, and
%   number of lines to drop.
%   \autoletterine – Automatically insert a dropped capital at the start
%   of each chapter or section (if enabled).
%
% -- Miscellaneous:
%   \newcomment{name}{color}{command} – Define a colored comment macro
%   (e.g., \newcomment{Bob}{blue}{bobnote} yields \bobnote{...})
%
% -- List Environments (in addition to standard itemize/enumerate):
%   codelist      – Enumerate with [1], [2], ... for code steps
%   checkbox      – Itemize with empty box, checkmark, or crossmark
%   deflist       – Description list with bold labels
%
% -- Section Heading Font Customization:
%   \sectionheadingfont, \subsectionheadingfont, etc. – Redefine heading
%   fonts
%
% -- Table of Contents and Bibliography:
%   \toc          – Insert formatted table of contents
%   \printbib[<style>]{<bibfile>} – Print bibliography with specified
%                   style
%
% -- Abstract and Acknowledgment Environments:
%   \begin{abstract}...\end{abstract}
%   \begin{acknowledgment}[<title>]...\end{acknowledgment}
%
% -- Epigraphs:
%   \epigraph{<text>}{<author>} – Insert an epigraph
%
% -- Copyright Page:
%   \begin{copyrightpage}[<options>]...\end{copyrightpage}
%   \copyrightyear{<year>}
%   \copyrightauthor{<author>}
%   \copyrightpublisher{<publisher>}
%   \copyrightisbn{<isbn>}
%   \copyrightlicense{<license>}
%
% -- Enhanced Verbatim/Code Environments:
%   (if enabled) – Improved verbatim/code with blank line handling and
%   optional syntax highlighting
%
% -- Theorem/Proof/Definition Environments:
%   (if enabled) – Modern theorem/proof/definition environments via
%   csthm, with support for custom theorem styles
%
% -- TikZ/PGFPlots Graphics:
%   (if enabled) – Comprehensive TikZ and PGFPlots support with
%   libraries
%
% -- Glossaries and Indices:
%   (if enabled) – Glossary and index environments and commands, with
%   external tool integration

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 8. Style and Formatting Principles (Comprehensive)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% - **Section Headings:** Modern, bold, and optionally centered section
%   titles with clear numbering and spacing, customizable via
%   \sectionheadingfont, etc.
% - **Lists:** Compact, visually distinct list items with minimal
%   vertical spacing. Enumerate and itemize environments employ custom
%   labels for each nesting level. Additional list types (codelist,
%   checkbox, deflist) are provided.
% - **Boxes:** Utilization of `tcolorbox`, `mdframed`, and csLaTeX box
%   macros for visually appealing framed environments, supporting
%   theorems, proofs, examples, and custom content.
% - **Epigraphs:** Right-aligned, small-caps author attributions, and
%   adjustable width and rule, with full customization.
% - **Typography:** Defaults to legible font sizes and line spacing, with
%   options for further customization and explicit font configuration.
% - **Code Listings:** Enhanced verbatim environments for code, with
%   improved handling of empty lines and optional syntax highlighting.
% - **Bibliography and TOC:** Consistent formatting, with advanced
%   spacing, page breaks, and customizable titles to enhance readability.
% - **Header-level Formatting:** Employs titlesec for flexible section
%   formatting and custom heading styles.
% - **Appendices, Glossaries, Indices:** Advanced management and
%   formatting, with seamless integration into the document structure and
%   TOC.
% - **Collaborative Annotation:** Colored comment macros and missing
%   content reporting for collaborative writing and review.
% - **Missing Content Reporting:** Mark and collect missing content for
%   collaborative review and reporting.
% - **Section Heading Customization:** Easily redefine heading fonts and
%   styles for all sectioning levels.
% - **Advanced List Environments:** Specialized lists for code, checklists,
%   and definitions.
% - **Copyright Page:** Modern copyright page with customizable fields,
%   layout, and license support.
% - **Letterine (Dropped Capitals):** Decorative dropped capitals at the
%   start of chapters or sections, with customizable style, font, color,
%   and number of lines dropped. Enhances typographic sophistication and
%   visual interest.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 9. Limitations and Caveats (Comprehensive)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% - **Engine Requirements:** This package requires LuaLaTeX or XeLaTeX.
%   pdfLaTeX and other engines are not supported due to font and Unicode
%   limitations.
% - **Font Configuration:** Users must explicitly configure fonts using
%   either the `defaultfont` option or the `\csbookfonts{...}` command.
%   Failure to do so will result in compilation errors.
% - **Package Interactions:** While `csbook` is designed for modularity,
%   certain features (e.g., advanced theorem environments, TikZ, custom
%   boxes, letterine) may conflict with packages that redefine the same
%   environments. Users should test their preamble when employing
%   additional customizations.
% - **Language Support:** Multilingual support is not enabled by default;
%   employ `babel` or `polyglossia` as required.
% - **Glossaries/Indices:** These features require external tools (e.g.,
%   `makeglossaries`, `makeindex`) for compilation and full
%   functionality.
% - **Backward Compatibility:** Some features may be unavailable in
%   legacy TeX distributions. Use a recent TeX Live or MiKTeX for full
%   compatibility.
% - **Customization:** While many aspects are customizable, substantial
%   changes to sectioning, theorem styles, box environments, or letterine
%   may require patching the package or advanced LaTeX techniques.
% - **Theorem Styles:** The theorem environments depend on the presence
%   of `csthm.sty`. If this file is absent, a warning is issued and the
%   environments are not loaded.
% - **TikZ/PGFPlots:** The complete set of TikZ libraries is loaded if
%   the `tikz` option is enabled, which may increase compilation time and
%   memory usage.
% - **Verbatim Patch:** The patch for verbatim environments suppresses
%   empty lines, which may affect code listings that rely on blank lines.
% - **External Tools:** Glossaries and indices require external
%   compilation steps; consult the documentation for workflow details.
% - **Copyright Page:** The copyright page feature is enabled only if
%   the `copyrightpage` option is specified.
% - **Missing Content Reporting:** The missing content reporting feature
%   is available only if `usefulcommands` is enabled (default).
% - **Collaborative Comments:** Custom colored comment macros require
%   `usefulcommands` to be enabled.
% - **Letterine:** The letterine feature is available only if the
%   `letterine` option is enabled. Some fonts may not support all
%   stylistic options for dropped capitals.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 10. Changelog (Comprehensive)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% v2.1.1 (2025/01/28)
%   - Expanded documentation to reflect new features and options
%   - Improved glossary and index integration and documentation
%   - Enhanced support for advanced TOC formatting (adjusttoc)
%   - Added explicit mention of collaborative annotation and missing
%     content reporting
%   - Updated example usage and option lists for completeness
%   - Improved error handling and option processing robustness
%   - Added copyright page feature and documentation
%   - Added missing content reporting commands (\missing, \missinglist)
%   - Added collaborative colored comment macros (\newcomment)
%   - Added section heading font customization commands
%   - Added advanced list environments (codelist, checkbox, deflist)
%   - Added text and math highlighting commands
%   - Improved documentation for all new features and commands
%   - **Added letterine (dropped capitals) feature and documentation**
%
% v2.1 (2025/01/28)
%   - Reorganized package options for better clarity and logical grouping
%   - Added explicit engine requirement warnings (LuaLaTeX/XeLaTeX only)
%   - Added explicit font configuration requirement warnings
%   - Improved documentation with academic and formal tone
%   - Fixed option declaration errors and improved option processing
%   - Enhanced error messages for unsupported engines and missing font
%     configuration
%   - Updated version number and documentation structure
%
% v2.0 (2025/06/28)
%   - Major refactor for modularity and option-based loading
%   - Enhanced documentation and code comments
%   - Improved support for modern boxes (tcolorbox, mdframed)
%   - New custom commands for TOC and bibliography insertion
%   - Refined list formatting and spacing
%   - Epigraph environment now utilizes xparse for flexibility
%   - Added support for collaborative comment macros
%   - Improved abstract and acknowledgment environments
%   - Enhanced compatibility with csLaTeX suite
%   - Comprehensive TikZ library loading for advanced graphics
%   - Patched verbatim environment to suppress empty lines
%   - Added appendix and glossary support with external tool integration
%   - Introduced header-level formatting with titlesec
%   - Improved modularity for all features via boolean flags and options
%   - Added warning for missing csthm.sty
%   - Improved bibliography and TOC formatting
%   - Added support for indices and hyperref integration
%
% v1.5 (2024/07/15)
%   - Introduced TikZ/PGFPlots integration
%   - Enhanced theorem and proof environments
%   - Improved appendix and glossary support
%   - Added support for indices and refined list environments
%
% v1.2 (2024/03/10)
%   - Added support for collaborative colored comments
%   - Improved abstract and acknowledgment environments
%   - Enhanced compatibility with csLaTeX suite
%
% v1.0 (2023/12/01)
%   - Initial release with core features: section formatting, lists,
%     boxes, basic theorem environments, and utility commands

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 11. Example Usage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \documentclass{book}
% \usepackage[epigraph,niceboxs,theorem,verbatim,tikz,glossaries,indices,
%             hyperref,adjusttoc,appendix,copyrightpage,letterine]{csbook}
%
% % Font configuration (REQUIRED)
% \csbookfonts{rm=libertinus,sf=biolinum,tt=sourcecode}
%
% \begin{document}
%
% \begin{copyrightpage}
%   \copyrightyear{2025}
%   \copyrightauthor{Agni Datta}
%   \copyrightpublisher{csLaTeX Project}
%   \copyrightisbn{978-1-23456-789-0}
%   \copyrightlicense{CC-BY-NC 4.0}
% \end{copyrightpage}
%
% \begin{abstract}
%   This book provides an introduction to modern algorithms...
% \end{abstract}
%
% \toc
%
% \chapter{Introduction}
% \epigraph{All models are wrong, but some are useful.}{George Box}
%
% \section{Motivation}
% \begin{acknowledgment}
%   The author thanks the csLaTeX community for their support.
% \end{acknowledgment}
%
% \begin{tcolorbox}[title=Key Idea]
%   Divide and conquer is a fundamental paradigm...
% \end{tcolorbox}
%
% \begin{itemize}
%   \item Fast
%   \item Modular
%   \item Readable
% \end{itemize}
%
% % Example of missing content reporting:
% \missing{Add more examples to this section}
%
% % Example of collaborative colored comment:
% \newcomment{Alice}{red}{alicenote}
% \alicenote{Please clarify the definition above.}
%
% % Example of advanced list environments:
% \begin{codelist}
%   \item Initialize variables
%   \item Loop over input
%   \item Return result
% \end{codelist}
%
% % Example of letterine (dropped capital):
% \letterine{A}[color=blue,lines=3,font=\rmfamily]
% lgorithms are at the heart of computer science...
%
% \printbib{references}
%
% % To list all missing content:
% \missinglist
%
% \end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 12. Support and Further Information
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% For bug reports, feature requests, or contributions, please consult the
% csLaTeX project repository or contact the maintainer. Comprehensive
% documentation, option reference, and advanced usage examples are
% available in the csLaTeX suite documentation and online repository.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesPackage{csbook}[2025/01/28 v2.1.1 csbook package]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core Programming and Utility Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Essential packages loaded unconditionally
\RequirePackage{etoolbox}                                    % Logic and macro patching
\RequirePackage{iftex}                                       % Detect engine: pdfTeX, XeTeX, LuaTeX
\RequirePackage{xparse}                                      % Extended command/environment definitions
\RequirePackage{comment}                                     % Block comment environment

% Conditional packages for development and testing
\@ifpackageloaded{blindtext}{}{%
	\RequirePackage{blindtext}                                 % Generate blind documents
}
\@ifpackageloaded{lipsum}{}{%
	\RequirePackage{lipsum}                                    % Dummy text generation
}

% Utility packages (loaded only when needed)
\newif\ifcsbook@need@calc\csbook@need@calcfalse
\newif\ifcsbook@need@kvoptions\csbook@need@kvoptionsfalse
\newif\ifcsbook@need@xkeyval\csbook@need@xkeyvalfalse

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Package Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Boolean flags for feature activation
\newif\ifcsbook@LoadAdjustToC           \csbook@LoadAdjustToCfalse
\newif\ifcsbook@LoadAppendix            \csbook@LoadAppendixfalse
\newif\ifcsbook@LoadDefaultFont         \csbook@LoadDefaultFontfalse
\newif\ifcsbook@LoadEpigraph            \csbook@LoadEpigraphfalse
\newif\ifcsbook@LoadGlossaries          \csbook@LoadGlossariesfalse
\newif\ifcsbook@LoadHyperref            \csbook@LoadHyperreffalse
\newif\ifcsbook@LoadIndices             \csbook@LoadIndicesfalse
\newif\ifcsbook@LoadLettrine            \csbook@LoadLettrinefalse
\newif\ifcsbook@LoadNiceBoxs            \csbook@LoadNiceBoxsfalse
\newif\ifcsbook@LoadNiceLayout          \csbook@LoadNiceLayoutfalse
\newif\ifcsbook@LoadNiceSpacing         \csbook@LoadNiceSpacingfalse
\newif\ifcsbook@LoadOldSection          \csbook@LoadOldSectionfalse
\newif\ifcsbook@LoadTheorem             \csbook@LoadTheoremfalse
\newif\ifcsbook@LoadTikZ                \csbook@LoadTikZfalse
\newif\ifcsbook@LoadUsefulCommands      \csbook@LoadUsefulCommandstrue
\newif\ifcsbook@LoadVerbatim            \csbook@LoadVerbatimfalse

% Declare package options
\newcommand{\csbook@setoption}[2]{%
	\DeclareOption{#1}{\csname csbook@Load#2true\endcsname}%
}

% Layout and Typography Options
\csbook@setoption{adjusttoc}{AdjustToC}
\csbook@setoption{nicelayout}{NiceLayout}
\csbook@setoption{nicespacing}{NiceSpacing}
\csbook@setoption{oldsection}{OldSection}
\csbook@setoption{lettrine}{Lettrine}

% Content Enhancement Options
\csbook@setoption{epigraph}{Epigraph}
\csbook@setoption{niceboxs}{NiceBoxs}
\csbook@setoption{theorem}{Theorem}
\csbook@setoption{verbatim}{Verbatim}

% Document Structure Options
\csbook@setoption{appendix}{Appendix}
\csbook@setoption{glossaries}{Glossaries}
\csbook@setoption{indices}{Indices}
\csbook@setoption{hyperref}{Hyperref}

% Graphics and Visualization Options
\csbook@setoption{tikz}{TikZ}

% Utility Options
\csbook@setoption{defaultfont}{DefaultFont}
\csbook@setoption{usefulcommands}{UsefulCommands}

% Convenience option for enabling all major features
\DeclareOption{full}{%
	\csbook@LoadHyperreftrue
	\csbook@LoadNiceBoxstrue
	\csbook@LoadNiceLayouttrue
	\csbook@LoadNiceSpacingtrue
	\csbook@LoadUsefulCommandstrue
	\csbook@LoadVerbatimtrue
}

% Process options and handle unknown ones
\DeclareOption*{\PackageWarning{csbook}{Unknown option '\CurrentOption'}}
\ProcessOptions\relax

% Load required packages based on options
\ifcsbook@LoadNiceBoxs\csbook@need@kvoptionstrue\fi
\ifcsbook@LoadDefaultFont\csbook@need@xkeyvaltrue\fi

% Load conditional packages
\ifcsbook@need@kvoptions
	\RequirePackage{kvoptions}
\fi
\ifcsbook@need@xkeyval
	\RequirePackage{xkeyval}
\fi
\ifcsbook@need@calc
	\RequirePackage{calc}
\fi

% Performance monitoring (optional)
\newif\ifcsbook@performance@monitoring\csbook@performance@monitoringfalse
\ifcsbook@performance@monitoring
	\typeout{csbook: Performance monitoring enabled}
	\AtEndPreamble{%
		\typeout{csbook: Package initialization completed}
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Engine Compatibility Check (Enhanced with Clear Warnings)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Engine compatibility check
\ifLuaTeX
	\typeout{csbook: LuaTeX engine detected. Proceeding with package initialization.}
	\typeout{csbook: NOTE: LuaLaTeX is the preferred engine for optimal performance.}
\else
	\ifXeTeX
		\typeout{csbook: XeTeX engine detected. Proceeding with package initialization.}
		\typeout{csbook: NOTE: Consider using LuaLaTeX for better font handling and performance.}
	\else
		\PackageError{csbook}{%
			Unsupported engine detected.%
		}{%
			The csbook package requires either LuaLaTeX or XeLaTeX for proper operation.%
			LuaLaTeX is strongly preferred due to superior font handling and Unicode support.%
			Please compile your document with LuaLaTeX or XeLaTeX.%
		}
	\fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Check for supported document classes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document class compatibility check
\newcommand{\csbook@checkclass}[1]{%
	\@ifclassloaded{#1}{%
		\typeout{csbook: Detected document class: #1.}%
		\csbook@class@supportedtrue
	}{%
		\csbook@class@supportedfalse
	}%
}

\newif\ifcsbook@class@supported\csbook@class@supportedfalse
\csbook@checkclass{book}
\ifcsbook@class@supported\else
	\csbook@checkclass{extbook}
	\ifcsbook@class@supported\else
		\csbook@checkclass{report}
		\ifcsbook@class@supported\else
			\PackageError{csbook}{%
				Unsupported document class detected.
				This package is officially supported only
				for the following classes: extbook, book, or report.
				Your class (\@currclass) is not supported.%
			}{%
				Please use extbook, book, or report as your document class.%
			}
		\fi
	\fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font Configuration Warning
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AtEndPreamble{%
	\ifcsbook@LoadDefaultFont
		\typeout{csbook: Default fonts will be loaded automatically.}
	\else
		\@ifundefined{csbookfonts@rm}{%
			\PackageWarning{csbook}{%
				No font configuration detected.%
				Please either use the 'defaultfont' option or%
				explicitly configure fonts using \string\csbookfonts\{...\}.%
				This may result in compilation errors or suboptimal typography.%
			}%
		}{}%
	\fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Core Document Structure and Formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Color Management
\RequirePackage[x11names, dvipsnames, svgnames]{xcolor}      % Extended color support

% PDF and Document Control
\RequirePackage[2.0,objcompress,compress]{bxpdfver}          % PDF version and compression management
\RequirePackage[nottoc]{tocbibind}                           % Add bibliography/lists to TOC (exclude TOC itself)
\RequirePackage{refcount}                                    % Reference counting

% Language and Internationalization
\RequirePackage{babel}                                       % Language, hyphenation

% External Content Integration
\RequirePackage{pdfpages}                                    % Include external PDFs

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Margin and Spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Modular Page Layout Setup
\newcommand{\csbook@setup@layout@nice}{%
	\typeout{csbook: Loading enhanced page layout}%
	\RequirePackage[margin=3.00cm]{geometry}%
	\RequirePackage{fancyhdr}%
	\fancyhf{}%
	\fancyhead[LE,RO]{\normalfont\small\sffamily\thepage}%
	\fancyhead[LO,RE]{\normalfont\small\sffamily\@title}%
	\renewcommand{\headrulewidth}{0.25pt}%
	\pagestyle{fancy}%
}

\newcommand{\csbook@setup@layout@default}{%
	\typeout{csbook: Loading standard page layout}%
	\RequirePackage[margin=2.5cm]{geometry}%
	\RequirePackage{fancyhdr}%
	\pagestyle{plain}%
}

% Modular Spacing Setup
\newcommand{\csbook@setup@spacing@nice}{%
	\RequirePackage{setspace}%
	\setstretch{1.175}%
}

\newcommand{\csbook@setup@spacing@default}{%
	\RequirePackage{setspace}%
	\setstretch{1.015}%
}

% Apply Layout and Spacing
\ifcsbook@LoadNiceLayout
	\csbook@setup@layout@nice
\else
	\csbook@setup@layout@default
\fi

\ifcsbook@LoadNiceSpacing
	\csbook@setup@spacing@nice
\else
	\csbook@setup@spacing@default
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Typography and Text Processing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Advanced Typography
\RequirePackage[final]{microtype}                            % Improved justification and hyphenation
\RequirePackage[autostyle=true, csdisplay=true]{csquotes}    % Automatic quotation marks and smart citations

% Text Formatting and Symbols
\RequirePackage[full]{textcomp}                              % Additional text symbols (e.g., degree sign)
\RequirePackage[normalem]{ulem}                              % Underlining and strikethrough capabilities
\RequirePackage{moresize}                                    % Extra font sizes

% Text Processing and Utilities
\RequirePackage{xspace}                                      % Intelligent spacing after macros
\RequirePackage{underscore}                                  % Allows underscores handling
\RequirePackage{xurl}                                        % Breakable URLs in text

% Text Highlighting and Effects
\RequirePackage{soul}                                        % For text highlighting (e.g., \hl, \ul, \st)

% List and Layout Enhancements
\RequirePackage{paralist}                                    % Compact and in-paragraph list environments
\RequirePackage{emptypage}                                   % No page numbers on empty pages

% Citation Management
\RequirePackage[nocompress]{cite}                            % Citation package for references

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font Management and Configuration
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Font Configuration System
\SetupKeyvalOptions{%
	family=csbookfonts,
	prefix=csbookfonts@
}

% Default Font Family Declarations
\DeclareStringOption[cmroman]{rm}                            % Roman (serif) font family
\DeclareStringOption[cmsans]{sf}                             % Sans-serif font family
\DeclareStringOption[cmmono]{tt}                             % Monospace font family

% Unicode Font and Math Support System
\newcommand{\csbook@loadunicodefonts}{%
	% Core Mathematics Packages (Essential)
	\RequirePackage{amsmath}     % Advanced math environments and features
	\RequirePackage{amssymb}     % Additional math symbols
	\RequirePackage{mathtools}   % Math tools and enhancements to amsmath

	% Conditional Mathematics Packages (Optional)
	\@ifpackageloaded{amsfonts}{}{%
		\RequirePackage{amsfonts}    % Extra math fonts
	}
	\@ifpackageloaded{sansmath}{}{%
		\RequirePackage{sansmath}    % Sans-serif font for mathematical expressions
	}
	\@ifpackageloaded{nicefrac}{}{%
		\RequirePackage{nicefrac}    % Nice-looking fractions (e.g., ½)
	}
	\@ifpackageloaded{siunitx}{}{%
		\RequirePackage{siunitx}     % SI units and number formatting
	}
	\@ifpackageloaded{cancel}{}{%
		\RequirePackage{cancel}      % Cancel lines in math expressions
	}
	\@ifpackageloaded{empheq}{}{%
		\RequirePackage{empheq}      % Emphasized equations and boxed math environments
	}
	\@ifpackageloaded{tensor}{}{%
		\RequirePackage{tensor}      % Typesetting tensors with indices
	}

	% Font Setup for Unicode and OpenType (Core)
	\RequirePackage{fontspec}    % Font selection for XeTeX/LuaTeX
	\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
}

% Roman (Serif) Font Family Loaders
\newcommand{\csbook@loadfont@rm@cmroman}{%
	\csbook@loadunicodefonts
	\setmainfont[%
		BoldFont = NewCM10-Bold.otf,
		BoldItalicFont = NewCM10-BoldItalic.otf,
		ItalicFont = NewCM10-BookItalic.otf,
		RawFeature = {+calt,+case,+hlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		SlantedFont = NewCM10-Book.otf,
		SlantedFeatures={FakeSlant=0.25},
		SmallCapsFeatures = {RawFeature=+smcp,FakeSlant=0},
		SmallCapsFont = NewCM10-Book.otf
	]{NewCM10-Book.otf}
	\setmathfont[AutoFakeBold,Scale=MatchUppercase]{NewCMMath-Book.otf}
}

\newcommand{\csbook@loadfont@rm@garamond}{%
	\csbook@loadunicodefonts
	\setmainfont[%
		BoldFont = GaramondLibre-Bold.otf,
		BoldItalicFont = GaramondLibre-BoldItalic.otf,
		ItalicFont = GaramondLibre-Italic.otf,
		RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		SlantedFont = GaramondLibre-Regular.otf,
		SlantedFeatures={FakeSlant=0.25},
		SmallCapsFeatures={RawFeature=+smcp,FakeSlant=0},
		SmallCapsFont = EBGaramond-Medium.otf
	]{GaramondLibre-Regular.otf}
	\setmathfont[AutoFakeBold,StylisticSet={2,6,7,9},Scale=MatchUppercase]{Garamond-Math.otf}
}

\newcommand{\csbook@loadfont@rm@libertinus}{%
	\csbook@loadunicodefonts
	\setmainfont[%
		BoldFont = LibertinusSerif-Bold.otf,
		BoldItalicFont = LibertinusSerif-BoldItalic.otf,
		ItalicFont = LibertinusSerif-Italic.otf,
		RawFeature={+calt,+case,+cpsp,+kern,+liga,+lnum,+mark,+mkmk,+pnum,+ss06},
		SlantedFont = LibertinusSerif-Regular.otf,
		SlantedFeatures={FakeSlant=0.25},
		SmallCapsFeatures={RawFeature=+smcp,FakeSlant=0},
		SmallCapsFont = LibertinusSerif-Regular.otf
	]{LibertinusSerif-Regular.otf}
	\setmathfont[AutoFakeBold,Scale=MatchUppercase]{LibertinusMath-Regular.otf}
}

% Legacy Font Setup Packages
\newcommand{\csbook@loadfont@rm@concrete}{%
	\csbook@loadunicodefonts
	\RequirePackage[concrete]{fontsetup}
}

\newcommand{\csbook@loadfont@rm@oldstandard}{%
	\csbook@loadunicodefonts
	\RequirePackage[oldstandard]{fontsetup}
}

% Sans-Serif Font Family Loaders
\newcommand{\csbook@loadfont@sf@cmsans}{%
	\setsansfont[%
		BoldFont = NewCMSans10-Bold.otf,
		ItalicFont = NewCMSans10-BookOblique.otf,
		BoldItalicFont = NewCMSans10-BoldOblique.otf,
		SmallCapsFont = NewCMSans10-Book.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{NewCMSans10-Book.otf}
}

\newcommand{\csbook@loadfont@sf@firasans}{%
	\setsansfont[%
		BoldFont = FiraSans-Bold.otf,
		BoldItalicFont = FiraSans-BoldItalic.otf,
		ItalicFont = FiraSans-BookItalic.otf,
		SmallCapsFont = FiraSans-Book.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{FiraSans-Book.otf}
}

\newcommand{\csbook@loadfont@sf@sourcesans}{%
	\setsansfont[%
		BoldFont = SourceSansPro-Bold.otf,
		BoldItalicFont = SourceSansPro-BoldIt.otf,
		ItalicFont = SourceSansPro-RegularIt.otf,
		SmallCapsFont = SourceSansPro-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{SourceSansPro-Regular.otf}
}

\newcommand{\csbook@loadfont@sf@biolinum}{%
	\setsansfont[%
		BoldFont = LibertinusSans-Bold.otf,
		ItalicFont = LibertinusSans-Italic.otf,
		SmallCapsFont = LibertinusSans-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{LibertinusSans-Regular.otf}
}

\newcommand{\csbook@loadfont@sf@ysabeau}{%
	\setsansfont[%
		BoldFont = Ysabeau-Bold.otf,
		BoldItalicFont = Ysabeau-BoldItalic.otf,
		ItalicFont = Ysabeau-Italic.otf,
		SmallCapsFont = Ysabeau-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{Ysabeau-Regular.otf}
}

% Monospace Font Family Loaders
\newcommand{\csbook@loadfont@tt@cmmono}{%
	\setmonofont[%
		BoldFont = NewCMMono10-Bold.otf,
		ItalicFont = NewCMMono10-BookItalic.otf,
		BoldItalicFont = NewCMMono10-BoldOblique.otf,
		SmallCapsFont = NewCMMono10-Book.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{NewCMMono10-Regular.otf}
}

\newcommand{\csbook@loadfont@tt@sourcecode}{%
	\setmonofont[%
		BoldFont = SourceCodePro-Bold.otf,
		ItalicFont = SourceCodePro-RegularIt.otf,
		BoldItalicFont = SourceCodePro-BoldIt.otf,
		SmallCapsFont = SourceCodePro-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{SourceCodePro-Regular.otf}
}

\newcommand{\csbook@loadfont@tt@anonymouspro}{%
	\setmonofont[%
		BoldFont = AnonymousPro-Bold.ttf,
		ItalicFont = AnonymousPro-Italic.ttf,
		BoldItalicFont = AnonymousPro-BoldItalic.ttf,
		SmallCapsFont = AnonymousPro-Regular.ttf,
		SmallCapsFeatures = {RawFeature=+smcp},
		RawFeature = {+calt,+case,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
		Scale=MatchLowercase
	]{AnonymousPro-Regular.ttf}
}

\newcommand{\csbook@loadfont@tt@cascadiamono}{%
	\setmonofont[%
		BoldFont = CascadiaCode-Bold.otf,
		BoldItalicFont = CascadiaCode-BoldItalic.otf,
		ItalicFont = CascadiaCode-Italic.otf,
		SmallCapsFont = CascadiaCode-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{CascadiaCode-Regular.otf}
}

\newcommand{\csbook@loadfont@tt@firamono}{%
	\setmonofont[%
		BoldFont = FiraMono-Bold.otf,
		ItalicFont = FiraMono-Oblique.otf,
		BoldItalicFont = FiraMono-BoldOblique.otf,
		SmallCapsFont = FiraMono-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{FiraMono-Regular.otf}
}

\newcommand{\csbook@loadfont@tt@inconsolata}{%
	\setmonofont[%
		SmallCapsFont = Inconsolatazi4-Regular.otf,
		SmallCapsFeatures = {RawFeature=+smcp},
		Scale=MatchLowercase
	]{Inconsolatazi4-Regular.otf}
}

% Engine-Specific Monospace Fonts
\newcommand{\csbook@loadfont@tt@notosansmono}{%
	\ifXeTeX
		\PackageWarning{csbook}{The 'notosansmono' font is not supported with XeTeX. Falling back to default 'cmmono'.}%
		\csbook@loadfont@tt@cmmono
	\else
		\setmonofont[%
			UprightFont = NotoSansMono-Regular.ttf,
			BoldFont = NotoSansMono-Bold.ttf,
			ItalicFont = NotoSansMono-Regular.ttf,
			BoldItalicFont = NotoSansMono-Bold.ttf,
			SmallCapsFont = NotoSansMono-Regular.ttf,
			SmallCapsFeatures = {RawFeature=+smcp},
			RawFeature = {+calt,+case,+dlig,+kern,+liga,+lnum,+mark,+mkmk,+pnum},
			Scale=MatchLowercase
		]{NotoSansMono}
	\fi
}

% Modular error handling for unknown font choices
\newcommand{\csbook@font@valid@choices}[1]{%
	\ifstrequal{#1}{rm}{cmroman, garamond, libertinus, concrete, oldstandard}{}%
	\ifstrequal{#1}{sf}{cmsans, firasans, sourcesans, biolinum, ysabeau}{}%
	\ifstrequal{#1}{tt}{cmmono, sourcecode, anonymouspro, cascadiamono, firamono, inconsolata, notosansmono}{}%
}

\newcommand{\csbook@font@error@message}[2]{%
	\PackageError{csbook}{Unknown #1 font family: '#2'}%
	{Valid choices for #1 are:\MessageBreak
		\csbook@font@valid@choices{#1}%
	}%
}

% Load a font family by name, with fallback and error reporting
\newcommand{\csbook@load@font@family}[3]{%
	% #1: family type (rm, sf, tt)
	% #2: requested font name
	% #3: fallback font name
	\@ifundefined{csbook@loadfont@#1@#2}{%
		\PackageWarning{csbook}{Unknown #1 font family: '#2'. Falling back to '#3'.}%
		\@ifundefined{csbook@loadfont@#1@#3}{%
			\PackageError{csbook}{Unknown #1 font family: '#2' and fallback '#3'.}{%
				Valid choices for #1 are:\MessageBreak
				\csbook@font@valid@choices{#1}%
			}%
		}{%
			\csname csbook@loadfont@#1@#3\endcsname
		}%
	}{%
		\csname csbook@loadfont@#1@#2\endcsname
	}%
}

% Always sets defaults, then applies user overrides, then loads each font family.
\newcommand{\csbookfonts}[1]{%
	% Set default font families
	\def\csbookfonts@rm{cmroman}%
	\def\csbookfonts@sf{cmsans}%
	\def\csbookfonts@tt{cmmono}%
	% Apply user-specified font choices (if any)
	\setkeys{csbookfonts}{#1}%
	% Load each font family, using fallback if necessary
	\csbook@load@font@family{rm}{\csbookfonts@rm}{cmroman}%
	\csbook@load@font@family{sf}{\csbookfonts@sf}{cmsans}%
	\csbook@load@font@family{tt}{\csbookfonts@tt}{cmmono}%
}

% Set Default Font Style
\ifcsbook@LoadDefaultFont
	\AtEndPreamble{%
		\csbookfonts{rm=cmroman,sf=cmsans,tt=cmmono}%
	}
\fi

% Configure additional math symbol fonts and alphabets
\AtBeginDocument{%
	\let\mathbfcal\relax
	\let\mathbfscr\relax
	\RequirePackage{mathrsfs}
	\RequirePackage[cal=cm,bb=bboldx,scr=esstix]{mathalpha}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hyperlinks and Cross-Referencing System
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadHyperref
	% Core Hyperlink Packages
	\RequirePackage{nameref}                                     % Name-based referencing
	\RequirePackage[%
		bookmarksnumbered=true,                                  % Number PDF bookmarks
		breaklinks=true,                                         % Allow links to break over lines
		citecolor=DodgerBlue3,                                   % Color for citations
		colorlinks=true,                                         % Use colored links
		frenchlinks=true,                                        % Use small caps for links
		linkcolor=RoyalBlue3,                                    % Color for internal links
		pagebackref,                                             % Back-references from bibliography
		pdfencoding=auto,                                        % Automatic encoding detection
		pdfpagelabels=true,                                      % Correct page labels in PDF
		pdfpagelayout=SinglePage,                                % Single page view
		pdfstartview=FitH,                                       % Fit the page to the window
		pdfusetitle,                                             % Use document title as PDF title
		unicode=true,                                            % Support for Unicode
		urlcolor=Turquoise4                                      % Color for URLs
	]{hyperref}

	% Enhanced Bookmarking
	\RequirePackage{bookmark}                                    % Bookmarking and referencing

	% Cross-Document References
	\RequirePackage{xr}                                          % Cross-document references

	% Smart Reference System
	\AtBeginDocument{%
		\RequirePackage[capitalize,nameinlink,noabbrev]{cleveref} % Clever references
		% Sectioning names for cleveref
		\crefname{section}{\textsection}{\textsection\textsection}
		\Crefname{section}{\textsection}{\textsection\textsection}
		\crefname{subsection}{\textsection}{\textsection\textsection}
		\Crefname{subsection}{\textsection}{\textsection\textsection}
		\crefname{subsubsection}{\textsection}{\textsection\textsection}
		\Crefname{subsubsection}{\textsection}{\textsection\textsection}
	}

	% Bibliography Reference Customization
	\renewcommand*{\backref}[1]{}
	\renewcommand*{\backrefalt}[4]{%
		\ifcase #1\or (Cited on p.~#2).%
		\else (Cited on pp.~#2).%
		\fi
	}

	% Enhanced Reference Command
	\newcommand*{\fullref}[1]{\hyperref[{#1}]{\autoref*{#1}~\nameref*{#1}}}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Graphics, Figures, and Tables System
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Core Graphics and Image Handling
\RequirePackage{adjustbox}                                     % Graphic/table boxes: scaling, trimming, framing
\RequirePackage{graphicx}                                      % Image inclusion and scaling

% Float and Layout Management
\RequirePackage{float}                                         % Precise float positioning
\RequirePackage{placeins}                                      % Float placement control (e.g., \FloatBarrier)
\RequirePackage{ragged2e}                                      % Improved text justification

% Caption and Label System
\RequirePackage{caption}                                       % Custom caption formatting
\RequirePackage{subcaption}                                    % Subfigures and subtables with captions

% Table Structure and Formatting
\RequirePackage{array}                                         % Custom column types and alignment
\RequirePackage{booktabs}                                      % High-quality horizontal rules for tables
\RequirePackage{colortbl}                                      % Cell background coloring in tables
\RequirePackage{diagbox}                                       % Diagonal split table headers
\RequirePackage{hhline}                                        % Horizontal lines in tables
\RequirePackage{longtable}                                     % Multi-page tables
\RequirePackage{makecell}                                      % Line breaks and formatting in cells
\RequirePackage{multirow}                                      % Multi-row cells in tables
\RequirePackage{tabularray}                                    % Advanced table types and styling

% Framed and Boxed Content
\RequirePackage{dashbox}                                       % Dashed framed boxes
\RequirePackage{fancybox}                                      % Simple framed boxes
\RequirePackage{framed}                                        % Framed environments (e.g., figures, text)

% Layout and Orientation
\RequirePackage{multicol}                                      % Multiple text columns
\RequirePackage{pdflscape}                                     % Landscape pages in PDF output
\RequirePackage{rotating}                                      % Rotated figures and tables
\RequirePackage{tabularx}                                      % Tables with auto-stretching columns
\RequirePackage{threeparttable}                                % Notes and footnotes in tables
\RequirePackage{verbatim}                                      % Verbatim environment
\RequirePackage{wrapfig}                                       % Text wrapping around figures/tables
\RequirePackage{xhfill}                                        % Horizontal line
\RequirePackage{xtab}                                          % Page-breaking tables (alt to supertabular)
\AtBeginDocument{%
	\captionsetup{%
		font={rm,small},                                       % Roman font
		labelfont={color=black,sc,small},                      % Label in black roman
		labelsep=period,                                       % Label ends with period
		skip=5pt,                                              % Space below caption
		justification=justified                                % Center the caption
	}%
}%
\captionsetup[table]{position=bottom, skip=5pt}                % Table captions below
\captionsetup[figure]{position=bottom, skip=5pt}               % Figure captions below

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lettrine and Stylized Opening Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Example usage in documentation:
% \stylized{A}{lgebra}{red}
% \dropcap{A}{lgebra}
% \customdropcap{A}{lgebra}{3}{blue}
% \dropcaplines{A}{lgebra}{3}
\ifcsbook@LoadLettrine
	\RequirePackage{lettrine} 									% Drop caps and stylized initials
	% Stylized drop cap: first argument = initial, second = rest of word, third = color
	\NewDocumentCommand{\stylized}{m m m}{%
		\lettrine[lines=2, lhang=0.05]{\textcolor{#1}{#2}}{#3}%
	}
	% Drop cap with default color (black)
	\NewDocumentCommand{\dropcap}{m m}{%
		\lettrine[lines=2, lhang=0.05]{#1}{#2}%
	}
	% Drop cap with custom number of lines and color
	\NewDocumentCommand{\customdropcap}{m m m m}{%
		\lettrine[lines=#4, lhang=0.05]{\textcolor{#1}{#2}}{#3}%
	}
	% Drop cap with custom number of lines, default color (black)
	\NewDocumentCommand{\dropcaplines}{m m m}{%
		\lettrine[lines=#3, lhang=0.05]{#1}{#2}%
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Adjust Table of Contents spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage[titles]{tocloft}                               % TOC title formatting

% Define table-of-content spacing
\NewDocumentCommand{\adjusttocformat}{}{%
	\addtolength{\cftchapnumwidth}{5pt}%
	\addtolength{\cftsecnumwidth}{3.5pt}%
	\addtolength{\cftsubsecnumwidth}{3.5pt}%
	\addtolength{\cftsubsubsecnumwidth}{3.5pt}%
	\addtolength{\cftsecindent}{5pt}%
	\addtolength{\cftsubsecindent}{8.5pt}%
	\addtolength{\cftsubsubsecindent}{12pt}%
	% Customize TOC font styles
	\renewcommand{\cftpartfont}{\Large\sffamily}
	\renewcommand{\cftchapfont}{\large\bfseries}
	\renewcommand{\cftsecfont}{\normalsize\scshape}
	\renewcommand{\cftsubsecfont}{\normalsize}
	\renewcommand{\cftsubsubsecfont}{\normalsize}
	% Set numbering and TOC depth
	\setcounter{secnumdepth}{4}
	\setcounter{tocdepth}{2}
}

\ifcsbook@LoadAdjustToC
	\adjusttocformat
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document Structure and Sectioning System
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Core Sectioning Package
\RequirePackage[compact]{titlesec}                               % Header title formatting

% Heading Font Definitions (Hierarchical)
\NewDocumentCommand{\partheadingfont}{}{\normalfont\bfseries\huge}
\NewDocumentCommand{\chapterheadingfont}{}{\normalfont\bfseries\LARGE}
\NewDocumentCommand{\sectionheadingfont}{}{\normalfont\bfseries\Large}
\NewDocumentCommand{\subsectionheadingfont}{}{\normalfont\bfseries\large}
\NewDocumentCommand{\subsubsectionheadingfont}{}{\normalfont\bfseries\normalsize}
\NewDocumentCommand{\paragraphheadingfont}{}{\normalfont\bfseries\normalsize}
\NewDocumentCommand{\subparagraphheadingfont}{}{\normalfont\scshape\normalsize}

\ifcsbook@LoadOldSection
	% Ancient Section, subsection, etc. formatting rules
	\NewDocumentCommand{\setsectionformats}{}{%
		\titleformat{\section}
		{\sectionheadingfont}
		{\textsection\thesection}
		{10pt}
		{}%
		\titleformat{\subsection}
		{\subsectionheadingfont}
		{\textsection\textsection\thesubsection}
		{10pt}
		{}%
		\titleformat{\subsubsection}[runin]
		{\subsubsectionheadingfont}
		{\textsection\textsection\textsection\thesubsubsection}
		{10pt}
		{}%
		\titleformat{\paragraph}[runin]
		{\paragraphheadingfont}
		{\theparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
		\titleformat{\subparagraph}[runin]
		{\subparagraphheadingfont}
		{\thesubparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
	}
\else
	% Section, subsection, etc. formatting rules
	\NewDocumentCommand{\setsectionformats}{}{%
		\titleformat{\section}
		{\sectionheadingfont}
		{\thesection}
		{10pt}
		{\smallskip}[\titlerule\medskip]%
		\titleformat{\subsection}
		{\subsectionheadingfont}
		{\thesubsection}
		{10pt}
		{}%
		\titleformat{\subsubsection}[runin]
		{\subsubsectionheadingfont}
		{\thesubsubsection}
		{10pt}
		{}%
		\titleformat{\paragraph}[runin]
		{\paragraphheadingfont}
		{\theparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\paragraph}{0pt}{\medskipamount}{*1}%
		\titleformat{\subparagraph}[runin]
		{\subparagraphheadingfont}
		{\thesubparagraph}
		{10pt}
		{}[.]%
		\titlespacing*{\subparagraph}{0pt}{\medskipamount}{*1}%
	}
\fi

% Chapter-level title formatting (with embedded size and style)
\NewDocumentCommand{\setchapterformat}{}{%
	\titleformat{\chapter}[display]
	{\chapterheadingfont}
	{\filleft\textnormal{\textsc{\large\chaptertitlename}~\Huge\textsf{\thechapter}}}
	{2ex}
	{\titlerule\vspace{1ex}\filright}
	[\vspace{1ex}\titlerule]%
}

% Part-level title formatting (with embedded size and style)
\NewDocumentCommand{\setpartformat}{}{%
\titleformat{\part}[display]
{\partheadingfont}
{\scshape\partname~{\Huge\thepart}}
{1ex}
{\scshape\titlerule\vspace{1ex}\Huge}
[\vspace{1ex}\titlerule]%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% List Customization
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{enumitem}                                      % Precise control over list environments

% Global list spacing
\setlist{nosep}                                                % Suppress vertical spacing between items

% Enumerate: Custom labels by nesting level
\setlist[enumerate,1]{label=(\arabic*)}                        % Level 1: (1), (2), ...
\setlist[enumerate,2]{label=(\alph*)}                          % Level 2: (a), (b), ...
\setlist[enumerate,3]{label=(\Roman*)}                         % Level 3: (I), (II), ...

% Itemize: Custom symbols by nesting level
\setlist[itemize,1]{label=\textbullet}                		   % Level 1: bullet
\setlist[itemize,2]{label=\textendash}           			   % Level 2: en dash
\setlist[itemize,3]{label=\textasteriskcentered}               % Level 3: open circle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Verbatim and Code Environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadVerbatim
	\RequirePackage{verbatim}   % Basic verbatim environment
	\RequirePackage{fancyvrb}   % Enhanced verbatim features

	% Patch: Only print non-empty lines in verbatim
	\newcommand{\savedverbatim@processline}{}
	\let\savedverbatim@processline=\verbatim@processline
	\renewcommand{\verbatim@processline}{%
		\let\verbatim@processline=\savedverbatim@processline
		\if\relax\the\verbatim@line\relax
		\else
			\the\verbatim@line\par
		\fi
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Modern Boxes 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadNiceBoxs
	\RequirePackage[most]{tcolorbox}                              % Colored and styled boxes
	\RequirePackage[%
		skipabove=1em,                                            % Vertical space above the frame
		skipbelow=1em,                                            % Vertical space below the frame
		ntheorem,                                                 % Compatibility with theorem environments
		framemethod=Tikz                                          % Use TikZ for frame rendering
	]{mdframed}                                                   % Framed environments with theorem support
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TikZ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadTikZ
	\typeout{csbook: Loading TikZ package}
	\RequirePackage{pgfplots}                                     % Function/data plots
	\pgfplotsset{compat=1.18}                                     % PGFPlots compatibility version
	\RequirePackage{tikz}                                         % Core TikZ package
	\RequirePackage{tikz-cd}                                      % Commutative diagrams
	\RequirePackage{tikz-3dplot}                                  % 3D coordinate plotting
	% TikZ libraries for enhanced diagrammatic capability
	\usetikzlibrary{%
		3d,
		arrows,
		arrows.meta,
		automata,
		babel,
		backgrounds,
		bending,
		calc,
		calendar,
		chains,
		circuits.ee.IEC,
		circuits.logic.IEC,
		datavisualization,
		datavisualization.formats.functions,
		decorations,
		decorations.markings,
		decorations.pathmorphing,
		decorations.shapes,
		decorations.text,
		er,
		external,
		fadings,
		fit,
		graphs,
		graphs.standard,
		hobby,
		intersections,
		lindenmayersystems,
		matrix,
		mindmap,
		patterns,
		patterns.meta,
		petri,
		plothandlers,
		plotmarks,
		positioning,
		quantikz2,
		quotes,
		scopes,
		shadows,
		shapes,
		shapes.arrows,
		shapes.callouts,
		shapes.geometric,
		shapes.misc,
		shapes.multipart,
		shapes.symbols,
		spy,
		svg.path,
		through,
		tikzmark,
		trees
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendices
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadAppendix
	\typeout{csbook: Loading appendix package}
	\RequirePackage[page, title, header, titletoc, toc]{appendix} % For handling appendices
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Theorems
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadTheorem
	\typeout{csbook: Loading theorem package}
	\IfFileExists{csthm.sty}{%
		\RequirePackage[oldschool]{csthm}
		\typeout{csbook: Loaded csthm package with oldschool option}
	}{%
		\PackageWarning{csbook}{Package `csthm` not found. Theorem formatting will use defaults.}
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Epigraphs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadEpigraph
	\RequirePackage{epigraph} % Load epigraph package for introductory quotations

	% Epigraph appearance configuration
	\setlength{\epigraphrule}{0.5pt}         	% Thickness of the epigraph rule
	\setlength{\epigraphwidth}{0.65\textwidth} 	% Width of the epigraph block
	\renewcommand{\textflush}{flushright}      	% Align epigraph text to the right
	\renewcommand{\epigraphsize}{\small}       	% Set epigraph font size

	% Enhanced epigraph command using xparse
	\let\oldepigraph\epigraph
	\RenewDocumentCommand{\epigraph}{mm}{%
		\oldepigraph{\textsf{#1}}{\smallskip\textsc{#2}}%
	}

	% Simple dedication environment
	\NewDocumentEnvironment{dedication}{O{}}{%
		\cleardoublepage
		\thispagestyle{empty}
		\vspace*{\fill}
		\begin{flushright}
			\begin{itshape}
				}{%
			\end{itshape}
			\IfNoValueF{#1}{\par\medskip\textsf{#1}}
		\end{flushright}
		\vspace*{\fill}
		\cleardoublepage
	}

	% Generate Dedications: Produces a page of dedications with multiple epigraphs
	\NewDocumentCommand{\generateDedications}{m}{%
		\cleardoublepage
		\thispagestyle{empty}
		\begin{center}
			\vspace*{\fill}
			\large
			\begin{minipage}{0.9\textwidth}
				#1
			\end{minipage}
			\vspace*{\fill}
		\end{center}
		\clearpage
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Index Support
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadIndices
	\RequirePackage[makeindex]{imakeidx}
	\IfFileExists{csindex.ist}{%
		\typeout{csbook: Using custom index style file 'csindex.ist' for the index.}
		\makeindex[intoc, title={Index}, columns=2, options={-s csindex.ist}]
	}{%
		\typeout{csbook: No custom index style file 'csindex.ist' found. Using default index style.}
		\makeindex[intoc, title={Index}, columns=3]
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Glossaries and Acronyms
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadGlossaries
	\RequirePackage[%
		automake,           	% Auto-generate glossary files
		acronym,            	% Enable acronyms
		symbols,            	% Enable symbols list
		nonumberlist,       	% No numbering for entries
		nogroupskip,        	% No extra space between groups
		indexonlyfirst,     	% Only first occurrence indexed
		stylemods=longextra,	% Use long extra style
		nopostdot,          	% No period after entries
		toc                 	% Add to Table of Contents
	]{glossaries-extra}
	\makeglossaries
	\setabbreviationstyle[acronym]{long-short}
	\renewcommand*{\glsnamefont}[1]{\sffamily\small#1.}
	\renewcommand*{\glossarypreamble}{\begingroup\small}
	\renewcommand*{\glossarypostamble}{\endgroup}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Page Style Customizations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Save originals
\let\csbook@orig@frontmatter\frontmatter
\let\csbook@orig@mainmatter\mainmatter
\let\csbook@orig@backmatter\backmatter
\let\csbook@orig@tableofcontents\tableofcontents

% Redefine frontmatter: plain page style
\RenewDocumentCommand{\frontmatter}{}{%
	\csbook@orig@frontmatter%
	\pagestyle{plain}%
}

% Redefine mainmatter: fancy page style, chapters on right
\RenewDocumentCommand{\mainmatter}{}{%
	\csbook@orig@mainmatter%
	\@openrighttrue%
	\pagestyle{fancy}%
}

% Redefine backmatter: plain page style, sections on right, bookmarks at root
\RenewDocumentCommand{\backmatter}{}{%
	\csbook@orig@backmatter%
	\@openrighttrue%
	\bookmarksetup{startatroot}%
	\pagestyle{plain}%
}

% Redefine tableofcontents: page break after, fancy style
\RenewDocumentCommand{\tableofcontents}{}{%
	\csbook@orig@tableofcontents%
	\cleardoublepage%
	\pagestyle{fancy}%
}

% Header and section formatting setup
\AtBeginDocument{%
	\setpartformat
	\setchapterformat
	\setsectionformats
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Enhanced Environments and Utility Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifcsbook@LoadUsefulCommands
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Enhanced List Environments (requires enumitem package)
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\@ifpackageloaded{enumitem}{%
		% Points list: itemize with en-dash
		\newlist{points}{itemize}{1}
		\setlist[points]{%
			label={--},
			leftmargin=1em,
			itemsep=1pt,
			align=left,
			before=\smallskip,
			after=\smallskip
		}
		% Codelist: enumerate as [1], [2], ...
		\newlist{codelist}{enumerate}{1}
		\setlist[codelist,1]{%
			label=\textcolor{gray}{\texttt{[\arabic*]}},
			leftmargin=1em,
			itemsep=1pt,
			align=left,
			before=\smallskip,
			after=\smallskip
		}
		% Checkbox list: itemize with empty box
		\newlist{checkbox}{itemize}{1}
		\setlist[checkbox]{%
			label={--},
			leftmargin=1em,
			align=left
		}
		% Checked and unchecked items for checkbox list
		\newcommand{\taskitem}{\item[$\square$]}
		\newcommand{\checkeditem}{\item[$\color{SpringGreen3}\boxtimes$]}
		\newcommand{\uncheckeditem}{\item[$\color{IndianRed1}\vectimes$]}
		% Definition list: description with bold labels
		\newlist{deflist}{description}{1}
		\setlist[deflist]{%
			labelwidth=0.35\textwidth,
			labelsep=1em,
			leftmargin=0.35\textwidth,
			font=\normalfont\bfseries,
			style=nextline,
			itemsep=5pt
		}
		% Chapter notes environment
		\NewDocumentEnvironment{chapternotes}{}{%
			\section*{Chapter Notes and History}%
			\addcontentsline{toc}{section}{\protect{\textsc{Chapter Notes and History}}}%
		}{}
		% Problem set environment (auto-labels, two levels)
		\NewDocumentEnvironment{problemset}{}{%
			\section*{Problem Set}%
			\addcontentsline{toc}{section}{\protect{\textsc{Problem Set}}}%
			\setlist[enumerate,1]{label={$\textrm{(\thechapter.\arabic*)}~$}, left=0pt}%
			\setlist[enumerate,2]{label=(\arabic*), left=1em}%
			\begin{enumerate}%
				}{%
			\end{enumerate}%
		}
		% Choices environment: two-column, (a), (b), ...
		\NewDocumentEnvironment{choices}{}{%
			\begin{multicols}{2}%
				\begin{enumerate}[label={$\texttt{\small(\alph*)}$}]%
					}{%
				\end{enumerate}%
			\end{multicols}%
		}
		% Hard problem item: star and colored label
		\NewDocumentCommand{\hardproblem}{}{%
			\item[\textrm{(\ensuremath{\color{Brown1}\star}\,\thechapter.\number\numexpr\value{enumi}+1\relax)}]%
			\stepcounter{enumi}%
		}
	}{}

	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Text Formatting and Highlighting Commands
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	% Highlight color system (default: RoyalBlue)
	\newcommand{\highlightcolor}{RoyalBlue}
	\newcommand{\sethighlightcolor}[1]{\renewcommand{\highlightcolor}{#1}}
	% Highlighted math and text
	\newcommand{\emphmath}[1]{\textcolor{\highlightcolor}{\mathrm{#1}}}
	\newcommand{\emphtext}[1]{\textcolor{\highlightcolor}{#1}}
	\newcommand{\textem}[1]{\textcolor{\highlightcolor}{#1}}
	% Bold italic text
	\newcommand{\textbi}[1]{\textbf{\textit{#1}}}
	% Code font
	\newcommand{\code}[1]{\texttt{#1}}
	% Math small caps and bold italic
	\newcommand{\mathsc}[1]{\textnormal{\textsc{#1}}}
	\newcommand{\mathbi}[1]{\textnormal{\textbf{\textit{#1}}}}
	% Inline math shortcut
	\newcommand{\inmath}[1]{\ensuremath{#1}}
	% Hyphen in math mode
	\mathchardef\mathhyphen="2D
	% Quotation marks
	\newcommand{\putInQuotes}[1]{``#1''}
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Missing Content Tracking System
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	% Missing content counter and tracking
	\newcounter{missingctr}
	\newcommand{\missinglist}{}  % Initialize as empty list
	% Mark missing content and collect for report
	\newcommand{\missing}[1]{%
		\refstepcounter{missingctr}%
		\label{missing:\themissingctr}%
		\gappto\missinglist{%
			\noindent\textcolor{Brown4}{%
				\ensuremath{\star}~\themissingctr~(\textsf{Missing at p.~\pageref{missing:\themissingctr}}):~#1%
			}\par\medskip
		}%
		\textcolor{Brown4}{#1}%
	}
	% Print all missing items with page references
	\newcommand{\printmissing}{%
		\section*{Missing Content Report}%
		\missinglist
	}
	% Mark missing citation (for future expansion)
	% Debug: #1 was used but not defined; remove #1 and just print <Citation Missing>
	\newcommand{\missingcitation}{%
		\refstepcounter{missingctr}%
		\label{missing:\themissingctr}%
		\gappto\missinglist{%
			\noindent\textcolor{Brown4}{%
				\ensuremath{\star}~\themissingctr~(\textsf{Missing at p.~\pageref{missing:\themissingctr}}):~\texttt{<Citation Missing>}%
			}\par\medskip
		}%
		\textcolor{Brown4}{\texttt{<Citation Missing>}}%
	}
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Enhanced Boxed Environments (mdframed-based)
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% bashbox environment: code in a dashed box using adjustbox for width
	\NewDocumentEnvironment{bashbox}{}{%
		\begin{adjustbox}{minipage=\textwidth,precode=\dbox}
			\centering\medskip%
			\begin{minipage}{0.975\textwidth}
				\noindent%
				}{%
			\end{minipage}
			\medskip%
		\end{adjustbox}
	}
	\@ifpackageloaded{mdframed}{%
		% Protocol box: points list in a box, optional title
		\NewDocumentEnvironment{protocolbox}{o}{%
			\begin{mdframed}[
					font=\small,
					roundcorner=1.5pt,
					linewidth=0.5pt,
					skipabove=0.5\baselineskip,
					skipbelow=0.1\baselineskip,
					leftmargin=0pt,
					rightmargin=0pt,
					innerleftmargin=5pt,
					innerrightmargin=5pt,
					innertopmargin=5pt,
					innerbottommargin=5pt,
					backgroundcolor=white,
					linecolor=black
				]%
				\IfNoValueF{#1}{%
					\noindent\textnormal{\small\textbf{#1}}\par\smallskip
					\noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
				}%
				\begin{points}%
					}{%
				\end{points}
			\end{mdframed}%
		}
		% Codelist box: codelist in a box, optional title
		\NewDocumentEnvironment{codelistbox}{o}{%
			\begin{mdframed}[
					font=\small,
					roundcorner=1.5pt,
					linewidth=0.5pt,
					skipabove=0.5\baselineskip,
					skipbelow=0.1\baselineskip,
					leftmargin=0pt,
					rightmargin=0pt,
					innerleftmargin=5pt,
					innerrightmargin=5pt,
					innertopmargin=5pt,
					innerbottommargin=5pt,
					backgroundcolor=white,
					linecolor=black
				]%
				\IfNoValueF{#1}{%
					\noindent\textnormal{\small\textbf{#1}}\par\smallskip
					\noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
				}%
				\begin{codelist}%
					}{%
				\end{codelist}
			\end{mdframed}%
		}
		% Simple box: plain box, optional title
		\NewDocumentEnvironment{simplebox}{o}{%
			\begin{mdframed}[
					font=\small,
					roundcorner=1.5pt,
					linewidth=0.5pt,
					skipabove=0.5\baselineskip,
					skipbelow=0.1\baselineskip,
					leftmargin=0pt,
					rightmargin=0pt,
					innerleftmargin=5pt,
					innerrightmargin=5pt,
					innertopmargin=5pt,
					innerbottommargin=5pt,
					backgroundcolor=white,
					linecolor=black
				]%
				\IfNoValueF{#1}{%
					\noindent\textnormal{\small\textbf{#1}}\par\smallskip
					\noindent\hrule height 0.4pt\relax\vspace{0.5\baselineskip}%
				}%
				\noindent%
				}{%
			\end{mdframed}%
		}
		% Learned box: "What Have We Learned?" title
		\NewDocumentEnvironment{learnedbox}{}{%
			\begin{mdframed}[frametitle={\normalfont\sffamily\large What Have We Learned?\medskip\hrule}]
				\noindent%
				}{%
			\end{mdframed}
		}
		% Case study box: simple black frame, optional header with dashed line
		\NewDocumentEnvironment{casestudy}{o}{%
			\begin{mdframed}[linewidth=0.5pt,roundcorner=1pt,linecolor=black!50,backgroundcolor=black!1]%
				\IfNoValueF{#1}{%
					\noindent\textnormal{\textbf{#1}\\}
					\noindent\makebox[\linewidth]{\color{black!50}\dotfill}\vspace{0.15\baselineskip}%
				}%
				\noindent%
				}{%
			\end{mdframed}%
		}
	}{}

	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Enhanced Boxed Environments (tcolorbox-based)
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\@ifpackageloaded{tcolorbox}{%
		% Simple Wire box: simple tcolorbox, etc.
		\newtcolorbox{wirebox}{%
			colframe=black,
			colback=white,
			sharp corners,
			boxrule=0.5pt,
			coltitle=black,
			colbacktitle=white,
			boxsep=5pt,
			top=0pt,
			bottom=0pt,
			left=5pt,
			right=5pt
		}
		% Modern, clean definition for paired numbered/unnumbered color boxes
		\NewDocumentCommand{\newcolorboxes}{mmm}{%
			% Create a counter for the numbered environment
			\newcounter{#1ctr}
			% Numbered environment
			\newtcolorbox[#2]{#1}{O{}}{%
				enhanced,
				breakable,
				colback=#3!5,
				colframe=#3!80!black,
				arc=1pt,
				boxrule=0.5pt,
				fonttitle=\color{black}\sffamily,
				before upper={\parindent0pt},
				before lower={\parindent0pt},
				fontupper=\color{black}\normalfont,
				fontlower=\color{black}\normalfont,
				right=15pt, top=15pt, bottom=15pt,
				attach boxed title to top left={yshift=-5pt,xshift=10pt},
				boxed title style={
						colback=#3!5,
						colframe=#3!50!black,
						arc=1pt,
						boxrule=0.5pt
					},
				title={%
						\refstepcounter{#1ctr}#2~\thesection.\arabic{#1ctr}%
						\IfValueT{##1}{: ##1}%
					}
			}
			% Unnumbered environment
			\newtcolorbox[#2]{#1*}{O{}}{%
				enhanced,
				breakable,
				colback=#3!5,
				colframe=#3!80!black,
				arc=1pt,
				boxrule=0.5pt,
				fonttitle=\color{black}\sffamily,
				before upper={\parindent0pt},
				before lower={\parindent0pt},
				fontupper=\color{black}\normalfont,
				fontlower=\color{black}\normalfont,
				right=15pt, top=15pt, bottom=15pt,
				attach boxed title to top left={yshift=-5pt,xshift=10pt},
				boxed title style={
						colback=#3!5,
						colframe=#3!50!black,
						arc=1pt,
						boxrule=0.5pt
					},
				title={%
						#2%
						\IfValueT{##1}{: ##1}%
					}
			}
		}
	}{}

	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% Document Structure Environments
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	% Exercises Environment
	\NewDocumentEnvironment{exercises}{}{%
		\vfill\cleardoublepage%
		\begin{small}%
			\section*{Exercises}%
			\addcontentsline{toc}{section}{\textsc{Exercises}}%
			}{%
		\end{small}%
	}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document Structure and Comment System
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Comment macro system: \newcomment{name}{color}{command}
\NewDocumentCommand{\newcomment}{mmm}{%
	\expandafter\NewDocumentCommand\csname#3\endcsname{m}{%
		\noindent\textcolor{#2}{\sffamily##1 -- $\mathsf{#1}$}%
	}%
}

% Acknowledgment environment
\NewDocumentEnvironment{acknowledgment}{o}{%
	\IfNoValueTF{#1}{\chapter*{Acknowledgment.}}{\chapter*{#1}}%
}{}
% Abstract environment
\@ifclassloaded{report}{%
	\RenewDocumentEnvironment{abstract}{}{%
		\begin{quotation}
			\begin{small}
				{\noindent\paragraphheadingfont{Abstract.\ }}%
				\addcontentsline{toc}{section}{\protect{\textsc{Abstract}}}%
				}{%
			\end{small}
		\end{quotation}
	}%
}{%
	\NewDocumentEnvironment{abstract}{}{%
		\begin{quotation}
			\begin{small}
				{\noindent\paragraphheadingfont{Abstract.\ }}%
				\addcontentsline{toc}{section}{\protect{\textsc{Abstract}}}%
				}{%
			\end{small}
		\end{quotation}
	}%
}%

% Table of Contents command
\NewDocumentCommand{\toc}{}{%
	\vfill
	\clearpage
	\begin{spacing}{1.00}
		\tableofcontents
	\end{spacing}
	\vfill
	\clearpage
}

% Bibliography command
\NewDocumentCommand{\printbib}{O{alphaurl} m}{%
	\vfill
	\clearpage
	\begin{spacing}{1.00}
		\bibliographystyle{#1}
		\bibliography{#2}
	\end{spacing}
	\vfill
	\clearpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title Page Customization System
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Title and Author Management Package
\RequirePackage{hep-title}

% Title Formatting
\titlefont{\normalfont\LARGE\bfseries}                       % Title
\subtitlefont{\normalfont\large\bfseries}                    % Subtitle
\authorfont{\normalfont\normalsize}                          % Author
\affiliationfont{\normalfont\small\scshape}                  % Affiliation
\datefont{\normalfont\small\scshape}                         % Date
\preprintfont{\normalfont\small\ttfamily\scshape}            % Preprint line

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Advanced Title Page Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Modular Title Page Command
\NewDocumentCommand{\printtitlepage}{O{} O{\huge\sffamily} O{\large\sffamily}}{%
	\cleardoublepage
	\begingroup
	\thispagestyle{empty}
	\vspace*{\fill}
	\begin{flushright}
		\hrule width \textwidth height 1pt\par
		\vspace{2em}
		{#2\@title}\\[1em]
		{#3\hep@sub@title}\par
		\vspace{2em}
		\hrule width \textwidth height 1pt
		\vspace*{\fill}
		\begin{normalsize}
			#1
		\end{normalsize}
	\end{flushright}
	\endgroup
	\clearpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Paragraph formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Flag for punctuation detection
\newif\ifcsbook@haspunctuation

% Check whether the second argument is empty (used for punctuation detection)
\def\csbook@checkpunctuation#1{%
	\ifx\csbook@checkpunctuation#1\csbook@checkpunctuation
	\else
		\csbook@haspunctuationtrue
	\fi
}

% Specific punctuation testers for '.', '?', '!', ':'
\def\csbook@checkdot#1.\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}
\def\csbook@checkquestion#1?\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}
\def\csbook@checkexclam#1!\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}
\def\csbook@checkcolon#1:\csbook@delim#2\csbook@stop{\csbook@checkpunctuation{#2}}

% Main interface: Append period unless line ends with '.', '?', '!', or ':'
\def\csbook@appendpunctuationifneeded#1{%
	\csbook@haspunctuationfalse
	\csbook@checkdot#1\csbook@delim.\csbook@delim\csbook@stop
	\csbook@checkquestion#1\csbook@delim?\csbook@delim\csbook@stop
	\csbook@checkexclam#1\csbook@delim!\csbook@delim\csbook@stop
	\csbook@checkcolon#1\csbook@delim:\csbook@delim\csbook@stop
	#1\ifcsbook@haspunctuation \else.\fi%
}

% Skip spaces and implicit paragraphs (blank lines)
\def\csbook@ignorewhitespaceandimplicitpars{%
	\begingroup
	\catcode13=10 %
	\@ifnextchar\relax
	{\endgroup}
	{\endgroup}%
}

% Skip spaces, implicit paragraphs, and explicit \par commands
\def\csbook@ignoreallpars{%
	\begingroup
	\catcode13=10 %
	\@ifnextchar\par
	{\endgroup\expandafter\csbook@ignoreallpars\@gobble}
	{\endgroup}%
}

% Section-style paragraph header with automatic punctuation and spacing
\NewDocumentCommand{\csbook@paragraphhead}{m}{%
	\smallskip
	\noindent
	\textbf{\boldmath\ignorespaces\csbook@appendpunctuationifneeded{#1}}%
	\hskip 0.9em plus 0.3em minus 0.3em
	\csbook@ignorewhitespaceandimplicitpars
}

\NewDocumentCommand{\parhead}{m}{\csbook@paragraphhead{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Nested bar environment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\long\def\csbook@customfbox#1#2#3#4#5#6#7#8#9{%
	\leavevmode
	\begingroup
	\setbox\@tempboxa\hbox{%
		\color@begingroup
		\kern\fboxsep{#9}\kern\fboxsep
		\color@endgroup}%
	\hbox{%
		\begingroup
		\@tempdima#4\relax
		\advance\@tempdima\fboxsep
		\advance\@tempdima\dp\@tempboxa
		\expandafter\endgroup
		\expandafter\lower\the\@tempdima\hbox{%
			\vbox{%
				\hrule \@height#3 \@width#7
				#1%
				\hbox{%
					\vrule \@width#5
					\hspace{#8}%
					\vbox{%
						\vskip\fboxsep
						\copy\@tempboxa
						\vskip\fboxsep}%
					\vrule \@width#6}%
				#2%
				\hrule \@height#4\@width#7}%
		}%
	}%
	\endgroup
}

% Parameters for bar dimensions and spacing
\newcommand{\csbook@nestedbar@topbotrulelength}{1em}
\newcommand{\csbook@nestedbar@indent}{0.5em}

% FrameCommand helper that sets up side rule and spacing
\def\csbook@openframebox#1#2{%
	\fboxsep=\FrameSep
	\csbook@customfbox
	{}{}% no content above or below
	{#1}{#2}% top and bottom rule thicknesses
	\FrameRule\z@% left and right rule thickness
	\csbook@nestedbar@topbotrulelength% horizontal rule length
	\csbook@nestedbar@indent% indent from vertical rule
}

% Definition of the nestedbar environment
\newenvironment{nestedbar}[1][\hsize]{%
	\@ifundefined{OuterFrameSep}{\@latex@error{To use nestedbar, update framed.sty to a recent version.}\@ehd}{}%
	\def\FrameCommand{\csbook@openframebox\FrameRule\FrameRule}%
	\def\FirstFrameCommand{\csbook@openframebox\FrameRule\z@}%
	\def\MidFrameCommand{\csbook@openframebox\z@\z@}%
	\def\LastFrameCommand{\csbook@openframebox\z@\FrameRule}%
	\OuterFrameSep=1ex
	\FrameSep=0pt
	\MakeFramed{\hsize#1\advance\hsize-\width\FrameRestore}%
	\medskip\noindent%
}{%
	\medskip%
	\endMakeFramed
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Copyright and License Page Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Usage:
%   \makecopyrightpage[<author>][<license>]
%     <author>:   Author name (default: \@author)
%     <license>:  byncsa (default), by, or allrights
%
%   \begin{copyrightpage}[<author>][<license>][<license-link>]
%     ... (optional additional content) ...
%   \end{copyrightpage}
%     <author>:       Author name (default: \@author)
%     <license>:      byncsa, by, allrights, custom (default: byncsa)
%     <license-link>: Custom link for license (optional)
%
% License text macros:
%   \ccbyncsalicense          % CC BY-NC-SA 4.0
%   \ccbylicense              % CC BY 4.0
%   \allrightsreservedlicense % All Rights Reserved

\NewDocumentCommand{\ccbyncsalicense}{}{
	\begin{small}
		\textbf{CC BY-NC-SA 4.0 License}
		\par\bigskip\noindent
		This book is licensed under a Creative Commons Attribution-NonCommercial-
		ShareAlike 4.0 International License. You are permitted to copy and
		redistribute the material in any medium or format, provided that you give
		appropriate credit, provide a link to the license, and indicate if changes
		were made. You may not use the material for commercial purposes. If you
		remix, transform, or build upon the material, you must distribute your
		contributions under the same license as the original. No additional
		restrictions may be applied that would legally restrict others from doing
		anything the license permits.
		\par\smallskip\noindent
		Please note that you do not have to comply with the license for elements of
		the material that are in the public domain or where your use is permitted by
		an applicable exception or limitation. No warranties are given. The license
		may not grant you all the permissions necessary for your intended use; for
		example, other rights such as publicity, privacy, or moral rights may limit
		how you use the material.
		\par\smallskip\noindent
		For the full license text, visit:\newline
		\url{https://creativecommons.org/licenses/by-nc-sa/4.0/}
		\par\bigskip\noindent
		\textbf{AI Training Restriction:} The contents of this book may not be
		used, in whole or in part, for training artificial intelligence systems or
		models, including but not limited to large language models, without
		explicit written permission from the copyright holder.
	\end{small}
}

\NewDocumentCommand{\ccbylicense}{}{
	\begin{small}
		\textbf{CC BY 4.0 License}
		\par\bigskip\noindent
		This book is licensed under a Creative Commons Attribution 4.0 International
		License. You are free to share (copy and redistribute the material in any
		medium or format) and adapt (remix, transform, and build upon the material)
		for any purpose, even commercially, provided that you give appropriate
		credit, provide a link to the license, and indicate if changes were made.
		\par\smallskip\noindent
		No additional restrictions may be applied that would legally restrict others
		from doing anything the license permits.
		\par\smallskip\noindent
		For the full license text, visit:\newline
		\url{https://creativecommons.org/licenses/by/4.0/}
		\par\bigskip\noindent
		\textbf{AI Training Restriction:} The contents of this book may not be
		used, in whole or in part, for training artificial intelligence systems or
		models, including but not limited to large language models, without
		explicit written permission from the copyright holder.
	\end{small}
}

\NewDocumentCommand{\allrightsreservedlicense}{}{
	\begin{small}
		\textbf{All Rights Reserved~\textcopyright}
		\par\bigskip\noindent
		All rights reserved. No part of this book may be reproduced, distributed,
		or transmitted in any form or by any means, including photocopying,
		recording, or other electronic or mechanical methods, without the prior
		written permission of the copyright holder, except in the case of brief
		quotations embodied in critical reviews and certain other noncommercial
		uses permitted by copyright law.
		\par\smallskip\noindent
		\textbf{AI Training Restriction:} The contents of this book may not be
		used, in whole or in part, for training artificial intelligence systems or
		models, including but not limited to large language models, without
		explicit written permission from the copyright holder.
	\end{small}
}

\NewDocumentCommand{\makecopyrightpage}{O{\@author} O{byncsa}}{%
	\@ifundefined{ccbyncsalicense}{%
		\PackageWarning{csbook}
		{Command \string\ccbyncsalicense\space is undefined. Please define it for byncsa license pages.}%
	}{}%
	\@ifundefined{ccbylicense}{%
		\PackageWarning{csbook}
		{Command \string\ccbylicense\space is undefined. Please define it for by license pages.}%
	}{}%
	\@ifundefined{allrightsreservedlicense}{%
		\PackageWarning{csbook}
		{Command \string\allrightsreservedlicense\space is undefined. Please define it for allrights license pages.}%
	}{}%
	\cleardoublepage
	\pagestyle{empty}
	\begin{flushleft}
		{\noindent\normalfont\normalsize\textbf{\@title}}\par\medskip
		{\noindent\normalfont\normalsize By #1}\par\smallskip
		{\noindent\normalfont\textcopyright~\@date.}\par\smallskip
		\IfStrEqCase{#2}{
			{byncsa}{\noindent\small\url{https://creativecommons.org/licenses/by-nc-sa/4.0/}\par}
				{by}{\noindent\small\url{https://creativecommons.org/licenses/by/4.0/}\par}
				{allrights}{}
		}[\noindent]
	\end{flushleft}
	\vspace*{\fill}
	\IfStrEqCase{#2}{
		{byncsa}{\ifcsname ccbyncsalicense\endcsname\ccbyncsalicense\else\fi}
			{by}{\ifcsname ccbylicense\endcsname\ccbylicense\else\fi}
			{allrights}{\ifcsname allrightsreservedlicense\endcsname\allrightsreservedlicense\else\fi}
	}[\ifcsname ccbyncsalicense\endcsname\ccbyncsalicense\else\fi]
	\cleardoublepage
}

\NewDocumentEnvironment{copyrightpage}{O{\@author} O{byncsa} O{}}{%
	\cleardoublepage
	\pagestyle{empty}
	\begin{flushleft}
		{\noindent\normalfont\normalsize\textbf{\@title}}\par\medskip
		{\noindent\normalfont\normalsize By #1}\par\smallskip
		{\noindent\normalfont\textcopyright~\@date.}\par\smallskip
		\csbook@copyright@printlink{#2}{#3}
	\end{flushleft}
	\vspace*{\fill}
	\csbook@copyright@printlicense{#2}{#3}
}{%
	\cleardoublepage
}

\NewDocumentCommand{\csbook@copyright@printlink}{m m}{%
	\IfStrEq{#1}{byncsa}{%
		\IfBlank{#2}
		{\noindent\small\url{https://creativecommons.org/licenses/by-nc-sa/4.0/}\par}
		{\noindent\small\url{#2}\par}%
	}{%
		\IfStrEq{#1}{by}{%
			\IfBlank{#2}
			{\noindent\small\url{https://creativecommons.org/licenses/by/4.0/}\par}
			{\noindent\small\url{#2}\par}%
		}{%
			\IfStrEq{#1}{allrights}{%
				\IfBlankF{#2}{\noindent\small\url{#2}\par}%
			}{%
				\IfStrEq{#1}{custom}{%
					\IfBlankF{#2}{\noindent\small\url{#2}\par}%
				}{%
					\IfBlankF{#2}{\noindent\small\url{#2}\par}%
				}
			}
		}
	}%
}

\NewDocumentCommand{\csbook@copyright@printlicense}{m m}{%
	\IfStrEq{#1}{byncsa}{%
		\ifcsname ccbyncsalicense\endcsname\ccbyncsalicense\fi
	}{%
		\IfStrEq{#1}{by}{%
			\ifcsname ccbylicense\endcsname\ccbylicense\fi
		}{%
			\IfStrEq{#1}{allrights}{%
				\ifcsname allrightsreservedlicense\endcsname\allrightsreservedlicense\fi
			}{%
				\IfStrEq{#1}{custom}{%
				}{}%
			}
		}
	}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% End of package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\endinput
